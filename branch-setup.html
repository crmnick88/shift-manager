<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×”×§××ª ××—×œ×§×•×ª ×•×¢×•×‘×“×™×</title>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- Config -->
  <script>
    window.firebaseConfig = window.firebaseConfig || {
      apiKey: "AIzaSyD-uaQ2aO87kGxbcc-m8_9fzJ3uhPv2zvk",
      authDomain: "shift-manager-c026e.firebaseapp.com",
      databaseURL: "https://shift-manager-c026e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "shift-manager-c026e",
      storageBucket: "shift-manager-c026e.firebasestorage.app",
      messagingSenderId: "1091605398341",
      appId: "1:1091605398341:web:cb6c14e7d832c3e8df342c"
    };
  </script>
  <script src="./js/firebase.js"></script>

  <style>
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Arial,sans-serif;background:#f2f4f8;margin:0;padding:0}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:16px;padding:16px;border:1px solid #e7e7e7;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:14px}
    h1{margin:0 0 10px 0;color:#34495e}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid #d9d9d9;border-radius:10px;font-size:15px}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-size:15px;font-weight:700}
    .btn{background:#4b6cb7;color:#fff}
    .btn2{background:#6c757d;color:#fff}
    .btnDanger{background:#dc3545;color:#fff}
    .muted{opacity:.75}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#f6f7fb;border:1px solid #e7e7e7;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0}
    .small{font-size:12px}
    .list{margin-top:10px}
    .hr{height:1px;background:#eee;margin:14px 0}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;display:none}
    .ok{background:#e8fff0;border:1px solid #b6f2c6;color:#1c7c3a}
    .err{background:#ffecec;border:1px solid #ffb9b9;color:#b30000}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1>ğŸ—ï¸ ×”×§××ª ××—×œ×§×•×ª ×•×¢×•×‘×“×™×</h1>
        <div>
          <button class="btn2" onclick="backToMain()">â¬…ï¸ ×—×–×¨×”</button>
        </div>
      </div>
      <div class="muted small">
        ××¡×š ×–×” ××™×•×¢×“ ×œ×¡× ×™×¤×™× ×—×“×©×™× ×‘×œ×‘×“. ×”×•× ×›×•×ª×‘ ×œ× ×ª×™×‘×™×:
        <code>branches/&lt;branchKey&gt;/org/departments</code>,
        <code>branches/&lt;branchKey&gt;/employees</code>,
        <code>branches/&lt;branchKey&gt;/displayNames</code>
      </div>
      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;">1) ×™×¦×™×¨×ª ××—×œ×§×”</h2>
      <div class="row">
        <div class="col">
          <label>×©× ××—×œ×§×”</label>
          <input id="deptName" type="text" placeholder='×œ×“×•×’××”: "××—×¡×Ÿ" / "×§×• ×œ×‘×Ÿ"' />
        </div>
        <div class="col" style="display:flex;align-items:end;">
          <button class="btn" style="width:100%;" onclick="createDepartment()">â• ×¦×•×¨ ××—×œ×§×”</button>
        </div>
      </div>
      <div id="deptList" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;">2) ×”×•×¡×¤×ª ×¢×•×‘×“ ×•×©×™×•×š ×œ××—×œ×§×”</h2>
      <div class="row">
        <div class="col">
          <label>××—×œ×§×”</label>
          <select id="deptSelect"></select>
        </div>
        <div class="col">
          <label>×©× ×¢×•×‘×“ (××–×”×” / username)</label>
          <input id="empKey" type="text" placeholder='×œ×“×•×’××”: "OR" / "××•×¨"' />
          <div class="muted small">×–×” ×”××¤×ª×— ×©× ×©××¨ ×‘×“××˜×”. ××•××œ×¥ ×‘×œ×™ ×¨×•×•×—×™×.</div>
        </div>
        <div class="col">
          <label>×©× ×ª×¦×•×’×”</label>
          <input id="empDisplay" type="text" placeholder='×œ×“×•×’××”: "××•×¨ ×›×”×Ÿ"' />
        </div>
      </div>
      <div class="row">
        <div class="col" style="display:flex;gap:10px;align-items:end;">
          <button class="btn" style="flex:1" onclick="addEmployee()">â• ×”×•×¡×£ ×¢×•×‘×“ ×œ××—×œ×§×”</button>
          <button class="btn2" style="flex:1" onclick="reloadFromDB()">ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
        </div>
      </div>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px 0;">×ª×¦×•×’×” ××§×“×™××”</h3>
      <div id="preview" class="list"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;">3) ×¡×™×•×</h2>
      <div class="muted">×‘×¡×™×•×, ×—×–×•×¨ ×œ××¡×š ×”×¨××©×™ ×•×”×ª×—×‘×¨ ×›×× ×”×œ. ×”× ×ª×•× ×™× ×™×™×˜×¢× ×• ××•×˜×•××˜×™×ª ××”×¡× ×™×£.</div>
      <div style="margin-top:10px;">
        <button class="btn" onclick="finishSetup()">âœ… ×¡×™×™××ª×™ â€“ ×—×–×•×¨ ×œ×”×ª×—×‘×¨×•×ª ×× ×”×œ</button>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  function showMsg(text, ok=true){
    const el = document.getElementById('msg');
    el.style.display = 'block';
    el.className = 'msg ' + (ok ? 'ok' : 'err');
    el.textContent = text;
  }
  function clearMsg(){ const el=document.getElementById('msg'); el.style.display='none'; el.textContent=''; }

  const branchKey = localStorage.getItem('currentBranchKey');
  if (!branchKey) {
    showMsg("××™×Ÿ currentBranchKey ×‘×œ×•×§××œ ×¡×˜×•×¨×’'. ×”××¡×š ××™×•×¢×“ ×œ×¡× ×™×¤×™× ×—×“×©×™× ×‘×œ×‘×“.", false);
  }

  function baseRef(path){ return firebase.database().ref(`branches/${branchKey}/${path}`); }

  let DEPTS = {};          // {deptName: {empKey:true}}
  let DISPLAY = {};        // {empKey: "×©× ×ª×¦×•×’×”"}
  let EMPLOYEES = {};      // {empKey:true}

  async function reloadFromDB(){
    clearMsg();
    if (!branchKey) return;

    try{
      const [dSnap, eSnap, nSnap] = await Promise.all([
        baseRef('org/departments').once('value'),
        baseRef('employees').once('value'),
        baseRef('displayNames').once('value'),
      ]);

      DEPTS = dSnap.val() || {};
      EMPLOYEES = eSnap.val() || {};
      DISPLAY = nSnap.val() || {};

      renderDepts();
      renderPreview();
      showMsg("× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” âœ…", true);
    }catch(err){
      console.error(err);
      showMsg("×©×’×™××” ×‘×˜×¢×™× ×”: " + (err?.message || err), false);
    }
  }

  function renderDepts(){
    const list = document.getElementById('deptList');
    const sel = document.getElementById('deptSelect');
    list.innerHTML = '';
    sel.innerHTML = '';

    const deptNames = Object.keys(DEPTS || {});
    if (deptNames.length === 0){
      list.innerHTML = '<div class="muted">××™×Ÿ ××—×œ×§×•×ª ×¢×“×™×™×Ÿ</div>';
      sel.innerHTML = '<option value="">-- ××™×Ÿ ××—×œ×§×•×ª --</option>';
      return;
    }

    deptNames.forEach(name=>{
      const pill = document.createElement('div');
      pill.className='pill';
      pill.innerHTML = `<strong>${name}</strong> <span class="muted small">(${Object.keys(DEPTS[name]||{}).length} ×¢×•×‘×“×™×)</span>
                        <button class="btnDanger small" style="padding:6px 10px;border-radius:10px;" onclick="deleteDept('${name.replace(/'/g,"\'")}')">××—×§</button>`;
      list.appendChild(pill);

      const opt=document.createElement('option');
      opt.value=name; opt.textContent=name;
      sel.appendChild(opt);
    });
  }

  function renderPreview(){
    const box = document.getElementById('preview');
    box.innerHTML = '';
    const deptNames = Object.keys(DEPTS || {});
    if (deptNames.length === 0){
      box.innerHTML = '<div class="muted">×ª×™×¦×•×¨ ××—×œ×§×” ×•×ª×•×¡×™×£ ×¢×•×‘×“×™× ×›×“×™ ×œ×¨××•×ª ×›××Ÿ ×ª×¦×•×’×”</div>';
      return;
    }

    deptNames.forEach(dept=>{
      const wrap=document.createElement('div');
      wrap.className='card';
      wrap.style.margin='10px 0';
      wrap.style.padding='12px';
      wrap.innerHTML = `<div style="font-weight:800;color:#4b6cb7;margin-bottom:8px;">ğŸ¢ ${dept}</div>`;
      const emps = Object.keys(DEPTS[dept]||{});
      if (emps.length===0){
        wrap.innerHTML += `<div class="muted">××™×Ÿ ×¢×•×‘×“×™× ×‘××—×œ×§×”</div>`;
      }else{
        emps.forEach(k=>{
          const disp = DISPLAY[k] || k;
          const row=document.createElement('div');
          row.className='pill';
          row.innerHTML = `<span>${disp}</span>
                           <span class="muted small">(${k})</span>
                           <button class="btnDanger small" style="padding:6px 10px;border-radius:10px;" onclick="removeEmpFromDept('${dept.replace(/'/g,"\'")}','${k.replace(/'/g,"\'")}')">×”×¡×¨</button>`;
          wrap.appendChild(row);
        });
      }
      box.appendChild(wrap);
    });
  }

  async function createDepartment(){
    clearMsg();
    const name = (document.getElementById('deptName').value || '').trim();
    if (!name){ showMsg("×—×™×™×‘ ×œ××œ× ×©× ××—×œ×§×”", false); return; }
    if (!branchKey) return;

    try{
      // × ×™×¦×•×¨ ××—×œ×§×” ×›-××•×‘×™×™×§×˜ ×¨×™×§ (×›×“×™ ×©×”××¤×ª×— ×™×•×¤×™×¢)
      await baseRef(`org/departments/${name}`).set(DEPTS[name] || {});
      document.getElementById('deptName').value='';
      await reloadFromDB();
      showMsg(`××—×œ×§×” "${name}" × ×•×¦×¨×” âœ…`, true);
    }catch(err){
      console.error(err);
      showMsg("×©×’×™××” ×‘×™×¦×™×¨×ª ××—×œ×§×”: " + (err?.message || err), false);
    }
  }

  async function deleteDept(name){
    if (!confirm(`×œ××—×•×§ ××ª ×”××—×œ×§×” "${name}"?`)) return;
    clearMsg();
    try{
      await baseRef(`org/departments/${name}`).remove();
      await reloadFromDB();
      showMsg(`×”××—×œ×§×” "${name}" × ××—×§×” âœ…`, true);
    }catch(err){
      console.error(err);
      showMsg("×©×’×™××” ×‘××—×™×§×”: " + (err?.message || err), false);
    }
  }

  async function addEmployee(){
    clearMsg();
    const dept = document.getElementById('deptSelect').value;
    const key = (document.getElementById('empKey').value || '').trim();
    const disp = (document.getElementById('empDisplay').value || '').trim();

    if (!dept){ showMsg("×‘×—×¨ ××—×œ×§×”", false); return; }
    if (!key){ showMsg("×—×™×™×‘ ×œ××œ× ×©× ×¢×•×‘×“ (××–×”×”)", false); return; }
    if (key === 'name'){ showMsg('×”××–×”×” "name" ×œ× ×—×•×§×™ (×–×” ××” ×©×’×¨× ×œ×‘××’ ××¦×œ×š). ×ª×‘×—×¨ ××–×”×” ××—×¨.', false); return; }

    try{
      const updates = {};
      // ×¨×™×©×•× ×¢×•×‘×“ ×‘×¨×©×™××ª ×¢×•×‘×“×™× ×©×œ ×”×¡× ×™×£
      updates[`employees/${key}`] = true;
      // ×©×™×•×š ×¢×•×‘×“ ×œ××—×œ×§×”
      updates[`org/departments/${dept}/${key}`] = true;
      // ×©× ×ª×¦×•×’×”
      if (disp) updates[`displayNames/${key}`] = disp;

      await baseRef('').update(updates);

      document.getElementById('empKey').value='';
      document.getElementById('empDisplay').value='';
      await reloadFromDB();
      showMsg("×”×¢×•×‘×“ × ×•×¡×£ âœ…", true);
    }catch(err){
      console.error(err);
      showMsg("×©×’×™××” ×‘×”×•×¡×¤×ª ×¢×•×‘×“: " + (err?.message || err), false);
    }
  }

  async function removeEmpFromDept(dept, key){
    if (!confirm(`×œ×”×¡×™×¨ ××ª ${DISPLAY[key] || key} ××”××—×œ×§×” "${dept}"?`)) return;
    clearMsg();
    try{
      await baseRef(`org/departments/${dept}/${key}`).remove();
      await reloadFromDB();
      showMsg("×”×•×¡×¨ ××”××—×œ×§×” âœ…", true);
    }catch(err){
      console.error(err);
      showMsg("×©×’×™××” ×‘×”×¡×¨×”: " + (err?.message || err), false);
    }
  }

  function backToMain(){
    window.location.href = "./index.html";
  }

  function finishSetup(){
    localStorage.setItem('openManagerAfterSetup','1');
    window.location.href = "./index.html";
  }

  // init
  reloadFromDB();
</script>
</body>
</html>
