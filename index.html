<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#667eea" />
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container{
      max-width:900px; margin:0 auto; background:white; border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3); padding:30px;
    }
    h1{ text-align:center; color:#667eea; margin-bottom:30px; font-size:2.3em; }
    .section{ display:none; }
    .section.active{ display:block; }

    .btn{
      width:100%; padding:15px; background:#667eea; color:white; border:none;
      border-radius:10px; font-size:18px; font-weight:bold; cursor:pointer;
      transition:all 0.3s; margin-top:10px;
    }
    .btn:hover{ background:#5568d3; transform:translateY(-2px); }

    .mode-btn{
      padding:20px 40px; margin:10px; border:2px solid #667eea; background:white;
      color:#667eea; border-radius:10px; cursor:pointer; font-size:20px;
      font-weight:bold; transition:all 0.3s;
    }
    .mode-btn:hover{ background:#667eea; color:white; }

    input, select{
      width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px;
      font-size:16px; margin-top:8px;
    }
    .form-group{ margin-bottom:15px; }
    label{ display:block; margin-bottom:5px; font-weight:bold; color:#555; }

    .constraint-item{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border:2px solid #e0e0e0;
    }
    .constraint-card{ background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:10px; }

    .message{
      padding:15px; border-radius:8px; margin-top:20px; text-align:center;
      font-weight:bold; white-space:pre-line;
    }
    .message.success{ background:#d4edda; color:#155724; }
    .message.error{ background:#f8d7da; color:#721c24; }

    .employee-constraints{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border-right:4px solid #667eea;
    }

    .schedule-table{
      width:100%;
      margin-top:20px;
      border-collapse:collapse;
      background:white;
      border-radius:8px;
      overflow:hidden;
    }
    .schedule-table th{
      background:#667eea;
      color:white;
      padding:15px 10px;
      text-align:center;
      font-size:14px;
      min-width:100px;
    }
    .schedule-table td{
      padding:15px 10px;
      text-align:center;
      border:1px solid #e0e0e0;
      vertical-align:middle;
      min-width:100px;
    }

    .shift-morning, .shift-middle, .shift-evening, .shift-friday, .shift-saturday{
      display:inline-block; padding:8px 12px; border-radius:6px;
      font-size:13px; font-weight:bold; line-height:1.6;
    }
    .shift-morning{ background:#fff3cd; }
    .shift-middle{ background:#ffd4a3; }
    .shift-evening{ background:#d1ecf1; }
    .shift-friday{ background:#d4edda; }
    .shift-saturday{ background:#e7d4f5; }

    .approval-buttons{ display:inline-flex; gap:10px; margin-right:10px; flex-wrap:wrap; }
    .approve-btn, .reject-btn, .reset-btn{
      padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
    }
    .approve-btn{ background:#28a745; color:white; }
    .reject-btn{ background:#dc3545; color:white; }
    .reset-btn{ background:#6c757d; color:white; }

    .status-pending, .status-approved, .status-rejected{
      padding:5px 12px; border-radius:20px; font-size:14px; display:inline-block; margin-right:8px;
    }
    .status-pending{ background:#fff3cd; color:#856404; }
    .status-approved{ background:#d4edda; color:#155724; }
    .status-rejected{ background:#f8d7da; color:#721c24; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 20px 0;
    }
    .toolbar .btn{ width:auto; padding:10px 14px; font-size:14px; margin-top:0; }

    .dept-divider td{
      background:#667eea !important;
      color:#fff !important;
      font-weight:900;
      text-align:center !important;
      font-size:16px;
      padding:12px !important;
      border:0 !important;
      letter-spacing:.3px;
    }

    .emp-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .emp-header-row h4{
      margin:0;
    }
    .emp-header-row .reset-btn{
      white-space:nowrap;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- Login Screen -->
  <div id="login-screen" class="section active">
    <h1>ğŸ—“ï¸ ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h1>
    <div style="text-align:center; margin-top:40px;">
      <button class="mode-btn" onclick="showLoginForm('employee')">ğŸ‘¤ ×›× ×™×¡×ª ×¢×•×‘×“</button>
      <button class="mode-btn" onclick="showLoginForm('manager')">ğŸ‘” ×›× ×™×¡×ª ×× ×”×œ</button>
    </div>
  </div>

  <!-- Employee Login -->
  <div id="employee-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×¢×•×‘×“</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="emp-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="emp-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginEmployee()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Manager Login -->
  <div id="manager-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×× ×”×œ</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="mgr-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="mgr-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginManager()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Employee Section -->
  <div id="employee-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h1>ğŸ—“ï¸ ××©××¨×•×ª</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>
    <h2 id="employee-welcome" style="color:#667eea; text-align:center; margin-bottom:30px;"></h2>

    <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
      <h3>×”×’×“×¨×ª ××™×œ×•×¦×™× (×¢×“ 2)</h3>
      <p style="color:#e74c3c; margin:10px 0;">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ××•×¦"×©</p>

      <div class="form-group">
        <label>×ª××¨×™×š:</label>
        <input type="date" id="constraint-date">
      </div>
      <div class="form-group">
        <label>×¡×•×’ ××™×œ×•×¥:</label>
        <select id="constraint-type">
          <option value="no-morning">×œ× ××©××¨×ª ×‘×•×§×¨</option>
          <option value="no-evening">×œ× ××©××¨×ª ×¢×¨×‘</option>
          <option value="day-off">×—×•×¤×© ××œ×</option>
        </select>
      </div>
      <button class="btn" onclick="addConstraint()">×”×•×¡×£ ××™×œ×•×¥</button>
    </div>

    <div id="constraints-list" style="margin-top:30px;"></div>
  </div>

  <!-- Manager Section -->
  <div id="manager-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h1>ğŸ—“ï¸ × ×™×”×•×œ</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="createSchedule()">ğŸ”„ ×¦×•×¨ ×¡×™×“×•×¨ ×—×“×©</button>
      <button class="btn" onclick="exportToExcel()" style="background:#28a745;">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
    </div>

    <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px;">
      <h3>ğŸ” ×‘×§×©×•×ª ×—×•×¤×© ×××ª×™× ×•×ª</h3>
      <div id="pending-requests"></div>
    </div>

    <div id="all-constraints-view"></div>
    <div id="schedule-result"></div>
  </div>

  <div id="message"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCiC39handSVNM_vDDL_wUGLedEyHhf5pI",
    authDomain: "shift-manager-c026e.firebaseapp.com",
    databaseURL: "https://shift-manager-c026e-default-rtdb.firebaseio.com",
    projectId: "shift-manager-c026e",
    storageBucket: "shift-manager-c026e.firebasestorage.app",
    messagingSenderId: "1091605398341",
    appId: "1:1091605398341:web:cb6c14e7d832c3e8df342c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const DEPARTMENTS = {
    '××—×œ×§×ª ××™×—×©×•×‘': ['ILAY', 'ROVEN'],
    '××—×œ×§×ª ×§×˜× ×™×': ['HAI', 'NATALI'],
    '××—×œ×§×ª ××—×¡× ××™×': ['AVI', 'MOHAMAD'],
    '××—×œ×§×ª ×§×• ×œ×‘×Ÿ': ['INNA', 'TAMIR', 'ELIYA'],
    '× ×¦×™×’×•×ª ×©×™×¨×•×ª': ['LIOR', 'AMANI', 'SHIROT']
  };

  const MANAGER_CREDENTIALS = { username: 'SAGI', password: '102' };

  const EMPLOYEE_CREDENTIALS = {
    'ILAY': 'ILAY',
    'ROVEN': 'ROVEN',
    'HAI': 'HAI',
    'NATALI': 'NATALI',
    'INNA': 'INNA',
    'TAMIR': 'TAMIR',
    'ELIYA': 'ELIYA',
    'LIOR': 'LIOR',
    'AMANI': 'AMANI',
    'SHIROT': 'SHIROT',
    'AVI': 'AVI',
    'MOHAMAD': 'MOHAMAD'
  };

  let currentUser = null;
  let currentSchedule = null;

  // Login
  function showLoginForm(type) {
    hideAll();
    clearInputs();
    document.getElementById(type + '-login').classList.add('active');
  }

  function backToLogin() {
    hideAll();
    clearInputs();
    document.getElementById('login-screen').classList.add('active');
  }

  function loginEmployee() {
    const user = document.getElementById('emp-username').value.trim();
    const pass = document.getElementById('emp-password').value.trim();

    if (EMPLOYEE_CREDENTIALS[user] === pass) {
      currentUser = user;
      hideAll();
      document.getElementById('employee-section').classList.add('active');
      document.getElementById('employee-welcome').textContent = `×©×œ×•×, ${user}!`;
      loadEmployeeConstraints(user);
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  function loginManager() {
    const user = document.getElementById('mgr-username').value.trim();
    const pass = document.getElementById('mgr-password').value.trim();

    if (user === MANAGER_CREDENTIALS.username && pass === MANAGER_CREDENTIALS.password) {
      currentUser = 'manager';
      hideAll();
      document.getElementById('manager-section').classList.add('active');
      loadAllConstraints();
      loadPendingRequests();
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  function logout() {
    currentUser = null;
    currentSchedule = null;
    hideAll();
    clearInputs();
    document.getElementById('login-screen').classList.add('active');
  }

  // Constraints
  async function addConstraint() {
    const date = document.getElementById('constraint-date').value;
    const type = document.getElementById('constraint-type').value;

    if (!date) { showMessage('× × ×œ×‘×—×•×¨ ×ª××¨×™×š', 'error'); return; }
    if (!isValidWeekday(date)) { showMessage('×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ××•×¦"×©', 'error'); return; }

    const constraintsRef = db.ref('constraints/' + currentUser);
    const snapshot = await constraintsRef.once('value');
    const existing = snapshot.val() || {};
    const count = Object.keys(existing).length;

    if (count >= 2) { showMessage('× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×“ 2 ××™×œ×•×¦×™× ×‘×œ×‘×“', 'error'); return; }

    const newConstraint = { date, type, status: 'pending', employee: currentUser };
    await constraintsRef.push(newConstraint);

    showMessage('×”××™×œ×•×¥ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
    document.getElementById('constraint-date').value = '';
    loadEmployeeConstraints(currentUser);
  }

  async function deleteConstraint(key) {
    if (!confirm('×œ××—×•×§ ××™×œ×•×¥ ×–×”?')) return;
    await db.ref('constraints/' + currentUser + '/' + key).remove();
    showMessage('×”××™×œ×•×¥ × ××—×§', 'success');
    loadEmployeeConstraints(currentUser);
  }

  async function loadEmployeeConstraints(emp) {
    const snapshot = await db.ref('constraints/' + emp).once('value');
    const data = snapshot.val() || {};
    const list = Object.entries(data);

    let html = '';
    if (list.length === 0) {
      html = '<p style="text-align:center; color:#999;">××™×Ÿ ××™×œ×•×¦×™×</p>';
    } else {
      list.forEach(([key, c]) => {
        html += `
          <div class="constraint-card">
            <strong>ğŸ“… ${formatDate(c.date)}</strong> - ${formatType(c.type)}
            ${getStatusBadge(c)}
            <button class="btn" onclick="deleteConstraint('${key}')" style="background:#dc3545; margin-top:10px;">××—×§</button>
          </div>`;
      });
    }

    document.getElementById('constraints-list').innerHTML = html;
  }

  // Manager: Pending Requests
  async function loadPendingRequests() {
    const snapshot = await db.ref('constraints').once('value');
    const allData = snapshot.val() || {};
    let html = '';
    let found = false;

    for (const [emp, constraints] of Object.entries(allData)) {
      for (const [key, c] of Object.entries(constraints)) {
        if (c.type === 'day-off' && c.status === 'pending') {
          found = true;
          html += `
            <div class="constraint-item">
              <strong>${emp}</strong> - ${formatDate(c.date)} - ${formatType(c.type)}
              <div class="approval-buttons">
                <button class="approve-btn" onclick="handleRequest('${emp}','${key}','approved')">âœ… ××©×¨</button>
                <button class="reject-btn" onclick="handleRequest('${emp}','${key}','rejected')">âŒ ×“×—×”</button>
              </div>
            </div>`;
        }
      }
    }

    document.getElementById('pending-requests').innerHTML = found ? html : '<p style="text-align:center; color:#999;">××™×Ÿ ×‘×§×©×•×ª ×—×•×¤×© ×××ª×™× ×•×ª</p>';
  }

  async function handleRequest(emp, key, status) {
    await db.ref('constraints/' + emp + '/' + key).update({ status });
    showMessage(status === 'approved' ? '×”×‘×§×©×” ××•×©×¨×”!' : '×”×‘×§×©×” × ×“×—×ª×”', 'success');
    loadPendingRequests();
    loadAllConstraints();
  }

  async function loadAllConstraints() {
    const snapshot = await db.ref('constraints').once('value');
    const allData = snapshot.val() || {};
    let html = '<h2 style="color:#667eea; margin-top:30px;">ğŸ“‹ ×›×œ ×”××™×œ×•×¦×™×</h2>';

    for (const [emp, constraints] of Object.entries(allData)) {
      const list = Object.entries(constraints);
      if (list.length === 0) continue;

      html += `<div class="employee-constraints">`;
      html += `
        <div class="emp-header-row">
          <h4>${emp}</h4>
          <button class="reset-btn" onclick="resetEmployee('${emp}')">ğŸ”„ ××¤×¡ ×¢×•×‘×“</button>
        </div>`;

      list.forEach(([key, c]) => {
        html += `
          <div class="constraint-card">
            <strong>ğŸ“… ${formatDate(c.date)}</strong> - ${formatType(c.type)}
            ${getStatusBadge(c)}
          </div>`;
      });

      html += `</div>`;
    }

    document.getElementById('all-constraints-view').innerHTML = html;
  }

  async function resetEmployee(emp) {
    if (!confirm(`×”×× ×œ××¤×¡ ××ª ×›×œ ×”××™×œ×•×¦×™× ×©×œ ${emp}?`)) return;
    await db.ref('constraints/' + emp).remove();
    showMessage(`×”×¢×•×‘×“ ${emp} ××•×¤×¡!`, 'success');
    loadPendingRequests();
    loadAllConstraints();
  }

  // Create Schedule
  async function createSchedule() {
    const now = new Date();
    const sunday = now.getDay() === 0 ? now : new Date(now.getTime() + (7 - now.getDay()) * 86400000);
    const nextSunday = new Date(sunday.getTime() + 7 * 86400000);

    const snapshot = await db.ref('constraints').once('value');
    const constraintsData = snapshot.val() || {};

    const allSchedules = generateSchedule(nextSunday, constraintsData);
    currentSchedule = allSchedules;
    displaySchedule(allSchedules);
    showMessage('×”×¡×™×“×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
  }

  function hasConstraint(emp, dateStr, type) {
    const cs = window.allConstraintsData?.[emp] || {};
    for (const c of Object.values(cs)) {
      if (c.date !== dateStr) continue;
      if (c.type === 'day-off' && c.status !== 'approved') continue;
      if (type === 'morning' && c.type === 'no-morning') return true;
      if (type === 'evening' && c.type === 'no-evening') return true;
      if (type === 'full' && c.type === 'day-off' && c.status === 'approved') return true;
    }
    return false;
  }

  function generateSchedule(nextSunday, constraintsData) {
    window.allConstraintsData = constraintsData;
    const allSchedules = {};
    const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™'];

    for (const [dept, emps] of Object.entries(DEPARTMENTS)) {
      const isThreeEmp = emps.length === 3;
      const schedule = [];

      for (let i = 0; i < 5; i++) {
        const date = new Date(nextSunday); date.setDate(nextSunday.getDate() + i);
        const dateStr = toLocalDateStr(date);

        if (isThreeEmp) {
          const hasNoMorning = emps.map(e => hasConstraint(e, dateStr, 'morning'));
          const hasNoEvening = emps.map(e => hasConstraint(e, dateStr, 'evening'));
          const hasFullOff = emps.map(e => hasConstraint(e, dateStr, 'full'));

          let morning, middle, evening;

          if (hasFullOff.some(x => x)) {
            const offIdx = hasFullOff.indexOf(true);
            const others = emps.filter((_, idx) => idx !== offIdx);
            morning = hasNoMorning[emps.indexOf(others[0])] ? others[1] : others[0];
            evening = hasNoEvening[emps.indexOf(others[0])] ? others[1] : others[0];
            middle = others.find(e => e !== morning && e !== evening) || others[0];
          } else {
            morning = hasNoMorning[0] ? (hasNoMorning[1] ? emps[2] : emps[1]) : emps[0];
            middle = emps[1];
            evening = hasNoEvening[2] ? (hasNoEvening[1] ? emps[0] : emps[1]) : emps[2];
          }

          schedule.push({ day: days[i], date: dateStr, morning, middle, evening, dept });
        } else {
          const a = emps[0], b = emps[1];
          if (hasConstraint(a, dateStr, 'full')) {
            schedule.push({ day: days[i], date: dateStr, morning: b, evening: b, dept });
          } else if (hasConstraint(b, dateStr, 'full')) {
            schedule.push({ day: days[i], date: dateStr, morning: a, evening: a, dept });
          } else {
            const m = (i % 2 === 0) ? a : b;
            const e = (m === a) ? b : a;
            const mCant = hasConstraint(m, dateStr, 'morning');
            const eCant = hasConstraint(e, dateStr, 'evening');
            schedule.push({ day: days[i], date: dateStr, morning: mCant ? e : m, evening: eCant ? m : e, dept });
          }
        }
      }

      const fri = new Date(nextSunday); fri.setDate(nextSunday.getDate() + 5);
      const friStr = toLocalDateStr(fri);
      if (isThreeEmp) {
        const friOff = emps.find(emp => hasConstraint(emp, friStr, 'full'));
        const friWorking = friOff ? emps.filter(x => x !== friOff) : [emps[0], emps[1]];
        schedule.push({ day:'×©×™×©×™', date: friStr, friday: friWorking, dept });
      } else {
        const a = emps[0], b = emps[1];
        const aOff = hasConstraint(a, friStr, 'full');
        schedule.push({ day:'×©×™×©×™', date: friStr, friday: aOff ? b : a, dept });
      }

      const sat = new Date(nextSunday); sat.setDate(nextSunday.getDate() + 6);
      const satStr = toLocalDateStr(sat);
      if (isThreeEmp) {
        const friWorking = schedule[schedule.length - 1].friday;
        const satWorking = emps.find(e => !friWorking.includes(e)) || emps[2];
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satWorking, dept });
      } else {
        const friEmp = schedule[schedule.length - 1].friday;
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: (friEmp === emps[0]) ? emps[1] : emps[0], dept });
      }

      allSchedules[dept] = schedule;
    }

    return allSchedules;
  }

  function displaySchedule(allSchedules) {
    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => allSchedules[d] && allSchedules[d].length) || deptOrder[0];
    const sampleSchedule = allSchedules[sampleDept] || [];
    if (sampleSchedule.length === 0) { document.getElementById('schedule-result').innerHTML = ''; return; }

    const dayCols = sampleSchedule.map(d => ({ day: d.day, date: d.date }));
    const totalCols = dayCols.length + 2;

    let html = `
      <h2 style="color:#667eea; margin-top:30px;">ğŸ“… ×¡×™×“×•×¨ ×©×‘×•×¢×™ - ×›×œ ×”×¡× ×™×£</h2>
      <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px;">
        <table class="schedule-table">
          <tr>
            <th>×¢×•×‘×“</th>
            <th>××—×œ×§×”</th>`;

    dayCols.forEach(c => { html += `<th>${c.day}<br>${formatDate(c.date)}</th>`; });
    html += `</tr>`;

    deptOrder.forEach(dept => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = allSchedules[dept] || [];

      html += `<tr class="dept-divider"><td colspan="${totalCols}">ğŸ¢ ${dept}</td></tr>`;

      employees.forEach(emp => {
        html += `<tr>
          <td style="background:#667eea; color:white; font-weight:bold;">${emp}</td>
          <td style="background:#eef2ff; font-weight:bold;">${dept}</td>`;

        dayCols.forEach(c => {
          const day = deptSchedule.find(d => d.date === c.date);
          if (!day) { html += `<td style="background:#f0f0f0;">-</td>`; return; }

          const isThreeEmp = employees.length === 3;
          const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

          if (day.friday) {
            if (isThreeEmp) {
              const works = Array.isArray(day.friday) && day.friday.includes(emp);
              html += works
                ? (isKavLavan ? `<td><span class="shift-friday">×¢×•×‘×“ ×‘×©×™×©×™</span></td>` : `<td><span class="shift-friday">×©×™×©×™<br>8:30-14:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.friday === emp) ? `<td><span class="shift-friday">×‘×•×§×¨<br>8:30-14:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          if (day.saturday) {
            if (isThreeEmp) {
              html += (day.saturday === emp)
                ? (isKavLavan ? `<td><span class="shift-saturday">×¢×•×‘×“ ×‘××•×¦"×©</span></td>` : `<td><span class="shift-saturday">××•×¦"×©<br>××•×¦"×©-22:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.saturday === emp) ? `<td><span class="shift-saturday">×¢×¨×‘<br>××•×¦"×©-22:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          const shifts = [];
          if (day.morning === emp) shifts.push(isKavLavan ? '<span class="shift-morning">×‘×•×§×¨</span>' : '<span class="shift-morning">×‘×•×§×¨<br>9:00-16:00</span>');
          if (day.middle === emp) shifts.push(isKavLavan ? '<span class="shift-middle">×××¦×¢</span>' : '<span class="shift-middle">×××¦×¢<br>11:00-19:00</span>');
          if (day.evening === emp) shifts.push(isKavLavan ? '<span class="shift-evening">×¢×¨×‘</span>' : '<span class="shift-evening">×¢×¨×‘<br>15:00-21:30</span>');

          html += shifts.length ? `<td>${shifts.join('<br>')}</td>` : `<td style="background:#f0f0f0;">-</td>`;
        });

        html += `</tr>`;
      });
    });

    html += `</table></div>`;
    document.getElementById('schedule-result').innerHTML = html;
  }

  // ×¤×•× ×§×¦×™×™×ª ×™×™×¦×•× ×œ××§×¡×œ ××©×•×¤×¨×ª ×¢× ×¢×™×¦×•×‘ ××œ×!
  function exportToExcel() {
    if (!currentSchedule) {
      showMessage('××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×! ×™×© ×œ×™×¦×•×¨ ×¡×™×“×•×¨ ×ª×—×™×œ×”.', 'error');
      return;
    }

    const wb = XLSX.utils.book_new();

    // ×¦×‘×¢×™× ××”×˜×‘×œ×” ×”××§×•×¨×™×ª
    const COLORS = {
      morning: { bg: 'FFF3CD', text: '000000' },
      middle: { bg: 'FFD4A3', text: '000000' },
      evening: { bg: 'D1ECF1', text: '000000' },
      friday: { bg: 'D4EDDA', text: '000000' },
      saturday: { bg: 'E7D4F5', text: '000000' },
      header: { bg: '667EEA', text: 'FFFFFF' },
      empName: { bg: '667EEA', text: 'FFFFFF' },
      deptName: { bg: 'EEF2FF', text: '000000' },
      deptDivider: { bg: '667EEA', text: 'FFFFFF' },
      empty: { bg: 'F0F0F0', text: '000000' }
    };

    for (const [dept, schedule] of Object.entries(currentSchedule)) {
      const employees = DEPARTMENTS[dept] || [];
      const isThreeEmp = employees.length === 3;
      const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

      const data = [];
      
      // ×©×•×¨×ª ××—×œ×§×”
      const deptRow = [dept];
      for (let i = 0; i < schedule.length + 1; i++) deptRow.push('');
      data.push(deptRow);

      // ×©×•×¨×ª ×›×•×ª×¨×•×ª
      const headerRow = ['×¢×•×‘×“', '××—×œ×§×”'];
      schedule.forEach(day => headerRow.push(`${day.day} ${formatDate(day.date)}`));
      data.push(headerRow);

      // ×©×•×¨×•×ª ×¢×•×‘×“×™×
      employees.forEach(emp => {
        const row = [emp, dept];
        schedule.forEach(day => {
          let cellText = '';
          
          if (day.friday) {
            if (isThreeEmp) {
              cellText = (Array.isArray(day.friday) && day.friday.includes(emp))
                ? (isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™\n8:30-14:30')
                : '-';
            } else {
              cellText = (day.friday === emp) ? '×‘×•×§×¨\n8:30-14:30' : '-';
            }
          } else if (day.saturday) {
            if (isThreeEmp) {
              cellText = (day.saturday === emp)
                ? (isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×©\n××•×¦"×©-22:30')
                : '-';
            } else {
              cellText = (day.saturday === emp) ? '×¢×¨×‘\n××•×¦"×©-22:30' : '-';
            }
          } else {
            const shifts = [];
            if (day.morning === emp) shifts.push(isKavLavan ? '×‘×•×§×¨' : '×‘×•×§×¨\n9:00-16:00');
            if (day.middle === emp) shifts.push(isKavLavan ? '×××¦×¢' : '×××¦×¢\n11:00-19:00');
            if (day.evening === emp) shifts.push(isKavLavan ? '×¢×¨×‘' : '×¢×¨×‘\n15:00-21:30');
            cellText = shifts.length ? shifts.join('\n') : '-';
          }
          
          row.push(cellText);
        });
        data.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);

      // ×”×’×“×¨×ª ×¨×•×—×‘ ×¢××•×“×•×ª
      const colWidths = [{ wch: 15 }, { wch: 15 }];
      schedule.forEach(() => colWidths.push({ wch: 15 }));
      ws['!cols'] = colWidths;

      // ×”×’×“×¨×ª ×’×•×‘×” ×©×•×¨×•×ª
      const rowHeights = [{ hpt: 25 }];
      for (let i = 0; i < data.length; i++) rowHeights.push({ hpt: 40 });
      ws['!rows'] = rowHeights;

      // ×¢×™×¦×•×‘ ×ª××™×
      const range = XLSX.utils.decode_range(ws['!ref']);
      
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellAddress]) continue;

          ws[cellAddress].s = {
            alignment: {
              horizontal: 'center',
              vertical: 'center',
              wrapText: true
            },
            border: {
              top: { style: 'thin', color: { rgb: 'E0E0E0' } },
              bottom: { style: 'thin', color: { rgb: 'E0E0E0' } },
              left: { style: 'thin', color: { rgb: 'E0E0E0' } },
              right: { style: 'thin', color: { rgb: 'E0E0E0' } }
            },
            font: {
              name: 'Arial',
              sz: 11,
              bold: false,
              color: { rgb: '000000' }
            }
          };

          if (R === 0) {
            ws[cellAddress].s.fill = { fgColor: { rgb: COLORS.deptDivider.bg } };
            ws[cellAddress].s.font = { name: 'Arial', sz: 14, bold: true, color: { rgb: COLORS.deptDivider.text } };
          }
          else if (R === 1) {
            ws[cellAddress].s.fill = { fgColor: { rgb: COLORS.header.bg } };
            ws[cellAddress].s.font = { name: 'Arial', sz: 12, bold: true, color: { rgb: COLORS.header.text } };
          }
          else {
            if (C === 0) {
              ws[cellAddress].s.fill = { fgColor: { rgb: COLORS.empName.bg } };
              ws[cellAddress].s.font = { name: 'Arial', sz: 11, bold: true, color: { rgb: COLORS.empName.text } };
            }
            else if (C === 1) {
              ws[cellAddress].s.fill = { fgColor: { rgb: COLORS.deptName.bg } };
              ws[cellAddress].s.font.bold = true;
            }
            else {
              const cellValue = ws[cellAddress].v || '';
              let bgColor = COLORS.empty.bg;

              if (cellValue.includes('×‘×•×§×¨') && !cellValue.includes('8:30')) {
                bgColor = COLORS.morning.bg;
              } else if (cellValue.includes('×××¦×¢')) {
                bgColor = COLORS.middle.bg;
              } else if (cellValue.includes('×¢×¨×‘') && !cellValue.includes('××•×¦"×©')) {
                bgColor = COLORS.evening.bg;
              } else if (cellValue.includes('×©×™×©×™') || cellValue.includes('8:30')) {
                bgColor = COLORS.friday.bg;
              } else if (cellValue.includes('××•×¦"×©')) {
                bgColor = COLORS.saturday.bg;
              }

              ws[cellAddress].s.fill = { fgColor: { rgb: bgColor } };
              ws[cellAddress].s.font.bold = (cellValue !== '-');
            }
          }
        }
      }

      ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: schedule.length + 1 } }];

      XLSX.utils.book_append_sheet(wb, ws, dept);
    }

    const today = new Date();
    const fileName = `×¡×™×“×•×¨_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showMessage('×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”! âœ…', 'success');
  }

  // Helpers
  function hideAll() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('message').innerHTML = '';
  }
  function clearInputs() {
    document.getElementById('emp-username').value = '';
    document.getElementById('emp-password').value = '';
    document.getElementById('mgr-username').value = '';
    document.getElementById('mgr-password').value = '';
  }
  function showMessage(text, type) {
    const div = document.getElementById('message');
    div.className = `message ${type}`;
    div.textContent = text;
    setTimeout(() => div.innerHTML = '', 8000);
  }
  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function toLocalDateStr(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function formatType(type) {
    const types = { 'no-morning':'âŒ ×œ× ×‘×•×§×¨', 'no-evening':'âŒ ×œ× ×¢×¨×‘', 'day-off':'ğŸ–ï¸ ×—×•×¤×© ××œ×' };
    return types[type] || type;
  }
  function isValidWeekday(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const day = d.getDay();
    return day !== 5 && day !== 6;
  }
  function getStatusBadge(c) {
    if (c.type !== 'day-off') return '';
    const statuses = { 'pending':'â³ ×××ª×™×Ÿ', 'approved':'âœ… ×××•×©×¨', 'rejected':'âŒ × ×“×—×”' };
    const classes  = { 'pending':'status-pending', 'approved':'status-approved', 'rejected':'status-rejected' };
    const status = c.status || 'pending';
    return `<span class="${classes[status]}">${statuses[status]}</span>`;
  }
</script>
</body>
</html>