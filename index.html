<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#667eea" />
  <title>××¢×¨×›×ª ×¡×™×“×•×¨ ×¢×‘×•×“×” - ××—×¡× ×™ ×—×©××œ</title>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --success: #38a169;
      --danger: #e53e3e;
      --warning: #d69e2e;
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #2d3748;
      --muted: #718096;
      --border: #e2e8f0;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --shadow-sm: 0 4px 10px rgba(0,0,0,0.06);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans Hebrew", sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255,255,255,0.92);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    header {
      padding: 18px 20px;
      background: linear-gradient(135deg, rgba(102,126,234,0.95), rgba(118,75,162,0.95));
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    header .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.2px;
    }

    header .sub {
      margin: 0;
      opacity: 0.9;
      font-size: 13px;
    }

    .userbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.25);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 13px;
      transition: transform 0.05s ease, opacity 0.2s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:active { transform: scale(0.98); }

    .btn-primary {
      background: white;
      color: #4c51bf;
    }
    .btn-primary:hover { opacity: 0.95; }

    .btn-danger {
      background: rgba(229,62,62,0.95);
      color: white;
    }
    .btn-danger:hover { opacity: 0.92; }

    .content {
      padding: 18px;
      background: var(--bg);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      padding: 16px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #2c5282;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .muted { color: var(--muted); font-size: 13px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 180px; }

    label {
      display: block;
      font-size: 12px;
      color: #4a5568;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      background: white;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(102,126,234,0.7);
      box-shadow: 0 0 0 4px rgba(102,126,234,0.15);
    }

    textarea { resize: vertical; min-height: 80px; }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .actions .btn {
      justify-content: center;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 14px 0;
    }

    .message {
      margin-top: 10px;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      display: none;
    }
    .message.success { background: rgba(56,161,105,0.12); color: #276749; border: 1px solid rgba(56,161,105,0.25); display: block;}
    .message.error { background: rgba(229,62,62,0.12); color: #9b2c2c; border: 1px solid rgba(229,62,62,0.25); display: block;}
    .message.info { background: rgba(49,130,206,0.10); color: #2b6cb0; border: 1px solid rgba(49,130,206,0.25); display: block;}
    .message.warn { background: rgba(214,158,46,0.12); color: #7b341e; border: 1px solid rgba(214,158,46,0.25); display: block;}

    .hidden { display: none !important; }

    /* ×˜×‘×œ×” */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: white;
    }
    th, td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      border-left: 1px solid var(--border);
      text-align: center;
      font-size: 13px;
    }
    th:last-child, td:last-child { border-left: none; }
    tr:last-child td { border-bottom: none; }
    thead th {
      background: #edf2f7;
      color: #2d3748;
      font-weight: 800;
      font-size: 12px;
    }
    .dept-row td{
      text-align: right;
      font-weight: 800;
      background: #faf5ff;
      color: #553c9a;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      border: 1px solid var(--border);
      background: #fff;
    }
    .tag.approved { background: rgba(56,161,105,0.12); border-color: rgba(56,161,105,0.25); color: #276749; }
    .tag.pending { background: rgba(214,158,46,0.12); border-color: rgba(214,158,46,0.25); color: #7b341e; }
    .tag.rejected { background: rgba(229,62,62,0.12); border-color: rgba(229,62,62,0.25); color: #9b2c2c; }

    .small-btn {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 800;
    }
    .small-btn:hover { background: #f7fafc; }

    .approve-btn {
      border-color: rgba(56,161,105,0.35);
      color: #276749;
    }
    .reject-btn {
      border-color: rgba(229,62,62,0.35);
      color: #9b2c2c;
    }

    .reset-btn {
      border-color: rgba(49,130,206,0.35);
      color: #2b6cb0;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <h1>ğŸ“… ××¢×¨×›×ª ××™×œ×•×¦×™× ×•×¡×™×“×•×¨ ×¢×‘×•×“×”</h1>
        <p class="sub">×¢×•×‘×“×™× ××’×™×©×™× ××™×œ×•×¦×™× â€¢ ×× ×”×œ ×××©×¨/×“×•×—×” â€¢ ×™×¦×™×¨×ª ×¡×™×“×•×¨ ×œ×¤×™ ××—×œ×§×•×ª</p>
      </div>

      <div class="userbar">
        <div class="pill" id="userPill">ğŸ‘¤ ×œ× ××—×•×‘×¨</div>
        <button class="btn btn-primary" id="logoutBtn" onclick="logout()" style="display:none;">ğŸšª ×”×ª× ×ª×§×•×ª</button>
      </div>
    </header>

    <div class="content">
      <!-- LOGIN -->
      <div class="card" id="loginCard">
        <h2>ğŸ” ×”×ª×—×‘×¨×•×ª</h2>
        <div class="row">
          <div>
            <label>×©× ××©×ª××©</label>
            <input id="username" placeholder="×œ××©×œ: ygal" autocomplete="username" />
          </div>
          <div>
            <label>×¡×™×¡××”</label>
            <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="login()">×›× ×™×¡×”</button>
        </div>
        <div class="message" id="loginMsg"></div>
      </div>

      <!-- EMPLOYEE -->
      <div class="grid hidden" id="employeeArea">
        <div class="card">
          <h2>ğŸ§© ×”×’×©×ª ××™×œ×•×¥ ××™×©×™</h2>

          <div class="row">
            <div>
              <label>×ª××¨×™×š</label>
              <input type="date" id="constraintDate" />
              <div class="note">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ××•×¦"×©</div>
            </div>
            <div>
              <label>×¡×•×’ ××™×œ×•×¥</label>
              <select id="constraintType">
                <option value="full">×—×•×¤×© ××œ×</option>
                <option value="until">×¢×•×‘×“/×ª ×¢×“ ×©×¢×” (×œ××©×œ 16:00)</option>
                <option value="from">×¢×•×‘×“/×ª ×¨×§ ××©×¢×” (×œ××©×œ 16:00)</option>
              </select>
            </div>
            <div>
              <label>×©×¢×” (×× ×¨×œ×•×•× ×˜×™)</label>
              <input type="time" id="constraintTime" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>×”×¢×¨×” (×œ× ×—×•×‘×”)</label>
            <textarea id="constraintNote" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea>
          </div>

          <div class="actions">
            <button class="btn btn-primary" onclick="submitConstraint()">â• ×©×œ×— ××™×œ×•×¥</button>
            <button class="btn" onclick="loadMyConstraints()">ğŸ”„ ×¨×¢× ×Ÿ</button>
          </div>

          <div class="message" id="empMsg"></div>

          <div class="divider"></div>

          <h2>ğŸ“Œ ×”××™×œ×•×¦×™× ×©×œ×™</h2>
          <div id="myConstraints"></div>
        </div>

        <div class="card">
          <h2>ğŸ—“ï¸ ×”×¡×™×“×•×¨ ×”× ×•×›×—×™</h2>
          <div class="muted">×›××Ÿ ×™×•×¦×’ ×¡×™×“×•×¨ ×”×¢×‘×•×“×” ×”××—×¨×•×Ÿ ×©× ×•×¦×¨.</div>
          <div class="divider"></div>
          <div id="scheduleViewEmp"></div>
        </div>
      </div>

      <!-- MANAGER -->
      <div class="grid hidden" id="managerArea">
        <div class="card">
          <h2>ğŸ§‘â€ğŸ’¼ ××™×©×•×¨/×“×—×™×™×ª ××™×œ×•×¦×™× (×× ×”×œ)</h2>
          <div class="actions">
            <button class="btn btn-primary" onclick="loadAllConstraints()">ğŸ”„ ×¨×¢× ×Ÿ ××™×œ×•×¦×™×</button>
          </div>
          <div class="divider"></div>
          <div id="allConstraints"></div>
        </div>

        <div class="card">
          <h2>âš™ï¸ ×™×¦×™×¨×ª ×¡×™×“×•×¨ ×¢×‘×•×“×”</h2>
          <div class="muted">×‘×—×¨ ×˜×•×•×— ×ª××¨×™×›×™× (×©×‘×•×¢). ×”××¢×¨×›×ª ×ª×™×™×¦×¨ ×¡×™×“×•×¨ ×œ×¤×™ ××—×œ×§×•×ª ×•××™×œ×•×¦×™× ×××•×©×¨×™×.</div>
          <div class="divider"></div>

          <div class="row">
            <div>
              <label>×ª××¨×™×š ×”×ª×—×œ×”</label>
              <input type="date" id="weekStart" />
            </div>
            <div>
              <label>××¡×¤×¨ ×™××™× (×‘×¨×™×¨×ª ××—×“×œ: 7)</label>
              <input type="number" id="daysCount" min="1" max="14" value="7" />
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-primary" onclick="createSchedule()">ğŸ§¾ ×¦×•×¨ ×¡×™×“×•×¨</button>
            <button class="btn" onclick="loadSchedule()">ğŸ“¥ ×˜×¢×Ÿ ×¡×™×“×•×¨ ××—×¨×•×Ÿ</button>
            <button class="btn" onclick="exportToExcel()">ğŸ“¤ ×™×™×¦×•× ×œ××§×¡×œ</button>
          </div>

          <div class="message" id="mgrMsg"></div>

          <div class="divider"></div>

          <h2>ğŸ“‹ ×ª×¦×•×’×ª ×¡×™×“×•×¨</h2>
          <div id="scheduleViewMgr"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- SheetJS (× ××¦× ××š ×œ× ×—×•×‘×”, ××¤×©×¨ ×œ×”×©×ª××© ×‘×¢×ª×™×“ ×œ-XLSX ×××™×ª×™) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // =========================
    // ğŸ”§ ×”×’×“×¨×•×ª ××¢×¨×›×ª
    // =========================

    // âš ï¸ ×©×™× ××ª ×”×§×•× ×¤×™×’ ×©×œ×š ×›××Ÿ
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ××©×ª××©×™× (×“×•×’××”)
    const USERS = {
      // "username": { password: "1234", name: "×™×©×¨××œ", dept: "×§×• ×§×•×¤×•×ª" }
    };

    const MANAGER = {
      username: "manager",
      password: "1234",
      name: "×× ×”×œ"
    };

    // ××—×œ×§×•×ª ×œ×“×•×’××” + ×›×•×— ××“× (×”×’×“×¨ ×œ×¤×™ ×”×¦×•×¨×š)
    const DEPARTMENTS = {
      "×§×• ×§×•×¤×•×ª": ["×¢×•×‘×“ 1", "×¢×•×‘×“ 2"],
      "×§×˜× ×™×": ["×¢×•×‘×“ 3", "×¢×•×‘×“ 4"],
      "××™×—×©×•×‘": ["×¢×•×‘×“ 5"],
      "××—×¡×Ÿ": ["×¢×•×‘×“ 6"],
      "×§×• ×œ×‘×Ÿ": ["×¢×•×‘×“ 7"]
    };

    let currentUser = null;
    let currentRole = null; // 'employee' | 'manager'

    // =========================
    // ğŸ§° ×¢×–×¨×™×
    // =========================

    function showMessage(text, type = "info", targetId = null) {
      const id = targetId || (currentRole === "manager" ? "mgrMsg" : "empMsg");
      const el = document.getElementById(id);
      if (!el) return;
      el.className = "message " + type;
      el.innerHTML = text;
      el.style.display = "block";
      setTimeout(() => { el.innerHTML = ""; el.style.display = "none"; }, 8000);
    }

    function showLoginMessage(text, type="info") {
      const el = document.getElementById("loginMsg");
      el.className = "message " + type;
      el.innerHTML = text;
      el.style.display = "block";
      setTimeout(() => { el.innerHTML = ""; el.style.display = "none"; }, 8000);
    }

    function fmtDate(d) {
      // d = Date
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseDate(iso) {
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d);
    }

    function isValidWeekday(dateObj) {
      const day = dateObj.getDay(); // 0 Sun .. 6 Sat
      return !(day === 5 || day === 6); // no Fri(5) or Sat(6)
    }

    // =========================
    // ğŸ” ×”×ª×—×‘×¨×•×ª/×”×ª× ×ª×§×•×ª
    // =========================

    function login() {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value;

      if (!u || !p) {
        showLoginMessage("× × ×œ××œ× ×©× ××©×ª××© ×•×¡×™×¡××”", "warn");
        return;
      }

      // ×× ×”×œ?
      if (u === MANAGER.username && p === MANAGER.password) {
        currentUser = { username: MANAGER.username, name: MANAGER.name };
        currentRole = "manager";
        afterLogin();
        return;
      }

      // ×¢×•×‘×“?
      if (USERS[u] && USERS[u].password === p) {
        currentUser = { username: u, ...USERS[u] };
        currentRole = "employee";
        afterLogin();
        return;
      }

      showLoginMessage("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×", "error");
    }

    function afterLogin() {
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("logoutBtn").style.display = "inline-flex";
      document.getElementById("userPill").innerText = `ğŸ‘¤ ${currentUser.name} (${currentRole === "manager" ? "×× ×”×œ" : "×¢×•×‘×“"})`;

      if (currentRole === "employee") {
        document.getElementById("employeeArea").classList.remove("hidden");
        loadMyConstraints();
        loadSchedule();
      } else {
        document.getElementById("managerArea").classList.remove("hidden");
        loadAllConstraints();
        loadSchedule();
      }
    }

    function logout() {
      currentUser = null;
      currentRole = null;
      document.getElementById("loginCard").classList.remove("hidden");
      document.getElementById("employeeArea").classList.add("hidden");
      document.getElementById("managerArea").classList.add("hidden");
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("userPill").innerText = "ğŸ‘¤ ×œ× ××—×•×‘×¨";
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
    }

    // =========================
    // ğŸ‘· ×¢×•×‘×“: ×©×œ×™×—×ª ××™×œ×•×¥
    // =========================

    async function submitConstraint() {
      if (!currentUser) return;

      const date = document.getElementById("constraintDate").value;
      const type = document.getElementById("constraintType").value;
      const time = document.getElementById("constraintTime").value;
      const note = document.getElementById("constraintNote").value.trim();

      if (!date) {
        showMessage("× × ×œ×‘×—×•×¨ ×ª××¨×™×š", "warn", "empMsg");
        return;
      }

      const d = parseDate(date);
      if (!isValidWeekday(d)) {
        showMessage("×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª", "error", "empMsg");
        return;
      }

      if ((type === "until" || type === "from") && !time) {
        showMessage("× × ×œ×‘×—×•×¨ ×©×¢×” ×œ×¡×•×’ ××™×œ×•×¥ ×–×”", "warn", "empMsg");
        return;
      }

      // key = date
      const key = date;

      const payload = {
        date,
        type,
        time: time || null,
        note: note || null,
        status: "pending",
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        createdBy: currentUser.username,
        createdName: currentUser.name,
        dept: currentUser.dept || null
      };

      await db.ref(`constraints/${currentUser.username}/${key}`).set(payload);
      showMessage("×”××™×œ×•×¥ × ×©×œ×— ×‘×”×¦×œ×—×”!", "success", "empMsg");

      document.getElementById("constraintNote").value = "";
      document.getElementById("constraintTime").value = "";

      await loadMyConstraints();
    }

    async function loadMyConstraints() {
      if (!currentUser) return;

      const snap = await db.ref(`constraints/${currentUser.username}`).once("value");
      const data = snap.val() || {};

      const keys = Object.keys(data).sort();
      if (keys.length === 0) {
        document.getElementById("myConstraints").innerHTML = `<div class="muted">××™×Ÿ ××™×œ×•×¦×™× ×›×¨×’×¢.</div>`;
        return;
      }

      let html = "";
      for (const key of keys) {
        const c = data[key];
        html += renderConstraintCard(c, key, false);
      }
      document.getElementById("myConstraints").innerHTML = html;
    }

    function renderConstraintCard(c, key, isManagerView, empUsername = null) {
      const tagClass = c.status || "pending";
      const tagLabel = c.status === "approved" ? "âœ… ××•×©×¨" : c.status === "rejected" ? "âŒ × ×“×—×”" : "â³ ×‘×”××ª× ×”";

      const timeText = c.type === "full"
        ? "×—×•×¤×© ××œ×"
        : c.type === "until"
          ? `×¢×“ ×©×¢×” ${c.time}`
          : `×¨×§ ××©×¢×” ${c.time}`;

      const note = c.note ? `<div class="note">ğŸ“ ${escapeHtml(c.note)}</div>` : "";

      let managerBtns = "";
      if (isManagerView) {
        managerBtns = `
          <div class="actions" style="margin-top:10px;">
            <button class="small-btn approve-btn" onclick="updateApproval('${empUsername}','${key}','approved')">âœ… ××©×¨</button>
            <button class="small-btn reject-btn" onclick="updateApproval('${empUsername}','${key}','rejected')">âŒ ×“×—×”</button>
            <button class="reset-btn" onclick="deleteSingleConstraint('${empUsername}','${key}')">ğŸ—‘ï¸ ××—×§ ××™×œ×•×¥ ×–×”</button>
          </div>
        `;
      }

      return `
        <div class="card" style="margin:10px 0;">
          <div class="row" style="align-items:center;">
            <div style="flex: 2; min-width: 160px; text-align:right;">
              <div style="font-weight:900; font-size:14px;">ğŸ“… ${key}</div>
              <div class="muted">${timeText}</div>
              ${note}
              ${isManagerView ? `<div class="note">ğŸ‘¤ ${escapeHtml(c.createdName || empUsername || "")} ${c.dept ? `â€¢ ğŸ¢ ${escapeHtml(c.dept)}` : ""}</div>` : ``}
            </div>
            <div style="flex: 1; min-width: 120px; text-align:left;">
              <span class="tag ${tagClass}">${tagLabel}</span>
            </div>
          </div>
          ${managerBtns}
        </div>
      `;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // ğŸ§‘â€ğŸ’¼ ×× ×”×œ: ×¦×¤×™×™×” ×•××™×©×•×¨
    // =========================

    async function loadAllConstraints() {
      const snap = await db.ref("constraints").once("value");
      const data = snap.val() || {};

      const employees = Object.keys(data);
      if (employees.length === 0) {
        document.getElementById("allConstraints").innerHTML = `<div class="muted">××™×Ÿ ××™×œ×•×¦×™× ×‘××¢×¨×›×ª.</div>`;
        return;
      }

      // ××•×¡×£ ××™×œ×•×¦×™× ×œ×›×œ×œ ×”×¢×•×‘×“×™× (×¨×§ pending ×‘×¨×™×¨×ª ××—×“×œ, ××‘×œ × ×¨××” ×’× ×”×›×•×œ)
      let list = [];
      for (const emp of employees) {
        const obj = data[emp] || {};
        for (const key of Object.keys(obj)) {
          list.push({ emp, key, c: obj[key] });
        }
      }

      // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
      list.sort((a,b) => (a.key || "").localeCompare(b.key || ""));

      if (list.length === 0) {
        document.getElementById("allConstraints").innerHTML = `<div class="muted">××™×Ÿ ××™×œ×•×¦×™×.</div>`;
        return;
      }

      let html = "";
      for (const item of list) {
        html += renderConstraintCard(item.c, item.key, true, item.emp);
      }

      document.getElementById("allConstraints").innerHTML = html;
    }

    // âœ… ×›××Ÿ ×”×ª×™×§×•×Ÿ: ×œ× ×œ××—×•×§ ×‘×“×—×™×™×”, ××œ× ×œ×©××•×¨ status="rejected"
    async function updateApproval(emp, key, status) {
      const ref = db.ref(`constraints/${emp}/${key}`);

      if (status === 'rejected') {
        // âœ… ×‘××§×•× ×œ××—×•×§ ××ª ×”××™×œ×•×¥ â€“ ×©×•××¨×™× ×¡×˜×˜×•×¡ "× ×“×—×”" (×©×§×™×¤×•×ª + ×”×™×¡×˜×•×¨×™×”)
        await ref.update({
          status: "rejected",
          decidedAt: firebase.database.ServerValue.TIMESTAMP,
          decidedBy: MANAGER.username,
          approvedAt: null,
          approvedBy: null
        });
        showMessage('×‘×§×©×ª ×”×—×•×¤×© × ×“×—×ª×”', 'success');
      } else {
        await ref.update({
          status: "approved",
          approvedAt: firebase.database.ServerValue.TIMESTAMP,
          approvedBy: MANAGER.username,
          decidedAt: firebase.database.ServerValue.TIMESTAMP,
          decidedBy: MANAGER.username
        });
        showMessage('×‘×§×©×ª ×”×—×•×¤×© ××•×©×¨×”!', 'success');
      }

      await loadAllConstraints();
    }

    // âœ… ××—×™×§×ª ××™×œ×•×¥ ×‘×•×“×“ (c1 ××• c2)
    async function deleteSingleConstraint(emp, key){
      const ok = confirm(`×œ××—×•×§ ××ª ${key} ×¢×‘×•×¨ ${emp}?`);
      if(!ok) return;
      await db.ref(`constraints/${emp}/${key}`).set(null);
      showMessage(`${emp} × ××—×§ ${key} ×¢×‘×•×¨`, 'success');
      await loadAllConstraints();
    }

    // =========================
    // ğŸ“¦ ×‘×“×™×§×ª ×”×ª× ×’×©×•×™×•×ª + ×™×¦×™×¨×ª ×¡×™×“×•×¨
    // =========================

    async function getApprovedConstraintsForDate(dateISO) {
      const snap = await db.ref("constraints").once("value");
      const data = snap.val() || {};
      const result = [];

      for (const emp of Object.keys(data)) {
        const c = (data[emp] || {})[dateISO];
        if (!c) continue;
        if (c.status === "approved" && c.approvedAt) {
          result.push({ emp, ...c });
        }
      }
      return result;
    }

    function deptEmployees(dept) {
      return (DEPARTMENTS[dept] || []).slice();
    }

    async function createSchedule() {
      const weekStart = document.getElementById("weekStart").value;
      const daysCount = parseInt(document.getElementById("daysCount").value || "7", 10);

      if (!weekStart) {
        showMessage("× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×”×ª×—×œ×”", "warn", "mgrMsg");
        return;
      }

      const start = parseDate(weekStart);
      if (!isValidWeekday(start)) {
        showMessage("×ª××¨×™×š ×”×ª×—×œ×” ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×©×™×©×™/×©×‘×ª", "error", "mgrMsg");
        return;
      }

      // ×¦×•×¨ ××¢×¨×š ×ª××¨×™×›×™×
      let days = [];
      for (let i=0; i<daysCount; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        if (!isValidWeekday(d)) continue; // ××“×œ×’×™× ×¢×œ ×©×™×©×™/×©×‘×ª
        days.push(fmtDate(d));
      }

      if (days.length === 0) {
        showMessage("×œ× × ××¦××• ×™××™× ×ª×§×™× ×™× ×‘×˜×•×•×—", "error", "mgrMsg");
        return;
      }

      // ×¡×™×“×•×¨ = ××•×‘×™×™×§×˜ ××—×œ×§×” -> ×¢×•×‘×“ -> ×™×•× -> ××©××¨×ª
      // ×›××Ÿ ×“×•×’××” ×‘×¡×™×¡×™×ª: ××’×¨×™×œ ×¢×•×‘×“×™× ×œ×›×œ ×™×•×
      const schedule = [];

      for (const dept of Object.keys(DEPARTMENTS)) {
        const emps = deptEmployees(dept);
        if (emps.length === 0) continue;

        // ×œ×›×œ ××—×œ×§×” × ×™×¦×•×¨ ×¨×©×™××” ×©×œ ×©×•×¨×•×ª (×¢×•×‘×“) ×¢× ×ª××™× ×œ×›×œ ×™×•×
        let rows = [];

        for (const empName of emps) {
          let row = { dept, empName, shifts: {} };

          for (const day of days) {
            // ×‘×“×™×§×ª ××™×œ×•×¦×™× ×××•×©×¨×™× ×¢×œ ×”×ª××¨×™×š
            const approved = await getApprovedConstraintsForDate(day);

            // ×”×× ×œ×¢×•×‘×“ ×”×–×” ×™×© ××™×œ×•×¥ ×××•×©×¨?
            const my = approved.find(a => a.createdName === empName || a.emp === empName || a.emp === getUsernameByName(empName));
            if (my) {
              if (my.type === "full") {
                row.shifts[day] = "×—×•×¤×©";
              } else if (my.type === "until") {
                row.shifts[day] = `×¢×“ ${my.time}`;
              } else if (my.type === "from") {
                row.shifts[day] = `×-${my.time}`;
              }
            } else {
              row.shifts[day] = "×¢×‘×•×“×”";
            }
          }

          rows.push(row);
        }

        schedule.push({ dept, days, rows });
      }

      const payload = {
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        weekStart,
        daysCount,
        schedule
      };

      await db.ref("schedule/latest").set(payload);
      showMessage("âœ… ×”×¡×™×“×•×¨ × ×•×¦×¨ ×•× ×©××¨!", "success", "mgrMsg");
      renderSchedule(schedule, days, "scheduleViewMgr");
      renderSchedule(schedule, days, "scheduleViewEmp");
    }

    function getUsernameByName(name) {
      // ××—×–×™×¨ username ×œ×¤×™ name ××ª×•×š USERS (×× ×§×™×™×)
      for (const u of Object.keys(USERS)) {
        if ((USERS[u].name || "") === name) return u;
      }
      return null;
    }

    async function loadSchedule() {
      const snap = await db.ref("schedule/latest").once("value");
      const data = snap.val();
      if (!data || !data.schedule) {
        const msg = `<div class="muted">××™×Ÿ ×¡×™×“×•×¨ ×©××•×¨.</div>`;
        document.getElementById("scheduleViewMgr").innerHTML = msg;
        document.getElementById("scheduleViewEmp").innerHTML = msg;
        return;
      }
      renderSchedule(data.schedule, (data.schedule[0] && data.schedule[0].days) ? data.schedule[0].days : null, "scheduleViewMgr");
      renderSchedule(data.schedule, (data.schedule[0] && data.schedule[0].days) ? data.schedule[0].days : null, "scheduleViewEmp");
    }

    function renderSchedule(schedule, days, targetId) {
      if (!schedule || schedule.length === 0) {
        document.getElementById(targetId).innerHTML = `<div class="muted">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</div>`;
        return;
      }

      // ×™××™× (××¤×©×¨ ×œ×§×—×ª ××”×¡×™×“×•×¨ ×¢×¦××•)
      const sampleDays = days || (schedule[0] && schedule[0].days) || [];

      let html = "";
      for (const block of schedule) {
        const dept = block.dept;
        const rows = block.rows || [];

        html += `<div style="margin: 10px 0 18px;">`;
        html += `<table>`;
        html += `<thead><tr><th>××—×œ×§×”</th><th>×¢×•×‘×“</th>`;
        for (const d of sampleDays) html += `<th class="mono">${d}</th>`;
        html += `</tr></thead>`;
        html += `<tbody>`;

        html += `<tr class="dept-row"><td colspan="${sampleDays.length + 2}">ğŸ¢ ${dept}</td></tr>`;

        for (const r of rows) {
          html += `<tr>`;
          html += `<td>${dept}</td>`;
          html += `<td>${r.empName}</td>`;
          for (const d of sampleDays) {
            const val = (r.shifts && r.shifts[d]) ? r.shifts[d] : "";
            html += `<td>${escapeHtml(val)}</td>`;
          }
          html += `</tr>`;
        }

        html += `</tbody></table>`;
        html += `</div>`;
      }

      document.getElementById(targetId).innerHTML = html;
    }

    // =========================
    // ğŸ“¤ ×™×™×¦×•× ×œ××§×¡×œ (HTML)
    // =========================

    async function exportToExcel() {
      const snap = await db.ref("schedule/latest").once("value");
      const data = snap.val();
      if (!data || !data.schedule) {
        showMessage("××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×•×", "warn", "mgrMsg");
        return;
      }

      const schedule = data.schedule || [];
      const sampleDays = (schedule[0] && schedule[0].days) ? schedule[0].days : [];

      let html = `
        <html dir="rtl" lang="he">
        <head><meta charset="UTF-8">
          <style>
            body{font-family:Arial; direction:rtl;}
            table{border-collapse:collapse; width:100%;}
            th,td{border:1px solid #ccc; padding:6px; text-align:center;}
            th{background:#eee;}
            .dept-row td{background:#faf5ff; font-weight:700; text-align:right;}
          </style>
        </head>
        <body>
        <h2>×¡×™×“×•×¨ ×¢×‘×•×“×”</h2>
      `;

      schedule.forEach((block, deptIndex) => {
        const dept = block.dept;
        const rows = block.rows || [];

        html += `<table>`;
        html += `<tr><th>××—×œ×§×”</th><th>×¢×•×‘×“</th>`;
        sampleDays.forEach(d => html += `<th>${d}</th>`);
        html += `</tr>`;

        // ×”×¢×¨×”: ×‘×§×•×“ ×”××§×•×¨×™ ×©×•×¨×ª ×”××—×œ×§×” ×”×¨××©×•× ×” ×œ× ×ª××™×“ ×”×•×¤×™×¢×”; ×›××Ÿ × ×©××¨ ×›××• ×”××§×•×¨ ×©×œ×š.
        if (deptIndex > 0) {
          html += `<tr class="dept-row"><td colspan="${sampleDays.length + 2}">ğŸ¢ ${dept}</td></tr>`;
        }

        rows.forEach(r => {
          html += `<tr>`;
          html += `<td>${dept}</td>`;
          html += `<td>${r.empName}</td>`;
          sampleDays.forEach(d => {
            const val = (r.shifts && r.shifts[d]) ? r.shifts[d] : "";
            html += `<td>${escapeHtml(val)}</td>`;
          });
          html += `</tr>`;
        });

        html += `</table><br/>`;
      });

      html += `</body></html>`;

      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "schedule_export.html";
      a.click();

      URL.revokeObjectURL(url);
      showMessage("×”×™×™×¦×•× ×‘×•×¦×¢ (×§×•×‘×¥ HTML ×©×™×™×¤×ª×— ×‘××§×¡×œ)", "success", "mgrMsg");
    }

    // =========================
    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
    // =========================
    // ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ auto-load ××• ×‘×“×™×§×•×ª

  </script>
</body>
</html>
