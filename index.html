<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png">
  <meta name="theme-color" content="#667eea" />
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="./xlsx.bundle.js"></script>


  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container{
      max-width:900px; margin:0 auto; background:white; border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3); padding:30px;
    }
    h1{ text-align:center; color:#667eea; margin-bottom:30px; font-size:2.3em; }
    .section{ display:none; }
    .section.active{ display:block; }

    .btn{
      width:100%; padding:15px; background:#667eea; color:white; border:none;
      border-radius:10px; font-size:18px; font-weight:bold; cursor:pointer;
      transition:all 0.3s; margin-top:10px;
    }
    .btn:hover{ background:#5568d3; transform:translateY(-2px); }

    .mode-btn{
      padding:20px 40px; margin:10px; border:2px solid #667eea; background:white;
      color:#667eea; border-radius:10px; cursor:pointer; font-size:20px;
      font-weight:bold; transition:all 0.3s;
    }
    .mode-btn:hover{ background:#667eea; color:white; }

    input, select{
      width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px;
      font-size:16px; margin-top:8px;
    }
    .form-group{ margin-bottom:15px; }
    label{ display:block; margin-bottom:5px; font-weight:bold; color:#555; }

    .constraint-item{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border:2px solid #e0e0e0;
    }
    .constraint-card{ background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:10px; }

    .message{
      padding:15px; border-radius:8px; margin-top:20px; text-align:center;
      font-weight:bold; white-space:pre-line;
    }
    .message.success{ background:#d4edda; color:#155724; }
    .message.error{ background:#f8d7da; color:#721c24; }

    .employee-constraints{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border-right:4px solid #667eea;
    }

    .schedule-table{
      width:100%;
      margin-top:20px;
      border-collapse:collapse;
      background:white;
      border-radius:8px;
      overflow:hidden;
    }
    .schedule-table th{
      background:#667eea;
      color:white;
      padding:15px 10px;
      text-align:center;
      font-size:14px;
      min-width:100px;
    }
    .schedule-table td{
      padding:15px 10px;
      text-align:center;
      border:1px solid #e0e0e0;
      vertical-align:middle;
      min-width:100px;
    }

    .shift-morning, .shift-middle, .shift-evening, .shift-friday, .shift-saturday{
      display:inline-block; padding:8px 12px; border-radius:6px;
      font-size:13px; font-weight:bold; line-height:1.6;
    }
    .shift-morning{ background:#fff3cd; }
    .shift-middle{ background:#ffd4a3; }
    .shift-evening{ background:#d1ecf1; }
    .shift-friday{ background:#d4edda; }
    .shift-saturday{ background:#e7d4f5; }

    

    .shift-double{ background:#f8cbad; font-weight:bold; }
.approval-buttons{ display:inline-flex; gap:10px; margin-right:10px; flex-wrap:wrap; }
    .approve-btn, .reject-btn, .reset-btn{
      padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
    }
    .approve-btn{ background:#28a745; color:white; }
    .reject-btn{ background:#dc3545; color:white; }
    .reset-btn{ background:#6c757d; color:white; }

    .status-pending, .status-approved, .status-rejected{
      padding:5px 12px; border-radius:20px; font-size:14px; display:inline-block; margin-right:8px;
    }
    .status-pending{ background:#fff3cd; color:#856404; }
    .status-approved{ background:#d4edda; color:#155724; }
    .status-rejected{ background:#f8d7da; color:#721c24; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 20px 0;
    }
    .toolbar .btn{ width:auto; padding:10px 14px; font-size:14px; margin-top:0; }

    .dept-divider td{
      background:#667eea !important;
      color:#fff !important;
      font-weight:900;
      text-align:center !important;
      font-size:16px;
      padding:12px !important;
      border:0 !important;
      letter-spacing:.3px;
    }

    .emp-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .emp-header-row h4{
      margin:0;
    }
    .emp-header-row .reset-btn{
      white-space:nowrap;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- Login Screen -->
  <div id="login-screen" class="section active">
    <h1>ğŸ—“ï¸ ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h1>
    <div style="text-align:center; margin-top:40px;">
      <button class="mode-btn" onclick="showLoginForm('employee')">ğŸ‘¤ ×›× ×™×¡×ª ×¢×•×‘×“</button>
      <button class="mode-btn" onclick="showLoginForm('manager')">ğŸ‘” ×›× ×™×¡×ª ×× ×”×œ</button>
    </div>
  </div>

  <!-- Employee Login -->
  <div id="employee-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×¢×•×‘×“</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="emp-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="emp-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginEmployee()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Manager Login -->
  <div id="manager-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×× ×”×œ</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="mgr-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="mgr-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginManager()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Employee Section -->
  <div id="employee-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h1>ğŸ—“ï¸ ××©××¨×•×ª</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>
    <h2 id="employee-welcome" style="color:#667eea; text-align:center; margin-bottom:30px;"></h2>

    <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
      <h3>×”×’×“×¨×ª ××™×œ×•×¦×™× (×¢×“ 2)</h3>
      <p style="color:#e74c3c; margin:10px 0;">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ××•×¦"×©</p>

      <div class="constraint-item">
        <h4>××™×œ×•×¥ 1</h4>
        <div class="form-group">
          <label>×ª××¨×™×š:</label>
          <input type="date" id="c1-date">
        </div>
        <div class="form-group">
          <label>×¡×•×’:</label>
          <select id="c1-type">
            <option value="">-- ×‘×—×¨ --</option>
            <option value="no-morning">×œ× ×‘×•×§×¨</option>
            <option value="no-evening">×œ× ×¢×¨×‘</option>
            <option value="day-off">×—×•×¤×© ××œ×</option>
          </select>
        </div>
      </div>

      <div class="constraint-item">
        <h4>××™×œ×•×¥ 2</h4>
        <div class="form-group">
          <label>×ª××¨×™×š:</label>
          <input type="date" id="c2-date">
        </div>
        <div class="form-group">
          <label>×¡×•×’:</label>
          <select id="c2-type">
            <option value="">-- ×‘×—×¨ --</option>
            <option value="no-morning">×œ× ×‘×•×§×¨</option>
            <option value="no-evening">×œ× ×¢×¨×‘</option>
            <option value="day-off">×—×•×¤×© ××œ×</option>
          </select>
        </div>
      </div>

      <button class="btn" onclick="saveConstraints()">×©××•×¨ ××™×œ×•×¦×™×</button>
    </div>

    <div id="my-constraints" style="margin-top:20px;"></div>
  </div>

  <!-- Manager Section -->
  <div id="manager-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h1>ğŸ—“ï¸ ×¤×× ×œ ×× ×”×œ</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="refreshAll()" style="background:#343a40;">ğŸ” ×¨×¢× ×Ÿ ×”×›×œ</button>
      <button class="btn" onclick="loadAllConstraints()" style="background:#17a2b8;">ğŸ”„ ×¨×¢× ×Ÿ ××™×œ×•×¦×™×</button>
      <button class="btn" onclick="generateSchedule()" style="background:#667eea;">ğŸ”„ ×¨×¢× ×Ÿ ×¡×™×“×•×¨</button>
      <button class="btn" onclick="resetAllConstraints()" style="background:#6c757d;">ğŸ§¹ ××™×¤×•×¡ ××™×œ×•×¦×™× ×œ×›×œ ×”×¢×•×‘×“×™×</button>
    </div>

    <div id="all-constraints"></div>

    <button class="btn" onclick="generateSchedule()">×¦×•×¨ ×¡×™×“×•×¨ ××•×˜×•××˜×™</button>

    <div id="export-section" style="display:none; margin-top:10px;">
      <button class="btn" onclick="exportToExcel()" style="background:#28a745;">ğŸ“Š ×™×™×¦× ×œ-Excel</button>
      <button class="btn" onclick="exportToHTML()" style="background:#17a2b8;">ğŸ“„ ×™×™×¦× ×œ-HTML ××¢×•×¦×‘</button>
    </div>

    <div id="schedule-result"></div>
  </div>

  <div id="message"></div>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD-uaQ2aO87kGxbcc-m8_9fzJ3uhPv2zvk",
    authDomain: "shift-manager-c026e.firebaseapp.com",
    databaseURL: "https://shift-manager-c026e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "shift-manager-c026e",
    storageBucket: "shift-manager-c026e.firebasestorage.app",
    messagingSenderId: "1091605398341",
    appId: "1:1091605398341:web:cb6c14e7d832c3e8df342c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentEmployee = '';
  let currentSchedule = null;

  const USERS = {
    'ILAY': 'ILAY',
    'ROVEN': 'ROVEN',
    'HAI': 'HAI',
    'NATALI': 'NATALI',
    'INNA': 'INNA',
    'TAMIR': 'TAMIR',
    'ELIYA': 'ELIYA',
    'LIOR': 'LIOR',
    'AMANI': 'AMANI',
    'SHIROT': 'SHIROT',
    'AVI': 'AVI',
    'MOHAMAD': 'MOHAMAD'
  };

  const DEPARTMENTS = {
    '××—×œ×§×ª ××™×—×©×•×‘': ['ILAY', 'ROVEN'],
    '××—×œ×§×ª ×§×˜× ×™×': ['HAI', 'NATALI'],
    '××—×œ×§×ª ××—×¡× ××™×': ['AVI', 'MOHAMAD'],
    '××—×œ×§×ª ×§×• ×œ×‘×Ÿ': ['INNA', 'TAMIR', 'ELIYA'],
    '× ×¦×™×’×•×ª ×©×™×¨×•×ª': ['LIOR', 'AMANI', 'SHIROT']
  };

  // ××™×¤×•×™ ×©××•×ª ×ª×¦×•×’×” ×‘×¢×‘×¨×™×ª (×¨×§ ×œ×ª×¦×•×’×” ×‘×˜×‘×œ×”!)
  const DISPLAY_NAMES = {
    'ILAY': '×¢×™×œ××™',
    'ROVEN': '×¨××•×‘×Ÿ',
    'HAI': '×—×™',
    'NATALI': '× ×˜×œ×™',
    'AVI': '××‘×™',
    'MOHAMAD': '××•×—××“',
    'INNA': '××™× ×”',
    'TAMIR': '×ª××™×¨',
    'ELIYA': '××œ×™×”',
    'LIOR': '×œ×™××•×¨',
    'AMANI': '×××× ×™',
    'SHIROT': '×©×™×¨×•×ª'
  };

  const MANAGER = { username: 'SAGI', password: '102' };

  // ======== ×”×ª×××ª ××¤×©×¨×•×™×•×ª ××™×œ×•×¥ ×œ×¤×™ ××—×œ×§×” ========
  function getDeptOfEmp(emp) {
    for (const [dept, list] of Object.entries(DEPARTMENTS)) {
      if (list.includes(emp)) return dept;
    }
    return null;
  }

  function buildConstraintOptionsForEmp(emp) {
    const dept = getDeptOfEmp(emp);
    const size = dept ? (DEPARTMENTS[dept]?.length || 0) : 0;

    if (size === 3) {
      return [
        { value: "", label: "-- ×‘×—×¨ --" },
        { value: "want-morning", label: "âœ… ×¨×•×¦×” ×‘×•×§×¨" },
        { value: "want-middle",  label: "âœ… ×¨×•×¦×” ×××¦×¢" },
        { value: "want-evening", label: "âœ… ×¨×•×¦×” ×¢×¨×‘" },
        { value: "day-off",      label: "ğŸ–ï¸ ×—×•×¤×© ××œ×" }
      ];
    }

    return [
      { value: "", label: "-- ×‘×—×¨ --" },
      { value: "no-morning", label: "âŒ ×œ× ×‘×•×§×¨" },
      { value: "no-evening", label: "âŒ ×œ× ×¢×¨×‘" },
      { value: "day-off",    label: "ğŸ–ï¸ ×—×•×¤×© ××œ×" }
    ];
  }

  function applyConstraintOptions(emp) {
    const options = buildConstraintOptionsForEmp(emp);

    ["c1-type", "c2-type"].forEach(id => {
      const sel = document.getElementById(id);
      const current = sel.value;
      sel.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join("");
      if (options.some(o => o.value === current)) sel.value = current;
    });
  }

  function showLoginForm(type) {
    hideAll();
    document.getElementById(type + '-login').classList.add('active');
  }

  function backToLogin() {
    hideAll();
    document.getElementById('login-screen').classList.add('active');
    clearInputs();
  }

  function logout() {
    currentEmployee = '';
    backToLogin();
    showMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”', 'success');
  }

  function loginEmployee() {
    const username = document.getElementById('emp-username').value.trim().toUpperCase();
    const password = document.getElementById('emp-password').value.trim();

    if (!username || !password) return showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');

    if (USERS[username] && USERS[username] === password) {
      currentEmployee = username;

      hideAll();
      document.getElementById('employee-section').classList.add('active');
      document.getElementById('employee-welcome').textContent = `×©×œ×•× ${username}! ğŸ‘‹`;

      applyConstraintOptions(currentEmployee);

      loadEmployeeConstraints();
      showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  function loginManager() {
    const username = document.getElementById('mgr-username').value.trim().toUpperCase();
    const password = document.getElementById('mgr-password').value.trim();

    if (!username || !password) return showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');

    if (username === MANAGER.username && password === MANAGER.password) {
      hideAll();
      document.getElementById('manager-section').classList.add('active');
      loadAllConstraints();
      showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  async function loadEmployeeConstraints() {
    if (currentEmployee) applyConstraintOptions(currentEmployee);

    const snapshot = await db.ref('constraints/' + currentEmployee).once('value');
    const data = snapshot.val() || {};

    document.getElementById('c1-date').value = data.c1?.date || '';
    document.getElementById('c1-type').value = data.c1?.type || '';

    document.getElementById('c2-date').value = data.c2?.date || '';
    document.getElementById('c2-type').value = data.c2?.type || '';

    displayMyConstraints(data);
  }

  async function saveConstraints() {
    if (!currentEmployee) return;

    const c1Date = document.getElementById('c1-date').value;
    const c1Type = document.getElementById('c1-type').value;
    const c2Date = document.getElementById('c2-date').value;
    const c2Type = document.getElementById('c2-type').value;

    if (c1Date && !isValidWeekday(c1Date)) return showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error');
    if (c2Date && !isValidWeekday(c2Date)) return showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error');

    const constraints = {};
    if (c1Date && c1Type) constraints.c1 = { date: c1Date, type: c1Type, status: c1Type === 'day-off' ? 'pending' : 'approved' };
    if (c2Date && c2Type) constraints.c2 = { date: c2Date, type: c2Type, status: c2Type === 'day-off' ? 'pending' : 'approved' };

    await db.ref('constraints/' + currentEmployee).set(constraints);

    const hasDayOff = c1Type === 'day-off' || c2Type === 'day-off';
    showMessage(hasDayOff ? '× ×©××¨! ×‘×§×©×•×ª ×—×•×¤×© ×××ª×™× ×•×ª ×œ××™×©×•×¨' : '× ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
    displayMyConstraints(constraints);
  }

  function displayMyConstraints(data) {
    const today = new Date(); today.setHours(0,0,0,0);
    let html = '<h3 style="color:#667eea;">×”××™×œ×•×¦×™× ×©×œ×™:</h3>';
    let hasValid = false;

    if (data.c1 && new Date(data.c1.date + 'T00:00:00') >= today) {
      html += `<div class="constraint-card"><strong>××™×œ×•×¥ 1:</strong> ${formatDate(data.c1.date)} - ${formatType(data.c1.type)} ${getStatusBadge(data.c1)}</div>`;
      hasValid = true;
    }
    if (data.c2 && new Date(data.c2.date + 'T00:00:00') >= today) {
      html += `<div class="constraint-card"><strong>××™×œ×•×¥ 2:</strong> ${formatDate(data.c2.date)} - ${formatType(data.c2.type)} ${getStatusBadge(data.c2)}</div>`;
      hasValid = true;
    }
    if (!hasValid) html += '<p style="color:#28a745;">××™×Ÿ ××™×œ×•×¦×™× ×¢×ª×™×“×™×™×</p>';
    document.getElementById('my-constraints').innerHTML = html;
  }

  async function loadAllConstraints() {
    const snapshot = await db.ref('constraints').once('value');
    const allData = snapshot.val() || {};
    const today = new Date(); today.setHours(0,0,0,0);

    let html = '<h2>××™×œ×•×¦×™ ×”×¢×•×‘×“×™×</h2>';

    for (const [dept, employees] of Object.entries(DEPARTMENTS)) {
      html += `<div style="background:#f0f0f0; padding:15px; border-radius:10px; margin-bottom:20px;">
        <h3 style="color:#667eea;">ğŸ¢ ${dept}</h3>`;

      employees.forEach(emp => {
        const data = allData[emp];

        html += `<div class="employee-constraints">`;

        html += `
          <div class="emp-header-row">
            <h4>${emp}</h4>
            <button class="reset-btn" onclick="resetEmployeeConstraints('${emp}')">ğŸ§¹ ××™×¤×•×¡ ××™×œ×•×¦×™× ×œ×¢×•×‘×“</button>
          </div>
        `;

        let hasValid = false;

        if (data?.c1 && new Date(data.c1.date + 'T00:00:00') >= today) { html += formatConstraintForManager(emp,'c1',data.c1); hasValid = true; }
        if (data?.c2 && new Date(data.c2.date + 'T00:00:00') >= today) { html += formatConstraintForManager(emp,'c2',data.c2); hasValid = true; }

        if (!hasValid) html += '<p style="color:#28a745;">âœ… ××™×Ÿ ××™×œ×•×¦×™×</p>';

        html += '</div>';
      });

      html += '</div>';
    }

    document.getElementById('all-constraints').innerHTML = html;
  }

  function formatConstraintForManager(emp, key, c) {
    let html = `<div style="margin:10px 0; padding:10px; background:#f8f9fa; border-radius:6px;">
      ğŸ“Œ ${formatDate(c.date)} - ${formatType(c.type)}`;

    if (c.type === 'day-off') {
      const status = c.status || 'pending';
      if (status === 'pending') {
        html += `<div class="approval-buttons">
          <button class="approve-btn" onclick="updateApproval('${emp}','${key}','approved')">âœ… ××©×¨</button>
          <button class="reject-btn" onclick="updateApproval('${emp}','${key}','rejected')">âŒ ×“×—×”</button>
        </div>
        <span class="status-pending">â³ ×××ª×™×Ÿ</span>`;
      } else if (status === 'approved') {
        html += `<span class="status-approved">âœ… ×××•×©×¨</span>`;
      } else {
        html += `<span class="status-rejected">âŒ × ×“×—×”</span>`;
      }
    } else {
      html += `<span class="status-approved">âœ… ×¤×¢×™×œ</span>`;
    }

    html += `
      <div class="approval-buttons" style="margin-top:8px;">
        <button class="reset-btn" onclick="deleteSingleConstraint('${emp}','${key}')">ğŸ—‘ï¸ ××—×§ ××™×œ×•×¥ ×–×”</button>
      </div>
    `;

    return html + `</div>`;
  }

  async function updateApproval(emp, key, status) {
    if (status === 'rejected') {
      await db.ref(`constraints/${emp}/${key}`).set(null);
      showMessage('×‘×§×©×ª ×”×—×•×¤×© × ×“×—×ª×” ×•× ××—×§×”', 'success');
    } else {
      await db.ref(`constraints/${emp}/${key}`).update({
        status: "approved",
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: MANAGER.username
      });
      showMessage('×‘×§×©×ª ×”×—×•×¤×© ××•×©×¨×”!', 'success');
    }
    await loadAllConstraints();
  }

  async function deleteSingleConstraint(emp, key){
    const ok = confirm(`×œ××—×•×§ ××ª ${key} ×¢×‘×•×¨ ${emp}?`);
    if(!ok) return;
    await db.ref(`constraints/${emp}/${key}`).set(null);
    showMessage(`× ××—×§ ${key} ×¢×‘×•×¨ ${emp}`, 'success');
    await loadAllConstraints();

    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';
  }

  async function resetEmployeeConstraints(emp){
    const ok = confirm(`×œ××¤×¡ ××ª ×›×œ ×”××™×œ×•×¦×™× ×©×œ ${emp}? (×™××—×§ c1+c2)`);
    if(!ok) return;

    await db.ref(`constraints/${emp}`).set(null);
    showMessage(`××•×¤×¡×• ×”××™×œ×•×¦×™× ×©×œ ${emp}`, 'success');

    await loadAllConstraints();

    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';
  }

  async function resetAllConstraints() {
    const ok = confirm(`×œ××¤×¡ ××™×œ×•×¦×™× ×œ×›×œ ×”×¢×•×‘×“×™×? ×¤×¢×•×œ×” ×–×• ××•×—×§×ª ××ª ×›×œ ×”××™×œ×•×¦×™×.`);
    if (!ok) return;

    await db.ref(`constraints`).set(null);
    showMessage(`×›×œ ×”××™×œ×•×¦×™× ××•×¤×¡×•`, 'success');

    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';

    await loadAllConstraints();
  }

  async function refreshAll(){
    await loadAllConstraints();
    await generateSchedule();
  }

  async function generateSchedule() {
    try {
      const snapshot = await db.ref('constraints').once('value');
      const constraints = snapshot.val() || {};

      const conflicts = checkConflicts(constraints);
      const schedule = await createSchedule(constraints);

      if (conflicts.length > 0) {
        let msg = 'âš ï¸ ×§×•× ×¤×œ×™×§×˜×™×:\n\n';
        conflicts.forEach(c => { msg += `ğŸ¢ ${c.dept}\nğŸ“… ${formatDate(c.date)}: ${c.emps.join(' ×•-')} - ${c.desc}\n\n`; });
        showMessage(msg, 'error');
        document.getElementById('schedule-result').innerHTML = `<div class="message error">${msg}</div>`;
        document.getElementById('export-section').style.display = 'none';
        return;
      }

      currentSchedule = schedule;
      displaySchedule(schedule);
      document.getElementById('export-section').style.display = 'block';
      showMessage('×”×¡×™×“×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');

    } catch (error) {
      console.error(error);
      showMessage(error.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×“×•×¨', 'error');
      document.getElementById('schedule-result').innerHTML =
        `<div class="message error">${error.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×“×•×¨'}</div>`;
      document.getElementById('export-section').style.display = 'none';
    }
  }

  function checkConflicts(constraints) {
    const conflicts = [];
    const today = new Date(); today.setHours(0,0,0,0);

    const isApprovedForScheduling = (c) => {
      if (!c) return false;
      if (new Date(c.date + 'T00:00:00') < today) return false;

      if (c.type === 'day-off') {
        return c.status === 'approved' && !!c.approvedAt;
      }
      return !c.status || c.status === 'approved';
    };

    for (const [dept, emps] of Object.entries(DEPARTMENTS)) {
      const allDates = [];

      emps.forEach(emp => {
        const data = constraints[emp];
        if (!data) return;

        const addIfApproved = (c) => {
          if (!isApprovedForScheduling(c)) return;
          allDates.push({ emp, ...c });
        };

        addIfApproved(data.c1);
        addIfApproved(data.c2);
      });

      const byDate = {};
      allDates.forEach(c => { (byDate[c.date] ||= []).push(c); });

      Object.entries(byDate).forEach(([date, dateConstraints]) => {
        const dayOffCount = dateConstraints.filter(c => c.type === 'day-off').length;

        const noMorningCount = dateConstraints.filter(c => c.type === 'no-morning' || c.type === 'day-off').length;
        const noEveningCount = dateConstraints.filter(c => c.type === 'no-evening' || c.type === 'day-off').length;

        if (emps.length === 3) {
          if (dayOffCount >= 2) {
            conflicts.push({
              dept, date,
              emps: dateConstraints.filter(c => c.type === 'day-off').map(c => c.emp),
              desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×™×§×© ×—×•×¤×©'
            });
          }

          const wantMorning = dateConstraints.filter(c => c.type === 'want-morning').map(c => c.emp);
          const wantMiddle  = dateConstraints.filter(c => c.type === 'want-middle').map(c => c.emp);
          const wantEvening = dateConstraints.filter(c => c.type === 'want-evening').map(c => c.emp);

          if (wantMorning.length > 1) conflicts.push({ dept, date, emps: wantMorning, desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×—×¨ ××©××¨×ª ×‘×•×§×¨' });
          if (wantMiddle.length  > 1) conflicts.push({ dept, date, emps: wantMiddle,  desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×—×¨ ××©××¨×ª ×××¦×¢' });
          if (wantEvening.length > 1) conflicts.push({ dept, date, emps: wantEvening, desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×—×¨ ××©××¨×ª ×¢×¨×‘' });

        } else {
          if (dayOffCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×‘×™×§×©×• ×—×•×¤×©' });
          else if (noMorningCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×‘×•×§×¨' });
          else if (noEveningCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×¢×¨×‘' });
        }
      });
    }

    return conflicts;
  }

  async function createSchedule(constraints) {
    const today = new Date(); today.setHours(0,0,0,0);
    const nextSunday = new Date(today);
    const dow = today.getDay();
    nextSunday.setDate(today.getDate() + (dow === 0 ? 0 : 7 - dow));

    const allSchedules = {};

    // ×§×¨×™××ª ×”×™×¡×˜×•×¨×™×™×ª ××•×¦"×© ×-Firebase
    const historySnapshot = await db.ref('saturdayHistory').once('value');
    const saturdayHistory = historySnapshot.val() || {};

    const isApprovedForScheduling = (c) => {
      if (!c) return false;
      if (new Date(c.date + 'T00:00:00') < today) return false;

      if (c.type === 'day-off') {
        return c.status === 'approved' && !!c.approvedAt;
      }
      return !c.status || c.status === 'approved';
    };

    const getApprovedConstraintOnDate = (emp, dateStr) => {
      const data = constraints[emp];
      if (!data) return null;
      const c1 = data.c1 && isApprovedForScheduling(data.c1) && data.c1.date === dateStr ? data.c1 : null;
      const c2 = data.c2 && isApprovedForScheduling(data.c2) && data.c2.date === dateStr ? data.c2 : null;
      return c1 || c2;
    };

    const isDayOffApproved = (emp, dateStr) => {
      const c = getApprovedConstraintOnDate(emp, dateStr);
      return c && c.type === 'day-off';
    };

    const getWantedShift = (emp, dateStr) => {
      const c = getApprovedConstraintOnDate(emp, dateStr);
      if (!c) return null;
      if (c.type === 'want-morning') return 'morning';
      if (c.type === 'want-middle')  return 'middle';
      if (c.type === 'want-evening') return 'evening';
      return null;
    };

    const cannotMorning = (emp, dateStr) => {
      const c = getApprovedConstraintOnDate(emp, dateStr);
      return !!c && (c.type === 'no-morning' || c.type === 'day-off');
    };
    const cannotEvening = (emp, dateStr) => {
      const c = getApprovedConstraintOnDate(emp, dateStr);
      return !!c && (c.type === 'no-evening' || c.type === 'day-off');
    };

    for (const [dept, emps] of Object.entries(DEPARTMENTS)) {
      const schedule = [];
      const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
      const isThreeEmp = emps.length === 3;

      // âœ… NEW: ××•× ×” ××©××¨×•×ª ×œ×›×œ ×¢×•×‘×“ ×œ××¢×Ÿ ×”×•×’× ×•×ª
      const shiftCounts = {};
      emps.forEach(emp => { shiftCounts[emp] = { morning: 0, middle: 0, evening: 0 }; });

      // ×¤×•× ×§×¦×™×” ×œ×‘×—×™×¨×ª ×¢×•×‘×“ ×¢× ×”×›×™ ×¤×—×•×ª ××©××¨×•×ª ××¡×•×’ ××¡×•×™×
      const pickLeastBurdenedEmp = (availableEmps, shift) => {
        if (!availableEmps || availableEmps.length === 0) return null;
        
        // ××™×•×Ÿ ×œ×¤×™ ××¡×¤×¨ ××©××¨×•×ª ××¡×•×’ ×–×”
        const sorted = availableEmps.slice().sort((a, b) => {
          const countA = shiftCounts[a][shift];
          const countB = shiftCounts[b][shift];
          if (countA !== countB) return countA - countB;
          // ×©×•×‘×¨ ×©×•×•×™×•×Ÿ - ××™ ×©×™×© ×œ×• ×¤×—×•×ª ××©××¨×•×ª ×‘×›×œ×œ
          const totalA = shiftCounts[a].morning + shiftCounts[a].middle + shiftCounts[a].evening;
          const totalB = shiftCounts[b].morning + shiftCounts[b].middle + shiftCounts[b].evening;
          if (totalA !== totalB) return totalA - totalB;
          // ×©×•×‘×¨ ×©×•×•×™×•×Ÿ × ×•×¡×£ - ×¨× ×“×•××œ×™!
          return Math.random() - 0.5;
        });
        
        // ×× ×™×© ×›××” ×¢×•×‘×“×™× ×¢× ××•×ª×• ××¡×¤×¨ ××©××¨×•×ª, ×‘×—×¨ ×¨× ×“×•××œ×™×ª ×‘×™× ×™×”×
        const minCount = shiftCounts[sorted[0]][shift];
        const candidates = sorted.filter(emp => shiftCounts[emp][shift] === minCount);
        
        if (candidates.length > 1) {
          // ×‘×—×¨ ×¨× ×“×•××œ×™×ª ××‘×™×Ÿ ×”××•×¢××“×™×
          return candidates[Math.floor(Math.random() * candidates.length)];
        }
        
        return sorted[0];
      };

      for (let i=0;i<5;i++) {
        const date = new Date(nextSunday);
        date.setDate(nextSunday.getDate() + i);
        const dateStr = toLocalDateStr(date);

        if (isThreeEmp) {
          const dayOffs = emps.filter(emp => isDayOffApproved(emp, dateStr));

          if (dayOffs.length === 1) {
            // ×¢×•×‘×“ ××—×“ ×‘×—×•×¤×© - ×¨×§ 2 ×¢×•×‘×“×™× ×¢×•×‘×“×™× (×‘×•×§×¨ + ×¢×¨×‘)
            const working = emps.filter(emp => !dayOffs.includes(emp));
            
            const morningEmp = pickLeastBurdenedEmp(working, 'morning');
            const eveningEmp = working.filter(e => e !== morningEmp)[0];
            
            schedule.push({ day: days[i], date: dateStr, morning: morningEmp, evening: eveningEmp, dept });
            
            shiftCounts[morningEmp].morning++;
            shiftCounts[eveningEmp].evening++;

          } else {
            // ×™×•× ×¨×’×™×œ - 3 ××©××¨×•×ª
            
            // ×‘×“×™×§×” ×× ×™×© ×‘×—×™×¨×•×ª "×¨×•×¦×” ××©××¨×ª"
            const wanted = { morning: null, middle: null, evening: null };
            for (const emp of emps) {
              const w = getWantedShift(emp, dateStr);
              if (w) wanted[w] = emp;
            }

            const used = new Set();
            const assign = { morning: null, middle: null, evening: null };

            // ×§×•×“× ×›×œ ××›×‘×“×™× ××ª ×”×‘×—×™×¨×•×ª
            for (const shift of ['morning', 'middle', 'evening']) {
              if (wanted[shift]) {
                assign[shift] = wanted[shift];
                used.add(wanted[shift]);
              }
            }

            // ×¢×›×©×™×• ××©×œ×™××™× ××©××¨×•×ª ×—×¡×¨×•×ª ×‘×¦×•×¨×” ×”×•×’× ×ª
            const availableEmps = emps.filter(e => !used.has(e));
            
            for (const shift of ['morning', 'middle', 'evening']) {
              if (!assign[shift]) {
                const emp = pickLeastBurdenedEmp(availableEmps, shift);
                if (emp) {
                  assign[shift] = emp;
                  availableEmps.splice(availableEmps.indexOf(emp), 1);
                  used.add(emp);
                }
              }
            }

            schedule.push({ day: days[i], date: dateStr, morning: assign.morning, middle: assign.middle, evening: assign.evening, dept });
            
            // ×¢×“×›×•×Ÿ ××•× ×™×
            shiftCounts[assign.morning].morning++;
            shiftCounts[assign.middle].middle++;
            shiftCounts[assign.evening].evening++;
          }

        } else {
          // 2 ×¢×•×‘×“×™×
          const a = emps[0], b = emps[1];
          const aOff = isDayOffApproved(a, dateStr);
          const bOff = isDayOffApproved(b, dateStr);

          if (aOff && !bOff) schedule.push({ day: days[i], date: dateStr, morning: b, evening: b, dept });
          else if (bOff && !aOff) schedule.push({ day: days[i], date: dateStr, morning: a, evening: a, dept });
          else {
            const m = (i % 2 === 0) ? a : b;
            const e = (m === a) ? b : a;

            const mCant = cannotMorning(m, dateStr);
            const eCant = cannotEvening(e, dateStr);

            let morning = mCant ? e : m;
            let evening = eCant ? m : e;

            if (morning === evening) {
              if (mCant && !cannotEvening(m, dateStr)) {
                evening = m;
              } else if (eCant && !cannotMorning(e, dateStr)) {
                morning = e;
              }
            }

            schedule.push({ day: days[i], date: dateStr, morning, evening, dept });
          }
        }
      }

      // ×©×™×©×™ ×•×©×‘×ª - ×¨×•×˜×¦×™×” ×¢× ×©××™×¨×” ×‘-Firebase
      const fri = new Date(nextSunday); fri.setDate(nextSunday.getDate() + 5);
      const friStr = toLocalDateStr(fri);
      const sat = new Date(nextSunday); sat.setDate(nextSunday.getDate() + 6);
      const satStr = toLocalDateStr(sat);

      if (isThreeEmp) {
        const friOff = emps.find(emp => isDayOffApproved(emp, friStr));
        const satOff = emps.find(emp => isDayOffApproved(emp, satStr));
        
        let satWorking = null;

        if (satOff) {
          // ×™×© ×¢×•×‘×“ ×‘×—×•×¤×© ×‘×©×‘×ª
          const available = emps.filter(e => e !== satOff);
          
          // ×‘×“×™×§×” ×× ××™ ×©×¢×‘×“ ×‘×¤×¢× ×”×§×•×“××ª ×–××™×Ÿ
          const lastSatEmp = saturdayHistory[dept];
          if (lastSatEmp && available.includes(lastSatEmp)) {
            // ×”×¢×•×‘×“ ×”×§×•×“× ×–××™×Ÿ - ×‘×•×—×¨ ××ª ×”×©× ×™
            const nextIndex = (available.indexOf(lastSatEmp) + 1) % available.length;
            satWorking = available[nextIndex];
          } else {
            // ×”×¢×•×‘×“ ×”×§×•×“× ×œ× ×–××™×Ÿ - ×‘×•×—×¨ ×¨× ×“×•××œ×™×ª
            satWorking = available[Math.floor(Math.random() * available.length)];
          }
        } else {
          // ××™×Ÿ ×—×•×¤×© - ×¨×•×˜×¦×™×” ×¨×’×™×œ×”
          const lastSatEmp = saturdayHistory[dept];
          
          if (lastSatEmp && emps.includes(lastSatEmp)) {
            // ×™×© ×”×™×¡×˜×•×¨×™×” - ×‘×•×—×¨ ××ª ×”×‘× ×‘×ª×•×¨
            const currentIndex = emps.indexOf(lastSatEmp);
            const nextIndex = (currentIndex + 1) % emps.length;
            satWorking = emps[nextIndex];
          } else {
            // ××™×Ÿ ×”×™×¡×˜×•×¨×™×” - ×¡×™×“×•×¨ ×¨××©×•×Ÿ, ×‘×•×—×¨ ×¨× ×“×•××œ×™×ª
            satWorking = emps[Math.floor(Math.random() * emps.length)];
          }
        }

        // ×©××™×¨×ª ××™ ×¢×‘×“ ×‘××•×¦"×© ×”×¤×¢×
        saturdayHistory[dept] = satWorking;

        // ×©×™×©×™ - ××™ ×©×œ× ×¢×•×‘×“ ×‘×©×‘×ª
        let friWorking;
        if (friOff) {
          // ×™×© ×—×•×¤×© ×‘×©×™×©×™ - ×”×©× ×™×™× ×”××—×¨×™×
          friWorking = emps.filter(x => x !== friOff);
        } else {
          // ××™×Ÿ ×—×•×¤×© - ××™ ×©×œ× ×¢×•×‘×“ ×‘×©×‘×ª
          friWorking = emps.filter(e => e !== satWorking);
        }

        schedule.push({ day:'×©×™×©×™', date: friStr, friday: friWorking, dept });
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satWorking, dept });
        
      } else {
        // 2 ×¢×•×‘×“×™× - ×¨×•×˜×¦×™×” ×›××• 3 ×¢×•×‘×“×™×!
        const a = emps[0], b = emps[1];
        const friOff = emps.find(emp => isDayOffApproved(emp, friStr));
        const satOff = emps.find(emp => isDayOffApproved(emp, satStr));
        
        let satWorking = null;

        if (satOff) {
          // ×™×© ×—×•×¤×© ×‘×©×‘×ª - ×”×©× ×™ ×¢×•×‘×“
          satWorking = satOff === a ? b : a;
        } else {
          // ××™×Ÿ ×—×•×¤×© - ×¨×•×˜×¦×™×” ×œ×¤×™ ×”×™×¡×˜×•×¨×™×”
          const lastSatEmp = saturdayHistory[dept];
          
          if (lastSatEmp && emps.includes(lastSatEmp)) {
            // ×™×© ×”×™×¡×˜×•×¨×™×” - ×‘×•×—×¨ ××ª ×”×©× ×™
            satWorking = lastSatEmp === a ? b : a;
          } else {
            // ××™×Ÿ ×”×™×¡×˜×•×¨×™×” - ×¡×™×“×•×¨ ×¨××©×•×Ÿ, ×‘×•×—×¨ ×¨× ×“×•××œ×™×ª
            satWorking = Math.random() < 0.5 ? a : b;
          }
        }

        // ×©××™×¨×ª ××™ ×¢×‘×“ ×‘××•×¦"×© ×”×¤×¢×
        saturdayHistory[dept] = satWorking;

        // ×©×™×©×™ - ××™ ×©×œ× ×¢×•×‘×“ ×‘×©×‘×ª
        let friWorking;
        if (friOff) {
          // ×™×© ×—×•×¤×© ×‘×©×™×©×™ - ×”×©× ×™ ×¢×•×‘×“
          friWorking = friOff === a ? b : a;
        } else {
          // ××™×Ÿ ×—×•×¤×© - ××™ ×©×œ× ×¢×•×‘×“ ×‘×©×‘×ª
          friWorking = satWorking === a ? b : a;
        }

        schedule.push({ day:'×©×™×©×™', date: friStr, friday: friWorking, dept });
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satWorking, dept });
      }

      allSchedules[dept] = schedule;
    }

    // ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×™×ª ××•×¦"×© ×‘-Firebase
    await db.ref('saturdayHistory').set(saturdayHistory);

    return allSchedules;
  }

  function displaySchedule(allSchedules) {
    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => allSchedules[d] && allSchedules[d].length) || deptOrder[0];
    const sampleSchedule = allSchedules[sampleDept] || [];
    if (sampleSchedule.length === 0) { document.getElementById('schedule-result').innerHTML = ''; return; }

    const dayCols = sampleSchedule.map(d => ({ day: d.day, date: d.date }));
    const totalCols = dayCols.length + 1;

    let html = `
      <h2 style="color:#667eea; margin-top:30px;">ğŸ“… ×¡×™×“×•×¨ ×©×‘×•×¢×™ - ×›×œ ×”×¡× ×™×£</h2>
      <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px;">
        <table class="schedule-table">
          <tr>
            <th>×¢×•×‘×“</th>`;

    dayCols.forEach(c => { html += `<th>${c.day}<br>${formatDate(c.date)}</th>`; });
    html += `</tr>`;

    deptOrder.forEach(dept => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = allSchedules[dept] || [];

      html += `<tr class="dept-divider"><td colspan="${totalCols}">ğŸ¢ ${dept}</td></tr>`;

      employees.forEach(emp => {
        html += `<tr>
          <td style="background:#667eea; color:white; font-weight:bold;">${DISPLAY_NAMES[emp] || emp}</td>`;

        dayCols.forEach(c => {
          const day = deptSchedule.find(d => d.date === c.date);
          if (!day) { html += `<td style="background:#f0f0f0;">-</td>`; return; }

          const isThreeEmp = employees.length === 3;
          const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

          if (day.friday) {
            if (isThreeEmp) {
              const works = Array.isArray(day.friday) && day.friday.includes(emp);
              html += works
                ? (isKavLavan ? `<td><span class="shift-friday">×¢×•×‘×“ ×‘×©×™×©×™</span></td>` : `<td><span class="shift-friday">×©×™×©×™<br>8:30-14:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.friday === emp) ? `<td><span class="shift-friday">×‘×•×§×¨<br>8:30-14:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          if (day.saturday) {
            if (isThreeEmp) {
              html += (day.saturday === emp)
                ? (isKavLavan ? `<td><span class="shift-saturday">×¢×•×‘×“ ×‘××•×¦"×©</span></td>` : `<td><span class="shift-saturday">××•×¦"×©<br>××•×¦"×©-22:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.saturday === emp) ? `<td><span class="shift-saturday">×¢×¨×‘<br>××•×¦"×©-22:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          const shifts = [];
          if (day.morning === emp) shifts.push(isKavLavan ? '<span class="shift-morning">×‘×•×§×¨</span>' : '<span class="shift-morning">×‘×•×§×¨<br>9:00-16:00</span>');
          if (day.middle === emp) shifts.push(isKavLavan ? '<span class="shift-middle">×××¦×¢</span>' : '<span class="shift-middle">×××¦×¢<br>11:00-19:00</span>');
          if (day.evening === emp) shifts.push(isKavLavan ? '<span class="shift-evening">×¢×¨×‘</span>' : '<span class="shift-evening">×¢×¨×‘<br>15:00-21:30</span>');

          if (shifts.length >= 2) {
            html += `<td><span class="shift-double">×›×¤×•×œ×”</span></td>`;
          } else {
            html += shifts.length ? `<td>${shifts.join('<br>')}</td>` : `<td style="background:#f0f0f0;">-</td>`;
          }
        });

        html += `</tr>`;
      });
    });

    html += `</table></div>`;
    document.getElementById('schedule-result').innerHTML = html;
  }

  function exportToHTML() {
    if (!currentSchedule) {
      showMessage('××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×! ×™×© ×œ×™×¦×•×¨ ×¡×™×“×•×¨ ×ª×—×™×œ×”.', 'error');
      return;
    }

    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => currentSchedule[d] && currentSchedule[d].length) || deptOrder[0];
    const sampleSchedule = currentSchedule[sampleDept] || [];

    let html = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¡×™×“×•×¨ ×¢×‘×•×“×” ×©×‘×•×¢×™</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px 20px;
      background: #f5f5f5;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
    }
    .table-container {
      width: 95%;
      max-width: 1200px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table{
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed;   /* â­ ×”×›×™ ×—×©×•×‘ â€“ ×¨×•×—×‘ ×§×‘×•×¢ ×›××• ××§×¡×œ */
}

th, td{
  border:1px solid #ccc;
  padding:2px;           /* ×¤×—×•×ª ×¨×•×•×— ×¤× ×™××™ */
  text-align:center;
  width:70px;            /* ×¨×•×—×‘ ×ª× ×§×˜×Ÿ */
  height:32px;           /* ×’×•×‘×” ×›××• ×‘××§×¡×œ */
  font-size:11px;        /* ×˜×§×¡×˜ ×§×•××¤×§×˜×™ */
  white-space: nowrap;   /* ×œ× ×œ×©×‘×•×¨ ×©×•×¨×•×ª */
}

    thead th {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
    tbody td:first-child {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
    .morning { background: #fff3cd; font-weight: bold; }
    .middle  { background: #ffd4a3; font-weight: bold; }
    .evening { background: #d1ecf1; font-weight: bold; }
    .friday  { background: #d4edda; font-weight: bold; }
    .saturday{ background: #e7d4f5; font-weight: bold; }
    
    .double  { background: #f8cbad; font-weight: bold; }
.empty   { background: #f0f0f0; color: #999; }
    .dept-row td { background: #667eea; color: white; font-weight: bold; font-size: 16px; }
  </style>
</head>
<body>
  <h1>ğŸ“… ×¡×™×“×•×¨ ×¢×‘×•×“×” ×©×‘×•×¢×™</h1>
  <div class="table-container">
  <table>
    <thead>
      <tr>
        <th>×¢×•×‘×“</th>`;

    sampleSchedule.forEach(day => {
      html += `<th>${day.day}<br>${formatDate(day.date)}</th>`;
    });
    html += `</tr></thead><tbody>`;

    deptOrder.forEach((dept, deptIndex) => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = currentSchedule[dept] || [];
      const isThreeEmp = employees.length === 3;
      const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

      if (deptIndex > 0) {
        html += `<tr class="dept-row"><td colspan="${sampleSchedule.length + 1}">ğŸ¢ ${dept}</td></tr>`;
      }

      employees.forEach(emp => {
        html += `<tr>
          <td>${DISPLAY_NAMES[emp] || emp}</td>`;

        sampleSchedule.forEach(dayCol => {
          const day = deptSchedule.find(d => d.date === dayCol.date);
          let cellText = '-';
          let cellClass = 'empty';

          if (day) {
            if (day.friday) {
              if (isThreeEmp) {
                if (Array.isArray(day.friday) && day.friday.includes(emp)) {
                  cellText = isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™<br>8:30-14:30';
                  cellClass = 'friday';
                } else {
                  cellText = '-';
                  cellClass = 'empty';
                }
              } else {
                if (day.friday === emp) {
                  cellText = '×‘×•×§×¨<br>8:30-14:30';
                  cellClass = 'friday';
                } else {
                  cellText = '-';
                  cellClass = 'empty';
                }
              }
            } else if (day.saturday) {
              if (isThreeEmp) {
                if (day.saturday === emp) {
                  cellText = isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×©<br>××•×¦"×©-22:30';
                  cellClass = 'saturday';
                } else {
                  cellText = '-';
                  cellClass = 'empty';
                }
              } else {
                if (day.saturday === emp) {
                  cellText = '×¢×¨×‘<br>××•×¦"×©-22:30';
                  cellClass = 'saturday';
                } else {
                  cellText = '-';
                  cellClass = 'empty';
                }
              }
            } else {
              const shifts = [];
              if (day.morning === emp) shifts.push({ text: isKavLavan ? '×‘×•×§×¨' : '×‘×•×§×¨<br>9:00-16:00', class: 'morning' });
              if (day.middle === emp) shifts.push({ text: isKavLavan ? '×××¦×¢' : '×××¦×¢<br>11:00-19:00', class: 'middle' });
              if (day.evening === emp) shifts.push({ text: isKavLavan ? '×¢×¨×‘' : '×¢×¨×‘<br>15:00-21:30', class: 'evening' });

              
              if (shifts.length >= 2) {
                cellText = '×›×¤×•×œ×”';
                cellClass = 'double';
              } else if (shifts.length === 1) {
                cellText = `<span class="${shifts[0].class}">${shifts[0].text}</span>`;
                cellClass = '';
              } else {
                cellText = '-';
                cellClass = 'empty';
              }
}
          }

          html += `<td class="${cellClass}">${cellText}</td>`;
        });

        html += `</tr>`;
      });
    });

    html += `</tbody></table></div></body></html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const today = new Date();
    a.download = `×¡×™×“×•×¨_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showMessage('×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”! âœ…', 'success');
  }

  function exportToExcel() {
    // âœ… Ensure XLSX library is loaded (prevents "XLSX is not defined")
    if (typeof window.XLSX === 'undefined') {
      if (!window.__xlsxLoading) {
        window.__xlsxLoading = true;
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.full.min.js";
        s.onload = () => {
          window.__xlsxLoading = false;
          exportToExcel(); // retry after load
        };
        s.onerror = () => {
          window.__xlsxLoading = false;
          console.error("Failed to load XLSX library from CDN");
          showMessage('âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×¡×¤×¨×™×™×ª ×”××§×¡×œ. ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜/×—×¡×™××” ×©×œ ×¨×©×ª.', 'error');
        };
        document.head.appendChild(s);
      }
      showMessage('×˜×•×¢×Ÿ ×¡×¤×¨×™×™×ª ××§×¡×œâ€¦ × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×©× ×™×™×”', 'info');
      return;
    }

    if (!currentSchedule) {
      showMessage('××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×! ×™×© ×œ×™×¦×•×¨ ×¡×™×“×•×¨ ×ª×—×™×œ×”.', 'error');
      return;
    }

    const wb = XLSX.utils.book_new();
    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => currentSchedule[d] && currentSchedule[d].length) || deptOrder[0];
    const sampleSchedule = currentSchedule[sampleDept] || [];

    // Build data array
    const data = [];
    
    // Header row
    const headerRow = ['×¢×•×‘×“'];
    sampleSchedule.forEach(day => {
      headerRow.push(`${day.day} ${formatDate(day.date)}`);
    });
    data.push(headerRow);

    // Data rows
    deptOrder.forEach((dept, deptIndex) => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = currentSchedule[dept] || [];
      const isThreeEmp = employees.length === 3;
      const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

      // Department divider row
      if (deptIndex > 0) {
        const dividerRow = [`ğŸ¢ ${dept}`];
        for (let i = 1; i < headerRow.length; i++) dividerRow.push(' ');
        data.push(dividerRow);
      }

      // Employee rows
      employees.forEach(emp => {
        const row = [DISPLAY_NAMES[emp] || emp];

        sampleSchedule.forEach(dayCol => {
          const day = deptSchedule.find(d => d.date === dayCol.date);
          let cellText = '-';

          if (day) {
            if (day.friday) {
              if (isThreeEmp) {
                if (Array.isArray(day.friday) && day.friday.includes(emp)) {
                  cellText = isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™ 8:30-14:30';
                } else {
                  cellText = '-';
                }
              } else {
                cellText = day.friday === emp ? '×‘×•×§×¨ 8:30-14:30' : '-';
              }
            } else if (day.saturday) {
              if (isThreeEmp) {
                cellText = day.saturday === emp 
                  ? (isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×© ××•×¦"×©-22:30')
                  : '-';
              } else {
                cellText = day.saturday === emp ? '×¢×¨×‘ ××•×¦"×©-22:30' : '-';
              }
            } else {
              const shifts = [];
              if (day.morning === emp) shifts.push(isKavLavan ? '×‘×•×§×¨' : '×‘×•×§×¨ 9:00-16:00');
              if (day.middle === emp) shifts.push(isKavLavan ? '×××¦×¢' : '×××¦×¢ 11:00-19:00');
              if (day.evening === emp) shifts.push(isKavLavan ? '×¢×¨×‘' : '×¢×¨×‘ 15:00-21:30');
              if (shifts.length >= 2) cellText = '×›×¤×•×œ×”';
              else cellText = shifts.length > 0 ? shifts.join(', ') : '-';
            }
          }

          row.push(cellText);
        });

        data.push(row);
      });
    });

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);

// RTL sheet (×¢×‘×¨×™×ª)
ws['!rtl'] = true;

    

    // Set column widths (10 for all columns)
    const colCount = headerRow.length;
    ws['!cols'] = [];
    for (let i = 0; i < colCount; i++) {
      ws['!cols'].push({ wch: 12 });
    }

    // Set row heights (30 for all rows) and styling
    ws['!rows'] = [];
    for (let i = 0; i < data.length; i++) {
      ws['!rows'].push({ hpt: 36 });
    }

    // Apply styling to all cells
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; ++R) {
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
        if (!ws[cellAddress]) continue;

        // Initialize cell style
        ws[cellAddress].s = {
          alignment: {
            horizontal: 'center',
            vertical: 'center',
            wrapText: true
          },
          border: {
            top: { style: 'thin', color: { rgb: 'DDDDDD' } },
            bottom: { style: 'thin', color: { rgb: 'DDDDDD' } },
            left: { style: 'thin', color: { rgb: 'DDDDDD' } },
            right: { style: 'thin', color: { rgb: 'DDDDDD' } }
          }
        };

        // Header row styling
        if (R === 0) {
          ws[cellAddress].s.fill = {
            fgColor: { rgb: '667EEA' }
          };
          ws[cellAddress].s.font = {
            color: { rgb: 'FFFFFF' },
            bold: true
          };
        }
        // Department divider rows
        else if (data[R][0] && data[R][0].startsWith('ğŸ¢')) {
          ws[cellAddress].s.fill = {
            fgColor: { rgb: '667EEA' }
          };
          ws[cellAddress].s.font = {
            color: { rgb: 'FFFFFF' },
            bold: true
          };
        }
        // Employee name column
        else if (C === 0) {
          ws[cellAddress].s.fill = {
            fgColor: { rgb: '667EEA' }
          };
          ws[cellAddress].s.font = {
            color: { rgb: 'FFFFFF' },
            bold: true
          };
        }
        // Shift cells - color based on content
        else {
          const cellValue = ws[cellAddress].v || '';
          
          if (cellValue === '×›×¤×•×œ×”') {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'F8CBAD' } }; // mild red
            ws[cellAddress].s.font = { bold: true };
          } else if (cellValue.includes('×‘×•×§×¨')) {

            ws[cellAddress].s.fill = { fgColor: { rgb: 'FFF3CD' } };
          } else if (cellValue.includes('×××¦×¢')) {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'FFD4A3' } };
          } else if (cellValue.includes('×¢×¨×‘') && !cellValue.includes('×©×™×©×™') && !cellValue.includes('××•×¦')) {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'D1ECF1' } };
          } else if (cellValue.includes('×©×™×©×™')) {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'D4EDDA' } };
          } else if (cellValue.includes('××•×¦')) {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'E7D4F5' } };
          } else if (cellValue === '-') {
            ws[cellAddress].s.fill = { fgColor: { rgb: 'F0F0F0' } };
            ws[cellAddress].s.font = { color: { rgb: '999999' } };
          }
        }
      }
    }

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, '×¡×™×“×•×¨ ×©×‘×•×¢×™');
    
// âœ… RTL ×œ×›×œ ×”×§×•×‘×¥ (×”×’×™×œ×™×•×Ÿ ×™×™×¤×ª×— ××™××™×Ÿ ×œ×©×××œ)
wb.Workbook = wb.Workbook || {};
wb.Workbook.Views = [{ RTL: true }];


    // Generate filename
    const today = new Date();
    const filename = `×¡×™×“×•×¨_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.xlsx`;

    // Export file
    XLSX.writeFile(wb, filename);

    showMessage('×§×•×‘×¥ Excel ×™×•×¦× ×‘×”×¦×œ×—×”! âœ…', 'success');
  }

  // Helpers
  function hideAll() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('message').innerHTML = '';
  }
  function clearInputs() {
    document.getElementById('emp-username').value = '';
    document.getElementById('emp-password').value = '';
    document.getElementById('mgr-username').value = '';
    document.getElementById('mgr-password').value = '';
  }
  function showMessage(text, type) {
    const div = document.getElementById('message');
    div.className = `message ${type}`;
    div.textContent = text;
    setTimeout(() => div.innerHTML = '', 8000);
  }
  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function toLocalDateStr(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function formatType(type) {
    const types = {
      'no-morning':'âŒ ×œ× ×‘×•×§×¨',
      'no-evening':'âŒ ×œ× ×¢×¨×‘',
      'want-morning':'âœ… ×¨×•×¦×” ×‘×•×§×¨',
      'want-middle':'âœ… ×¨×•×¦×” ×××¦×¢',
      'want-evening':'âœ… ×¨×•×¦×” ×¢×¨×‘',
      'day-off':'ğŸ–ï¸ ×—×•×¤×© ××œ×'
    };
    return types[type] || type;
  }

  function isValidWeekday(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const day = d.getDay();
    return day !== 5 && day !== 6;
  }
  function getStatusBadge(c) {
    if (c.type !== 'day-off') return '';
    const statuses = { 'pending':'â³ ×××ª×™×Ÿ', 'approved':'âœ… ×××•×©×¨', 'rejected':'âŒ × ×“×—×”' };
    const classes  = { 'pending':'status-pending', 'approved':'status-approved', 'rejected':'status-rejected' };
    const status = c.status || 'pending';
    return `<span class="${classes[status]}">${statuses[status]}</span>`;
  }
</script>
  <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js");
    });
  }
</script>

</body>
</html>
