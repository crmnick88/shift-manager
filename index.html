<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#667eea" />
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container{
      max-width:900px; margin:0 auto; background:white; border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3); padding:30px;
    }
    h1{ text-align:center; color:#667eea; margin-bottom:30px; font-size:2.3em; }
    .section{ display:none; }
    .section.active{ display:block; }

    .btn{
      width:100%; padding:15px; background:#667eea; color:white; border:none;
      border-radius:10px; font-size:18px; font-weight:bold; cursor:pointer;
      transition:all 0.3s; margin-top:10px;
    }
    .btn:hover{ background:#5568d3; transform:translateY(-2px); }

    .mode-btn{
      padding:20px 40px; margin:10px; border:2px solid #667eea; background:white;
      color:#667eea; border-radius:10px; cursor:pointer; font-size:20px;
      font-weight:bold; transition:all 0.3s;
    }
    .mode-btn:hover{ background:#667eea; color:white; }

    input, select{
      width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px;
      font-size:16px; margin-top:8px;
    }
    .form-group{ margin-bottom:15px; }
    label{ display:block; margin-bottom:5px; font-weight:bold; color:#555; }

    .constraint-item{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border:2px solid #e0e0e0;
    }
    .constraint-card{ background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:10px; }

    .message{
      padding:15px; border-radius:8px; margin-top:20px; text-align:center;
      font-weight:bold; white-space:pre-line;
    }
    .message.success{ background:#d4edda; color:#155724; }
    .message.error{ background:#f8d7da; color:#721c24; }

    .employee-constraints{
      background:white; padding:15px; border-radius:8px; margin-bottom:15px;
      border-right:4px solid #667eea;
    }

    .schedule-table{
      width:100%;
      margin-top:20px;
      border-collapse:collapse;
      background:white;
      border-radius:8px;
      overflow:hidden;
    }
    .schedule-table th{
      background:#667eea;
      color:white;
      padding:15px 10px;
      text-align:center;
      font-size:14px;
      min-width:100px;
    }
    .schedule-table td{
      padding:15px 10px;
      text-align:center;
      border:1px solid #e0e0e0;
      vertical-align:middle;
      min-width:100px;
    }

    .shift-morning, .shift-middle, .shift-evening, .shift-friday, .shift-saturday{
      display:inline-block; padding:8px 12px; border-radius:6px;
      font-size:13px; font-weight:bold; line-height:1.6;
    }
    .shift-morning{ background:#fff3cd; }
    .shift-middle{ background:#ffd4a3; }
    .shift-evening{ background:#d1ecf1; }
    .shift-friday{ background:#d4edda; }
    .shift-saturday{ background:#e7d4f5; }

    .approval-buttons{ display:inline-flex; gap:10px; margin-right:10px; flex-wrap:wrap; }
    .approve-btn, .reject-btn, .reset-btn{
      padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
    }
    .approve-btn{ background:#28a745; color:white; }
    .reject-btn{ background:#dc3545; color:white; }
    .reset-btn{ background:#6c757d; color:white; }

    .status-pending, .status-approved, .status-rejected{
      padding:5px 12px; border-radius:20px; font-size:14px; display:inline-block; margin-right:8px;
    }
    .status-pending{ background:#fff3cd; color:#856404; }
    .status-approved{ background:#d4edda; color:#155724; }
    .status-rejected{ background:#f8d7da; color:#721c24; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 20px 0;
    }
    .toolbar .btn{ width:auto; padding:10px 14px; font-size:14px; margin-top:0; }

    .dept-divider td{
      background:#667eea !important;
      color:#fff !important;
      font-weight:900;
      text-align:center !important;
      font-size:16px;
      padding:12px !important;
      border:0 !important;
      letter-spacing:.3px;
    }

    .emp-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .emp-header-row h4{
      margin:0;
    }
    .emp-header-row .reset-btn{
      white-space:nowrap;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- Login Screen -->
  <div id="login-screen" class="section active">
    <h1>ğŸ—“ï¸ ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h1>
    <div style="text-align:center; margin-top:40px;">
      <button class="mode-btn" onclick="showLoginForm('employee')">ğŸ‘¤ ×›× ×™×¡×ª ×¢×•×‘×“</button>
      <button class="mode-btn" onclick="showLoginForm('manager')">ğŸ‘” ×›× ×™×¡×ª ×× ×”×œ</button>
    </div>
  </div>

  <!-- Employee Login -->
  <div id="employee-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×¢×•×‘×“</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="emp-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="emp-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginEmployee()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Manager Login -->
  <div id="manager-login" class="section">
    <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×× ×”×œ</h1>
    <div style="max-width:400px; margin:40px auto;">
      <div class="form-group">
        <label>×©× ××©×ª××©:</label>
        <input type="text" id="mgr-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
      </div>
      <div class="form-group">
        <label>×¡×™×¡××”:</label>
        <input type="password" id="mgr-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
      </div>
      <button class="btn" onclick="loginManager()">×”×ª×—×‘×¨</button>
      <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
    </div>
  </div>

  <!-- Employee Section -->
  <div id="employee-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h1>ğŸ—“ï¸ ××©××¨×•×ª</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>
    <h2 id="employee-welcome" style="color:#667eea; text-align:center; margin-bottom:30px;"></h2>

    <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
      <h3>×”×’×“×¨×ª ××™×œ×•×¦×™× (×¢×“ 2)</h3>
      <p style="color:#e74c3c; margin:10px 0;">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ××•×¦"×©</p>

      <div class="constraint-item">
        <h4>××™×œ×•×¥ 1</h4>
        <div class="form-group">
          <label>×ª××¨×™×š:</label>
          <input type="date" id="c1-date">
        </div>
        <div class="form-group">
          <label>×¡×•×’:</label>
          <select id="c1-type">
            <option value="">-- ×‘×—×¨ --</option>
            <option value="no-morning">×œ× ×‘×•×§×¨</option>
            <option value="no-evening">×œ× ×¢×¨×‘</option>
            <option value="day-off">×—×•×¤×© ××œ×</option>
          </select>
        </div>
      </div>

      <div class="constraint-item">
        <h4>××™×œ×•×¥ 2</h4>
        <div class="form-group">
          <label>×ª××¨×™×š:</label>
          <input type="date" id="c2-date">
        </div>
        <div class="form-group">
          <label>×¡×•×’:</label>
          <select id="c2-type">
            <option value="">-- ×‘×—×¨ --</option>
            <option value="no-morning">×œ× ×‘×•×§×¨</option>
            <option value="no-evening">×œ× ×¢×¨×‘</option>
            <option value="day-off">×—×•×¤×© ××œ×</option>
          </select>
        </div>
      </div>

      <button class="btn" onclick="saveConstraints()">×©××•×¨ ××™×œ×•×¦×™×</button>
    </div>

    <div id="my-constraints" style="margin-top:20px;"></div>
  </div>

  <!-- Manager Section -->
  <div id="manager-section" class="section">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h1>ğŸ—“ï¸ ×¤×× ×œ ×× ×”×œ</h1>
      <button class="btn" onclick="logout()" style="width:auto; padding:10px 20px; background:#dc3545;">×”×ª× ×ª×§</button>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="refreshAll()" style="background:#343a40;">ğŸ” ×¨×¢× ×Ÿ ×”×›×œ</button>
      <button class="btn" onclick="loadAllConstraints()" style="background:#17a2b8;">ğŸ”„ ×¨×¢× ×Ÿ ××™×œ×•×¦×™×</button>
      <button class="btn" onclick="generateSchedule()" style="background:#667eea;">ğŸ”„ ×¨×¢× ×Ÿ ×¡×™×“×•×¨</button>
      <button class="btn" onclick="resetAllConstraints()" style="background:#6c757d;">ğŸ§¹ ××™×¤×•×¡ ××™×œ×•×¦×™× ×œ×›×œ ×”×¢×•×‘×“×™×</button>
    </div>

    <div id="all-constraints"></div>

    <button class="btn" onclick="generateSchedule()">×¦×•×¨ ×¡×™×“×•×¨ ××•×˜×•××˜×™</button>

    <div id="export-section" style="display:none; margin-top:10px;">
      <button class="btn" onclick="exportToExcel()" style="background:#28a745;">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
    </div>

    <div id="schedule-result"></div>
  </div>

  <div id="message"></div>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD-uaQ2aO87kGxbcc-m8_9fzJ3uhPv2zvk",
    authDomain: "shift-manager-c026e.firebaseapp.com",
    databaseURL: "https://shift-manager-c026e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "shift-manager-c026e",
    storageBucket: "shift-manager-c026e.firebasestorage.app",
    messagingSenderId: "1091605398341",
    appId: "1:1091605398341:web:cb6c14e7d832c3e8df342c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentEmployee = '';
  let currentSchedule = null;

  const USERS = {
    'ILAY': 'ILAY',
    'ROVEN': 'ROVEN',
    'HAI': 'HAI',
    'NATALI': 'NATALI',
    'INNA': 'INNA',
    'TAMIR': 'TAMIR',
    'ELIYA': 'ELIYA',
    'LIOR': 'LIOR',
    'AMANI': 'AMANI',
    'SHIROT': 'SHIROT',
    'AVI': 'AVI',
    'MOHAMAD': 'MOHAMAD'
  };

  const DEPARTMENTS = {
    '××—×œ×§×ª ××™×—×©×•×‘': ['ILAY', 'ROVEN'],
    '××—×œ×§×ª ×§×˜× ×™×': ['HAI', 'NATALI'],
    '××—×œ×§×ª ××—×¡× ××™×': ['AVI', 'MOHAMAD'],
    '××—×œ×§×ª ×§×• ×œ×‘×Ÿ': ['INNA', 'TAMIR', 'ELIYA'],
    '× ×¦×™×’×•×ª ×©×™×¨×•×ª': ['LIOR', 'AMANI', 'SHIROT']
  };

  // ××™×¤×•×™ ×©××•×ª ×ª×¦×•×’×” ×‘×¢×‘×¨×™×ª (×¨×§ ×œ×ª×¦×•×’×” ×‘×˜×‘×œ×”!)
  const DISPLAY_NAMES = {
    'ILAY': '×¢×™×œ××™',
    'ROVEN': '×¨××•×‘×Ÿ',
    'HAI': '×—×™',
    'NATALI': '× ×˜×œ×™',
    'AVI': '××‘×™',
    'MOHAMAD': '××•×—××“',
    'INNA': '××™× ×”',
    'TAMIR': '×ª××™×¨',
    'ELIYA': '××œ×™×”',
    'LIOR': '×œ×™××•×¨',
    'AMANI': '×××× ×™',
    'SHIROT': '×©×™×¨×•×ª'
  };

  const MANAGER = { username: 'SAGI', password: '102' };

  function showLoginForm(type) {
    hideAll();
    document.getElementById(type + '-login').classList.add('active');
  }

  function backToLogin() {
    hideAll();
    document.getElementById('login-screen').classList.add('active');
    clearInputs();
  }

  function logout() {
    currentEmployee = '';
    backToLogin();
    showMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”', 'success');
  }

  function loginEmployee() {
    const username = document.getElementById('emp-username').value.trim().toUpperCase();
    const password = document.getElementById('emp-password').value.trim();

    if (!username || !password) return showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');

    if (USERS[username] && USERS[username] === password) {
      currentEmployee = username;
      hideAll();
      document.getElementById('employee-section').classList.add('active');
      document.getElementById('employee-welcome').textContent = `×©×œ×•× ${username}! ğŸ‘‹`;
      loadEmployeeConstraints();
      showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  function loginManager() {
    const username = document.getElementById('mgr-username').value.trim().toUpperCase();
    const password = document.getElementById('mgr-password').value.trim();

    if (!username || !password) return showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error');

    if (username === MANAGER.username && password === MANAGER.password) {
      hideAll();
      document.getElementById('manager-section').classList.add('active');
      loadAllConstraints();
      showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
    } else {
      showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
    }
  }

  async function loadEmployeeConstraints() {
    const snapshot = await db.ref('constraints/' + currentEmployee).once('value');
    const data = snapshot.val() || {};

    document.getElementById('c1-date').value = data.c1?.date || '';
    document.getElementById('c1-type').value = data.c1?.type || '';

    document.getElementById('c2-date').value = data.c2?.date || '';
    document.getElementById('c2-type').value = data.c2?.type || '';

    displayMyConstraints(data);
  }

  async function saveConstraints() {
    if (!currentEmployee) return;

    const c1Date = document.getElementById('c1-date').value;
    const c1Type = document.getElementById('c1-type').value;
    const c2Date = document.getElementById('c2-date').value;
    const c2Type = document.getElementById('c2-type').value;

    if (c1Date && !isValidWeekday(c1Date)) return showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error');
    if (c2Date && !isValidWeekday(c2Date)) return showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error');

    const constraints = {};
    if (c1Date && c1Type) constraints.c1 = { date: c1Date, type: c1Type, status: c1Type === 'day-off' ? 'pending' : 'approved' };
    if (c2Date && c2Type) constraints.c2 = { date: c2Date, type: c2Type, status: c2Type === 'day-off' ? 'pending' : 'approved' };

    await db.ref('constraints/' + currentEmployee).set(constraints);

    const hasDayOff = c1Type === 'day-off' || c2Type === 'day-off';
    showMessage(hasDayOff ? '× ×©××¨! ×‘×§×©×•×ª ×—×•×¤×© ×××ª×™× ×•×ª ×œ××™×©×•×¨' : '× ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
    displayMyConstraints(constraints);
  }

  function displayMyConstraints(data) {
    const today = new Date(); today.setHours(0,0,0,0);
    let html = '<h3 style="color:#667eea;">×”××™×œ×•×¦×™× ×©×œ×™:</h3>';
    let hasValid = false;

    if (data.c1 && new Date(data.c1.date + 'T00:00:00') >= today) {
      html += `<div class="constraint-card"><strong>××™×œ×•×¥ 1:</strong> ${formatDate(data.c1.date)} - ${formatType(data.c1.type)} ${getStatusBadge(data.c1)}</div>`;
      hasValid = true;
    }
    if (data.c2 && new Date(data.c2.date + 'T00:00:00') >= today) {
      html += `<div class="constraint-card"><strong>××™×œ×•×¥ 2:</strong> ${formatDate(data.c2.date)} - ${formatType(data.c2.type)} ${getStatusBadge(data.c2)}</div>`;
      hasValid = true;
    }
    if (!hasValid) html += '<p style="color:#28a745;">××™×Ÿ ××™×œ×•×¦×™× ×¢×ª×™×“×™×™×</p>';
    document.getElementById('my-constraints').innerHTML = html;
  }

  async function loadAllConstraints() {
    const snapshot = await db.ref('constraints').once('value');
    const allData = snapshot.val() || {};
    const today = new Date(); today.setHours(0,0,0,0);

    let html = '<h2>××™×œ×•×¦×™ ×”×¢×•×‘×“×™×</h2>';

    for (const [dept, employees] of Object.entries(DEPARTMENTS)) {
      html += `<div style="background:#f0f0f0; padding:15px; border-radius:10px; margin-bottom:20px;">
        <h3 style="color:#667eea;">ğŸ¢ ${dept}</h3>`;

      employees.forEach(emp => {
        const data = allData[emp];

        html += `<div class="employee-constraints">`;

        // âœ… ×›×•×ª×¨×ª + ×›×¤×ª×•×¨ ××™×¤×•×¡ ×œ×¢×•×‘×“
        html += `
          <div class="emp-header-row">
            <h4>${emp}</h4>
            <button class="reset-btn" onclick="resetEmployeeConstraints('${emp}')">ğŸ§¹ ××™×¤×•×¡ ××™×œ×•×¦×™× ×œ×¢×•×‘×“</button>
          </div>
        `;

        let hasValid = false;

        if (data?.c1 && new Date(data.c1.date + 'T00:00:00') >= today) { html += formatConstraintForManager(emp,'c1',data.c1); hasValid = true; }
        if (data?.c2 && new Date(data.c2.date + 'T00:00:00') >= today) { html += formatConstraintForManager(emp,'c2',data.c2); hasValid = true; }

        if (!hasValid) html += '<p style="color:#28a745;">âœ… ××™×Ÿ ××™×œ×•×¦×™×</p>';

        html += '</div>';
      });

      html += '</div>';
    }

    document.getElementById('all-constraints').innerHTML = html;
  }

  function formatConstraintForManager(emp, key, c) {
    let html = `<div style="margin:10px 0; padding:10px; background:#f8f9fa; border-radius:6px;">
      ğŸ“Œ ${formatDate(c.date)} - ${formatType(c.type)}`;

    if (c.type === 'day-off') {
      const status = c.status || 'pending';
      if (status === 'pending') {
        html += `<div class="approval-buttons">
          <button class="approve-btn" onclick="updateApproval('${emp}','${key}','approved')">âœ… ××©×¨</button>
          <button class="reject-btn" onclick="updateApproval('${emp}','${key}','rejected')">âŒ ×“×—×”</button>
        </div>
        <span class="status-pending">â³ ×××ª×™×Ÿ</span>`;
      } else if (status === 'approved') {
        html += `<span class="status-approved">âœ… ×××•×©×¨</span>`;
      } else {
        html += `<span class="status-rejected">âŒ × ×“×—×”</span>`;
      }
    } else {
      html += `<span class="status-approved">âœ… ×¤×¢×™×œ</span>`;
    }

    // âœ… ×›×¤×ª×•×¨ ×œ××—×™×§×” × ×§×•×“×ª×™×ª ×©×œ ×”××™×œ×•×¥ (c1/c2)
    html += `
      <div class="approval-buttons" style="margin-top:8px;">
        <button class="reset-btn" onclick="deleteSingleConstraint('${emp}','${key}')">ğŸ—‘ï¸ ××—×§ ××™×œ×•×¥ ×–×”</button>
      </div>
    `;

    return html + `</div>`;
  }

  async function updateApproval(emp, key, status) {
    if (status === 'rejected') {
      await db.ref(`constraints/${emp}/${key}`).set(null);
      showMessage('×‘×§×©×ª ×”×—×•×¤×© × ×“×—×ª×” ×•× ××—×§×”', 'success');
    } else {
      await db.ref(`constraints/${emp}/${key}`).update({
        status: "approved",
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: MANAGER.username
      });
      showMessage('×‘×§×©×ª ×”×—×•×¤×© ××•×©×¨×”!', 'success');
    }
    await loadAllConstraints();
  }

  // âœ… ××—×™×§×ª ××™×œ×•×¥ ×‘×•×“×“ (c1 ××• c2)
  async function deleteSingleConstraint(emp, key){
    const ok = confirm(`×œ××—×•×§ ××ª ${key} ×¢×‘×•×¨ ${emp}?`);
    if(!ok) return;
    await db.ref(`constraints/${emp}/${key}`).set(null);
    showMessage(`× ××—×§ ${key} ×¢×‘×•×¨ ${emp}`, 'success');
    await loadAllConstraints();

    // ×× ×™×© ×›×‘×¨ ×˜×‘×œ×” ××•×¦×’×ª - ×›×“×™ ×©×œ× ×ª×™×©××¨ "×ª×§×•×¢×”"
    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';
  }

  // âœ… ××™×¤×•×¡ ××™×œ×•×¦×™× ×œ×¢×•×‘×“ (××•×—×§ ××ª constraints/<EMP>)
  async function resetEmployeeConstraints(emp){
    const ok = confirm(`×œ××¤×¡ ××ª ×›×œ ×”××™×œ×•×¦×™× ×©×œ ${emp}? (×™××—×§ c1+c2)`);
    if(!ok) return;

    await db.ref(`constraints/${emp}`).set(null);
    showMessage(`××•×¤×¡×• ×”××™×œ×•×¦×™× ×©×œ ${emp}`, 'success');

    await loadAllConstraints();

    // ×œ× ×§×•×ª ×¡×™×“×•×¨ ××•×¦×’ (×›×™ ×™×›×•×œ ×œ×”×™×•×ª ×©×”×™×” "×ª×§×•×¢" ×¢×œ ×—×•×¤×© ×™×©×Ÿ)
    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';
  }

  async function resetAllConstraints() {
    const ok = confirm(`×œ××¤×¡ ××™×œ×•×¦×™× ×œ×›×œ ×”×¢×•×‘×“×™×? ×¤×¢×•×œ×” ×–×• ××•×—×§×ª ××ª ×›×œ ×”××™×œ×•×¦×™×.`);
    if (!ok) return;

    await db.ref(`constraints`).set(null);
    showMessage(`×›×œ ×”××™×œ×•×¦×™× ××•×¤×¡×•`, 'success');

    currentSchedule = null;
    document.getElementById('schedule-result').innerHTML = '';
    document.getElementById('export-section').style.display = 'none';

    await loadAllConstraints();
  }

  // âœ… ×¨×¢× ×•×Ÿ ×”×›×œ: ××™×œ×•×¦×™× + ×¡×™×“×•×¨
  async function refreshAll(){
    await loadAllConstraints();
    // ×× ××ª×” ×¨×•×¦×” ×ª××™×“ ×œ×™×™×¦×¨ ×¡×™×“×•×¨ ××—×“×© ×‘×œ×—×™×¦×” ××—×ª:
    await generateSchedule();
  }

  async function generateSchedule() {
    try {
      const snapshot = await db.ref('constraints').once('value');
      const constraints = snapshot.val() || {};

      const conflicts = checkConflicts(constraints);
      const schedule = createSchedule(constraints);

      if (conflicts.length > 0) {
        let msg = 'âš ï¸ ×§×•× ×¤×œ×™×§×˜×™×:\n\n';
        conflicts.forEach(c => { msg += `ğŸ¢ ${c.dept}\nğŸ“… ${formatDate(c.date)}: ${c.emps.join(' ×•-')} - ${c.desc}\n\n`; });
        showMessage(msg, 'error');
        document.getElementById('schedule-result').innerHTML = `<div class="message error">${msg}</div>`;
        document.getElementById('export-section').style.display = 'none';
        return;
      }

      currentSchedule = schedule;
      displaySchedule(schedule);
      document.getElementById('export-section').style.display = 'block';
      showMessage('×”×¡×™×“×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');

    } catch (error) {
      console.error(error);
      showMessage(error.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×“×•×¨', 'error');
      document.getElementById('schedule-result').innerHTML =
        `<div class="message error">${error.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×“×•×¨'}</div>`;
      document.getElementById('export-section').style.display = 'none';
    }
  }

  function checkConflicts(constraints) {
    const conflicts = [];
    const today = new Date(); today.setHours(0,0,0,0);

    for (const [dept, emps] of Object.entries(DEPARTMENTS)) {
      const allDates = [];

      emps.forEach(emp => {
        const data = constraints[emp];
        if (!data) return;

        const addIfApproved = (c) => {
          if (!c) return;
          if (c.status !== 'approved') return;
          if (new Date(c.date + 'T00:00:00') < today) return;
          allDates.push({ emp, ...c });
        };

        addIfApproved(data.c1);
        addIfApproved(data.c2);
      });

      const byDate = {};
      allDates.forEach(c => { (byDate[c.date] ||= []).push(c); });

      Object.entries(byDate).forEach(([date, dateConstraints]) => {
        const dayOffCount = dateConstraints.filter(c => c.type === 'day-off').length;
        const noMorningCount = dateConstraints.filter(c => c.type === 'no-morning' || c.type === 'day-off').length;
        const noEveningCount = dateConstraints.filter(c => c.type === 'no-evening' || c.type === 'day-off').length;

        if (emps.length === 3) {
          if (dayOffCount >= 2) {
            conflicts.push({ dept, date, emps: dateConstraints.filter(c => c.type === 'day-off').map(c => c.emp), desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×™×§×© ×—×•×¤×©' });
          }
        } else {
          if (dayOffCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×‘×™×§×©×• ×—×•×¤×©' });
          else if (noMorningCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×‘×•×§×¨' });
          else if (noEveningCount === 2) conflicts.push({ dept, date, emps: dateConstraints.map(c => c.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×¢×¨×‘' });
        }
      });
    }

    return conflicts;
  }

  function createSchedule(constraints) {
    const today = new Date(); today.setHours(0,0,0,0);
    const nextSunday = new Date(today);
    const dow = today.getDay();
    nextSunday.setDate(today.getDate() + (dow === 0 ? 0 : 7 - dow));

    const allSchedules = {};

    const hasConstraint = (emp, dateStr, type) => {
      const data = constraints[emp];
      if (!data) return false;

      const check = (c) => {
        if (!c) return false;

        if (c.type === 'day-off') {
          if (c.status !== 'approved') return false;
          // ×× ×™×©×Ÿ ×ª×§×•×¢ ×‘×œ×™ approvedAt â€” ×œ× × ×ª×—×©×‘ ×‘×•
          if (!c.approvedAt) return false;
        } else {
          if (c.status && c.status !== 'approved') return false;
        }

        if (new Date(c.date + 'T00:00:00') < today) return false;
        if (c.date !== dateStr) return false;

        if (type === 'morning') return c.type === 'no-morning' || c.type === 'day-off';
        if (type === 'evening') return c.type === 'no-evening' || c.type === 'day-off';
        if (type === 'full') return c.type === 'day-off';
        return false;
      };

      return check(data.c1) || check(data.c2);
    };

    for (const [dept, emps] of Object.entries(DEPARTMENTS)) {
      const schedule = [];
      const days = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
      const isThreeEmp = emps.length === 3;

      for (let i=0;i<5;i++) {
        const date = new Date(nextSunday);
        date.setDate(nextSunday.getDate() + i);
        const dateStr = toLocalDateStr(date);

        if (isThreeEmp) {
          const dayOffs = emps.filter(emp => hasConstraint(emp, dateStr, 'full'));
          if (dayOffs.length === 1) {
            const working = emps.filter(emp => !dayOffs.includes(emp));
            schedule.push({ day: days[i], date: dateStr, morning: working[0], evening: working[1], dept });
          } else {
            const rotation = i % 3;
            schedule.push({ day: days[i], date: dateStr, morning: emps[rotation], middle: emps[(rotation+1)%3], evening: emps[(rotation+2)%3], dept });
          }
        } else {
          const a = emps[0], b = emps[1];
          const aOff = hasConstraint(a, dateStr, 'full');
          const bOff = hasConstraint(b, dateStr, 'full');

          if (aOff && !bOff) schedule.push({ day: days[i], date: dateStr, morning: b, evening: b, dept });
          else if (bOff && !aOff) schedule.push({ day: days[i], date: dateStr, morning: a, evening: a, dept });
          else {
            const m = (i % 2 === 0) ? a : b;
            const e = (m === a) ? b : a;
            const mCant = hasConstraint(m, dateStr, 'morning');
            const eCant = hasConstraint(e, dateStr, 'evening');
            schedule.push({ day: days[i], date: dateStr, morning: mCant ? e : m, evening: eCant ? m : e, dept });
          }
        }
      }

      const fri = new Date(nextSunday); fri.setDate(nextSunday.getDate() + 5);
      const friStr = toLocalDateStr(fri);
      if (isThreeEmp) {
        const friOff = emps.find(emp => hasConstraint(emp, friStr, 'full'));
        const friWorking = friOff ? emps.filter(x => x !== friOff) : [emps[0], emps[1]];
        schedule.push({ day:'×©×™×©×™', date: friStr, friday: friWorking, dept });
      } else {
        const a = emps[0], b = emps[1];
        const aOff = hasConstraint(a, friStr, 'full');
        schedule.push({ day:'×©×™×©×™', date: friStr, friday: aOff ? b : a, dept });
      }

      const sat = new Date(nextSunday); sat.setDate(nextSunday.getDate() + 6);
      const satStr = toLocalDateStr(sat);
      if (isThreeEmp) {
        const friWorking = schedule[schedule.length - 1].friday;
        const satWorking = emps.find(e => !friWorking.includes(e)) || emps[2];
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satWorking, dept });
      } else {
        const friEmp = schedule[schedule.length - 1].friday;
        schedule.push({ day:'××•×¦"×©', date: satStr, saturday: (friEmp === emps[0]) ? emps[1] : emps[0], dept });
      }

      allSchedules[dept] = schedule;
    }

    return allSchedules;
  }

  function displaySchedule(allSchedules) {
    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => allSchedules[d] && allSchedules[d].length) || deptOrder[0];
    const sampleSchedule = allSchedules[sampleDept] || [];
    if (sampleSchedule.length === 0) { document.getElementById('schedule-result').innerHTML = ''; return; }

    const dayCols = sampleSchedule.map(d => ({ day: d.day, date: d.date }));
    const totalCols = dayCols.length + 2;

    let html = `
      <h2 style="color:#667eea; margin-top:30px;">ğŸ“… ×¡×™×“×•×¨ ×©×‘×•×¢×™ - ×›×œ ×”×¡× ×™×£</h2>
      <div style="background:#f8f9fa; padding:20px; border-radius:12px; margin-bottom:20px;">
        <table class="schedule-table">
          <tr>
            <th>×¢×•×‘×“</th>
            <th>××—×œ×§×”</th>`;

    dayCols.forEach(c => { html += `<th>${c.day}<br>${formatDate(c.date)}</th>`; });
    html += `</tr>`;

    deptOrder.forEach(dept => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = allSchedules[dept] || [];

      html += `<tr class="dept-divider"><td colspan="${totalCols}">ğŸ¢ ${dept}</td></tr>`;

      employees.forEach(emp => {
        html += `<tr>
          <td style="background:#667eea; color:white; font-weight:bold;">${DISPLAY_NAMES[emp] || emp}</td>
          <td style="background:#eef2ff; font-weight:bold;">${dept}</td>`;

        dayCols.forEach(c => {
          const day = deptSchedule.find(d => d.date === c.date);
          if (!day) { html += `<td style="background:#f0f0f0;">-</td>`; return; }

          const isThreeEmp = employees.length === 3;
          const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

          if (day.friday) {
            if (isThreeEmp) {
              const works = Array.isArray(day.friday) && day.friday.includes(emp);
              html += works
                ? (isKavLavan ? `<td><span class="shift-friday">×¢×•×‘×“ ×‘×©×™×©×™</span></td>` : `<td><span class="shift-friday">×©×™×©×™<br>8:30-14:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.friday === emp) ? `<td><span class="shift-friday">×‘×•×§×¨<br>8:30-14:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          if (day.saturday) {
            if (isThreeEmp) {
              html += (day.saturday === emp)
                ? (isKavLavan ? `<td><span class="shift-saturday">×¢×•×‘×“ ×‘××•×¦"×©</span></td>` : `<td><span class="shift-saturday">××•×¦"×©<br>××•×¦"×©-22:30</span></td>`)
                : `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += (day.saturday === emp) ? `<td><span class="shift-saturday">×¢×¨×‘<br>××•×¦"×©-22:30</span></td>` : `<td style="background:#f0f0f0;">-</td>`;
            }
            return;
          }

          const shifts = [];
          if (day.morning === emp) shifts.push(isKavLavan ? '<span class="shift-morning">×‘×•×§×¨</span>' : '<span class="shift-morning">×‘×•×§×¨<br>9:00-16:00</span>');
          if (day.middle === emp) shifts.push(isKavLavan ? '<span class="shift-middle">×××¦×¢</span>' : '<span class="shift-middle">×××¦×¢<br>11:00-19:00</span>');
          if (day.evening === emp) shifts.push(isKavLavan ? '<span class="shift-evening">×¢×¨×‘</span>' : '<span class="shift-evening">×¢×¨×‘<br>15:00-21:30</span>');

          html += shifts.length ? `<td>${shifts.join('<br>')}</td>` : `<td style="background:#f0f0f0;">-</td>`;
        });

        html += `</tr>`;
      });
    });

    html += `</table></div>`;
    document.getElementById('schedule-result').innerHTML = html;
  }

  function exportToExcel() {
    if (!currentSchedule) {
      showMessage('××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×! ×™×© ×œ×™×¦×•×¨ ×¡×™×“×•×¨ ×ª×—×™×œ×”.', 'error');
      return;
    }

    const wb = XLSX.utils.book_new();

    // ×¦×‘×¢×™× ×‘×¡×™×¡×™×™× ×©×¢×•×‘×“×™× ×‘××•×‘×™×™×œ
    const COLORS = {
      morning: 'FFF3CD',      // ×¦×”×•×‘ - ×‘×•×§×¨
      middle: 'FFD4A3',       // ×›×ª×•× - ×××¦×¢
      evening: 'D1ECF1',      // ×›×—×•×œ - ×¢×¨×‘
      friday: 'D4EDDA',       // ×™×¨×•×§ - ×©×™×©×™
      saturday: 'E7D4F5',     // ×¡×’×•×œ - ××•×¦"×©
      header: '667EEA',       // ×›×—×•×œ ×›×”×” - ×›×•×ª×¨×•×ª
      empName: '667EEA',      // ×›×—×•×œ ×›×”×” - ×©× ×¢×•×‘×“
      deptCol: 'EEF2FF',      // ×¡×’×•×œ ×‘×”×™×¨ - ×¢××•×“×ª ××—×œ×§×”
      deptRow: '667EEA',      // ×›×—×•×œ ×›×”×” - ×©×•×¨×ª ××—×œ×§×”
      empty: 'F0F0F0'         // ××¤×•×¨ - ×¨×™×§
    };

    const allData = [];
    const deptOrder = Object.keys(DEPARTMENTS);
    const sampleDept = deptOrder.find(d => currentSchedule[d] && currentSchedule[d].length) || deptOrder[0];
    const sampleSchedule = currentSchedule[sampleDept] || [];

    // ×©×•×¨×ª ×›×•×ª×¨×•×ª ×¨××©×™×ª
    const mainHeader = ['×¢×•×‘×“', '××—×œ×§×”'];
    sampleSchedule.forEach(day => mainHeader.push(`${day.day} ${formatDate(day.date)}`));
    allData.push(mainHeader);

    // ×¢×‘×•×¨ ×›×œ ××—×œ×§×”
    deptOrder.forEach((dept, deptIndex) => {
      const employees = DEPARTMENTS[dept] || [];
      const deptSchedule = currentSchedule[dept] || [];
      const isThreeEmp = employees.length === 3;
      const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

      // ×©×•×¨×ª ××—×œ×§×” (divider)
      if (deptIndex > 0) {
        const deptRow = [dept];
        for (let i = 0; i < sampleSchedule.length + 1; i++) deptRow.push('');
        allData.push(deptRow);
      }

      // ×©×•×¨×•×ª ×¢×•×‘×“×™×
      employees.forEach(emp => {
        const row = [DISPLAY_NAMES[emp] || emp, dept];
        sampleSchedule.forEach(dayCol => {
          const day = deptSchedule.find(d => d.date === dayCol.date);
          let cellText = '-';

          if (day) {
            if (day.friday) {
              if (isThreeEmp) {
                cellText = (Array.isArray(day.friday) && day.friday.includes(emp))
                  ? (isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™ 8:30-14:30')
                  : '-';
              } else {
                cellText = (day.friday === emp) ? '×‘×•×§×¨ 8:30-14:30' : '-';
              }
            } else if (day.saturday) {
              if (isThreeEmp) {
                cellText = (day.saturday === emp)
                  ? (isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×© ××•×¦"×©-22:30')
                  : '-';
              } else {
                cellText = (day.saturday === emp) ? '×¢×¨×‘ ××•×¦"×©-22:30' : '-';
              }
            } else {
              const shifts = [];
              if (day.morning === emp) shifts.push(isKavLavan ? '×‘×•×§×¨' : '×‘×•×§×¨ 9:00-16:00');
              if (day.middle === emp) shifts.push(isKavLavan ? '×××¦×¢' : '×××¦×¢ 11:00-19:00');
              if (day.evening === emp) shifts.push(isKavLavan ? '×¢×¨×‘' : '×¢×¨×‘ 15:00-21:30');
              cellText = shifts.length ? shifts.join(', ') : '-';
            }
          }
          
          row.push(cellText);
        });
        allData.push(row);
      });
    });

    // ×™×¦×™×¨×ª worksheet
    const ws = XLSX.utils.aoa_to_sheet(allData);

    // ×”×’×“×¨×ª ×¨×•×—×‘ ×¢××•×“×•×ª
    const colWidths = [{ wch: 12 }, { wch: 15 }];
    sampleSchedule.forEach(() => colWidths.push({ wch: 18 }));
    ws['!cols'] = colWidths;

    // ×”×’×“×¨×ª ×’×•×‘×” ×©×•×¨×•×ª
    ws['!rows'] = allData.map(() => ({ hpt: 30 }));

    // ×¢×™×¦×•×‘ ×›×œ ×”×ª××™×
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for (let R = range.s.r; R <= range.e.r; ++R) {
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
        if (!ws[cellAddress]) continue;

        const cellValue = ws[cellAddress].v || '';
        let bgColor = 'FFFFFF';
        let textColor = '000000';
        let isBold = false;

        // ×©×•×¨×” 0 - ×›×•×ª×¨×•×ª
        if (R === 0) {
          bgColor = COLORS.header;
          textColor = 'FFFFFF';
          isBold = true;
        }
        // ×©×•×¨×•×ª ××—×œ×§×” (divider) - ××–×”×” ×œ×¤×™ ×ª×•×›×Ÿ
        else if (C === 0 && (cellValue === '××—×œ×§×ª ××™×—×©×•×‘' || cellValue === '××—×œ×§×ª ×§×˜× ×™×' || 
                             cellValue === '××—×œ×§×ª ××—×¡× ××™×' || cellValue === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ' || 
                             cellValue === '× ×¦×™×’×•×ª ×©×™×¨×•×ª')) {
          bgColor = COLORS.deptRow;
          textColor = 'FFFFFF';
          isBold = true;
        }
        // ×¢××•×“×ª ×©××•×ª ×¢×•×‘×“×™×
        else if (C === 0) {
          bgColor = COLORS.empName;
          textColor = 'FFFFFF';
          isBold = true;
        }
        // ×¢××•×“×ª ××—×œ×§×”
        else if (C === 1) {
          bgColor = COLORS.deptCol;
          isBold = true;
        }
        // ×ª××™ ××©××¨×•×ª
        else {
          // ×–×™×”×•×™ ×¡×•×’ ××©××¨×ª ×œ×¤×™ ×ª×•×›×Ÿ
          if (cellValue.includes('×‘×•×§×¨') && !cellValue.includes('8:30')) {
            bgColor = COLORS.morning;
            isBold = true;
          } else if (cellValue.includes('×××¦×¢')) {
            bgColor = COLORS.middle;
            isBold = true;
          } else if (cellValue.includes('×¢×¨×‘') && !cellValue.includes('××•×¦"×©')) {
            bgColor = COLORS.evening;
            isBold = true;
          } else if (cellValue.includes('×©×™×©×™') || cellValue.includes('8:30')) {
            bgColor = COLORS.friday;
            isBold = true;
          } else if (cellValue.includes('××•×¦"×©')) {
            bgColor = COLORS.saturday;
            isBold = true;
          } else if (cellValue === '-') {
            bgColor = COLORS.empty;
          }
        }

        // ×”×—×œ×ª ×¢×™×¦×•×‘ ×¢×œ ×”×ª×
        ws[cellAddress].s = {
          fill: { fgColor: { rgb: bgColor } },
          font: { 
            name: 'Arial', 
            sz: 11, 
            bold: isBold,
            color: { rgb: textColor }
          },
          alignment: { 
            horizontal: 'center', 
            vertical: 'center',
            wrapText: true
          },
          border: {
            top: { style: 'thin', color: { rgb: 'D3D3D3' } },
            bottom: { style: 'thin', color: { rgb: 'D3D3D3' } },
            left: { style: 'thin', color: { rgb: 'D3D3D3' } },
            right: { style: 'thin', color: { rgb: 'D3D3D3' } }
          }
        };
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, '×¡×™×“×•×¨ ×©×‘×•×¢×™');

    const today = new Date();
    const fileName = `×¡×™×“×•×¨_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showMessage('×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”! âœ…', 'success');
  }

  // Helpers
  function hideAll() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('message').innerHTML = '';
  }
  function clearInputs() {
    document.getElementById('emp-username').value = '';
    document.getElementById('emp-password').value = '';
    document.getElementById('mgr-username').value = '';
    document.getElementById('mgr-password').value = '';
  }
  function showMessage(text, type) {
    const div = document.getElementById('message');
    div.className = `message ${type}`;
    div.textContent = text;
    setTimeout(() => div.innerHTML = '', 8000);
  }
  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function toLocalDateStr(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function formatType(type) {
    const types = { 'no-morning':'âŒ ×œ× ×‘×•×§×¨', 'no-evening':'âŒ ×œ× ×¢×¨×‘', 'day-off':'ğŸ–ï¸ ×—×•×¤×© ××œ×' };
    return types[type] || type;
  }
  function isValidWeekday(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const day = d.getDay();
    return day !== 5 && day !== 6;
  }
  function getStatusBadge(c) {
    if (c.type !== 'day-off') return '';
    const statuses = { 'pending':'â³ ×××ª×™×Ÿ', 'approved':'âœ… ×××•×©×¨', 'rejected':'âŒ × ×“×—×”' };
    const classes  = { 'pending':'status-pending', 'approved':'status-approved', 'rejected':'status-rejected' };
    const status = c.status || 'pending';
    return `<span class="${classes[status]}">${statuses[status]}</span>`;
  }
</script>
</body>
</html>