<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סידור עבודה שבועי</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-wexOXrDt4zntKj4kkieLle0j8LMxnt4",
            authDomain: "work-schedule-c2b16.firebaseapp.com",
            projectId: "work-schedule-c2b16",
            storageBucket: "work-schedule-c2b16.firebasestorage.app",
            messagingSenderId: "131024161503",
            appId: "1:131024161503:web:2df85ab59d45a8e56c949d"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const DAYS = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const SHIFTS = ['בוקר', 'ערב', 'לילה'];

        // צבעים זהים לאלו בטבלה
        const SHIFT_COLORS = {
            'בוקר': { bg: '#FEF3C7', text: '#92400E' },
            'ערב': { bg: '#DBEAFE', text: '#1E3A8A' },
            'לילה': { bg: '#E0E7FF', text: '#3730A3' }
        };

        // אייקון Calendar
        const CalendarIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        // אייקון Users
        const UsersIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        // אייקון Download
        const DownloadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        function App() {
            const [employees, setEmployees] = useState([]);
            const [newEmployee, setNewEmployee] = useState({ name: '', phone: '' });
            const [schedule, setSchedule] = useState(
                DAYS.map(() => SHIFTS.map(() => ''))
            );
            const [editingEmployee, setEditingEmployee] = useState(null);

            useEffect(() => {
                loadFromFirebase();
            }, []);

            const loadFromFirebase = async () => {
                try {
                    const docRef = db.collection('schedules').doc('current');
                    const docSnap = await docRef.get();
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        setEmployees(data.employees || []);
                        setSchedule(data.schedule || DAYS.map(() => SHIFTS.map(() => '')));
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            };

            const saveToFirebase = async (data) => {
                try {
                    await db.collection('schedules').doc('current').set(data);
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            };

            const addEmployee = () => {
                if (newEmployee.name && newEmployee.phone) {
                    const updated = [...employees, { ...newEmployee, id: Date.now() }];
                    setEmployees(updated);
                    setNewEmployee({ name: '', phone: '' });
                    saveToFirebase({ employees: updated, schedule });
                }
            };

            const deleteEmployee = (id) => {
                const updated = employees.filter(emp => emp.id !== id);
                setEmployees(updated);
                saveToFirebase({ employees: updated, schedule });
            };

            const updateEmployee = (id, field, value) => {
                const updated = employees.map(emp =>
                    emp.id === id ? { ...emp, [field]: value } : emp
                );
                setEmployees(updated);
                saveToFirebase({ employees: updated, schedule });
            };

            const updateShift = (day, shift, value) => {
                const updated = [...schedule];
                updated[day][shift] = value;
                setSchedule(updated);
                saveToFirebase({ employees, schedule: updated });
            };

            // פונקציית ייצוא לאקסל עם עיצוב מלא
            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                const data = [];
                
                // שורת כותרת
                const headerRow = ['יום/משמרת', ...SHIFTS];
                data.push(headerRow);
                
                // שורות הנתונים
                DAYS.forEach((day, dayIndex) => {
                    const row = [day];
                    SHIFTS.forEach((shift, shiftIndex) => {
                        row.push(schedule[dayIndex][shiftIndex] || '');
                    });
                    data.push(row);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // הגדרת רוחב עמודות
                ws['!cols'] = [
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                
                // הגדרת גובה שורות
                ws['!rows'] = [
                    { hpt: 25 },
                    ...DAYS.map(() => ({ hpt: 20 }))
                ];
                
                // החלת עיצוב על כל התאים
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        
                        if (!ws[cellAddress]) continue;
                        
                        ws[cellAddress].s = {
                            alignment: {
                                horizontal: 'center',
                                vertical: 'center',
                                wrapText: true
                            },
                            border: {
                                top: { style: 'thin', color: { rgb: 'E5E7EB' } },
                                bottom: { style: 'thin', color: { rgb: 'E5E7EB' } },
                                left: { style: 'thin', color: { rgb: 'E5E7EB' } },
                                right: { style: 'thin', color: { rgb: 'E5E7EB' } }
                            },
                            font: {
                                name: 'Arial',
                                sz: 11
                            }
                        };
                        
                        // שורת כותרת
                        if (R === 0) {
                            ws[cellAddress].s.fill = {
                                fgColor: { rgb: '3B82F6' }
                            };
                            ws[cellAddress].s.font = {
                                name: 'Arial',
                                sz: 12,
                                bold: true,
                                color: { rgb: 'FFFFFF' }
                            };
                        }
                        // עמודת הימים
                        else if (C === 0) {
                            ws[cellAddress].s.fill = {
                                fgColor: { rgb: 'F3F4F6' }
                            };
                            ws[cellAddress].s.font = {
                                name: 'Arial',
                                sz: 11,
                                bold: true
                            };
                        }
                        // תאי משמרות
                        else {
                            const shiftName = SHIFTS[C - 1];
                            const color = SHIFT_COLORS[shiftName];
                            
                            const hexToRgb = (hex) => {
                                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                                return result ? result[1] + result[2] + result[3] : 'FFFFFF';
                            };
                            
                            ws[cellAddress].s.fill = {
                                fgColor: { rgb: hexToRgb(color.bg) }
                            };
                            ws[cellAddress].s.font = {
                                name: 'Arial',
                                sz: 11,
                                color: { rgb: hexToRgb(color.text) }
                            };
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, ws, 'סידור עבודה');
                
                const date = new Date().toLocaleDateString('he-IL').replace(/\./g, '-');
                const fileName = `סידור_עבודה_${date}.xlsx`;
                
                XLSX.writeFile(wb, fileName);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-xl p-4 md:p-6 mb-6">
                            <div className="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="text-blue-600">
                                        <CalendarIcon />
                                    </div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800">סידור עבודה שבועי</h1>
                                </div>
                                <button
                                    onClick={exportToExcel}
                                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md w-full md:w-auto justify-center"
                                >
                                    <DownloadIcon />
                                    <span>ייצוא לאקסל</span>
                                </button>
                            </div>

                            <div className="bg-blue-50 rounded-lg p-4 mb-6">
                                <div className="flex items-center gap-2 mb-3">
                                    <div className="text-blue-600">
                                        <UsersIcon />
                                    </div>
                                    <h2 className="text-xl font-semibold text-gray-800">ניהול עובדים</h2>
                                </div>
                                <div className="flex flex-col md:flex-row gap-3 mb-4">
                                    <input
                                        type="text"
                                        placeholder="שם עובד"
                                        value={newEmployee.name}
                                        onChange={(e) => setNewEmployee({ ...newEmployee, name: e.target.value })}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <input
                                        type="tel"
                                        placeholder="טלפון"
                                        value={newEmployee.phone}
                                        onChange={(e) => setNewEmployee({ ...newEmployee, phone: e.target.value })}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <button
                                        onClick={addEmployee}
                                        className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        הוסף
                                    </button>
                                </div>
                                <div className="space-y-2">
                                    {employees.map(emp => (
                                        <div key={emp.id} className="flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-3 bg-white p-3 rounded-lg">
                                            {editingEmployee === emp.id ? (
                                                <>
                                                    <input
                                                        type="text"
                                                        value={emp.name}
                                                        onChange={(e) => updateEmployee(emp.id, 'name', e.target.value)}
                                                        className="flex-1 px-3 py-2 border border-gray-300 rounded"
                                                    />
                                                    <input
                                                        type="tel"
                                                        value={emp.phone}
                                                        onChange={(e) => updateEmployee(emp.id, 'phone', e.target.value)}
                                                        className="flex-1 px-3 py-2 border border-gray-300 rounded"
                                                    />
                                                    <button
                                                        onClick={() => setEditingEmployee(null)}
                                                        className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                                                    >
                                                        שמור
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <span className="flex-1 font-medium">{emp.name}</span>
                                                    <span className="flex-1 text-gray-600">{emp.phone}</span>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => setEditingEmployee(emp.id)}
                                                            className="flex-1 md:flex-none bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
                                                        >
                                                            עריכה
                                                        </button>
                                                        <button
                                                            onClick={() => deleteEmployee(emp.id)}
                                                            className="flex-1 md:flex-none bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                                                        >
                                                            מחק
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="overflow-x-auto -mx-4 md:mx-0">
                                <div className="inline-block min-w-full align-middle px-4 md:px-0">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-blue-600 text-white">
                                                <th className="border border-gray-300 p-2 md:p-3 text-center text-sm md:text-base">יום/משמרת</th>
                                                {SHIFTS.map(shift => (
                                                    <th key={shift} className="border border-gray-300 p-2 md:p-3 text-center text-sm md:text-base">{shift}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {DAYS.map((day, dayIndex) => (
                                                <tr key={day}>
                                                    <td className="border border-gray-300 p-2 md:p-3 font-semibold bg-gray-100 text-center text-sm md:text-base whitespace-nowrap">
                                                        {day}
                                                    </td>
                                                    {SHIFTS.map((shift, shiftIndex) => (
                                                        <td
                                                            key={shift}
                                                            className="border border-gray-300 p-1 md:p-2"
                                                            style={{
                                                                backgroundColor: SHIFT_COLORS[shift].bg,
                                                                color: SHIFT_COLORS[shift].text
                                                            }}
                                                        >
                                                            <select
                                                                value={schedule[dayIndex][shiftIndex]}
                                                                onChange={(e) => updateShift(dayIndex, shiftIndex, e.target.value)}
                                                                className="w-full p-1 md:p-2 rounded border-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base"
                                                                style={{
                                                                    backgroundColor: 'transparent',
                                                                    color: SHIFT_COLORS[shift].text
                                                                }}
                                                            >
                                                                <option value="">בחר עובד</option>
                                                                {employees.map(emp => (
                                                                    <option key={emp.id} value={emp.name}>{emp.name}</option>
                                                                ))}
                                                            </select>
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>