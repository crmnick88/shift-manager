<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:20px;
    }
    .container{
      max-width:1100px;
      margin:0 auto;
      background:#fff;
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      padding:28px;
    }
    h1{
      text-align:center;
      color:#667eea;
      margin-bottom:18px;
      font-size:2.3em;
    }
    .section{display:none}
    .section.active{display:block}

    .btn{
      width:100%;
      padding:14px;
      background:#667eea;
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      transition:all .25s;
      margin-top:10px;
    }
    .btn:hover{background:#5568d3;transform:translateY(-2px)}

    .mode-btn{
      padding:18px 34px;
      margin:10px;
      border:2px solid #667eea;
      background:#fff;
      color:#667eea;
      border-radius:12px;
      cursor:pointer;
      font-size:20px;
      font-weight:900;
      transition:all .25s;
    }
    .mode-btn:hover{background:#667eea;color:#fff}

    input,select{
      width:100%;
      padding:12px;
      border:2px solid #e0e0e0;
      border-radius:10px;
      font-size:16px;
      margin-top:8px;
    }
    .form-group{margin-bottom:14px}
    label{display:block;margin-bottom:5px;font-weight:900;color:#555}

    .constraint-item{
      background:#fff;
      padding:15px;
      border-radius:10px;
      margin-bottom:15px;
      border:2px solid #e0e0e0;
    }
    .constraint-card{
      background:#fff3cd;
      padding:14px;
      border-radius:10px;
      margin-bottom:10px;
    }
    .employee-constraints{
      background:#fff;
      padding:14px;
      border-radius:10px;
      margin-bottom:12px;
      border-right:4px solid #667eea;
    }

    .message{
      padding:14px;
      border-radius:10px;
      margin-top:18px;
      text-align:center;
      font-weight:900;
      white-space:pre-line;
    }
    .message.success{background:#d4edda;color:#155724}
    .message.error{background:#f8d7da;color:#721c24}

    .approval-buttons{
      display:inline-flex;
      gap:10px;
      margin-right:10px;
      margin-top:8px;
    }
    .approve-btn,.reject-btn{
      padding:8px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:900;
    }
    .approve-btn{background:#28a745;color:#fff}
    .reject-btn{background:#dc3545;color:#fff}

    .status-pending,.status-approved,.status-rejected{
      padding:5px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
      margin-right:8px;
      display:inline-block;
    }
    .status-pending{background:#fff3cd;color:#856404}
    .status-approved{background:#d4edda;color:#155724}
    .status-rejected{background:#f8d7da;color:#721c24}

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .toolbar .btn{
      width:auto;
      padding:12px 18px;
      font-size:16px;
      margin-top:0;
    }

    /* SCHEDULE */
    .schedule-wrapper{
      overflow-x:auto;
      margin-top:12px;
      border-radius:12px;
    }
    .schedule-table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      min-width:980px; /* ××—×–×™×¨ ××ª â€œ×”×”×¨×’×©×”â€ ×©×”×™×™×ª×” ×§×•×“× */
    }
    .schedule-table th{
      background:#667eea;
      color:#fff;
      padding:14px 10px;
      text-align:center;
      font-size:14px;
      min-width:110px;
      border:1px solid rgba(255,255,255,0.15);
    }
    .schedule-table td{
      padding:14px 10px;
      text-align:center;
      border:1px solid #e0e0e0;
      vertical-align:middle;
      min-width:110px;
    }
    .dept-divider td{
      background:#5b6fe0;
      color:#fff;
      font-weight:900;
      text-align:center;
      padding:10px !important;
      font-size:14px;
      border-color:#5b6fe0;
    }

    .shift-morning,.shift-middle,.shift-evening,.shift-friday,.shift-saturday{
      display:inline-block;
      padding:8px 12px;
      border-radius:8px;
      font-size:13px;
      font-weight:900;
      line-height:1.6;
    }
    .shift-morning{background:#fff3cd}
    .shift-middle{background:#ffd4a3}
    .shift-evening{background:#d1ecf1}
    .shift-friday{background:#d4edda}
    .shift-saturday{background:#e7d4f5}
  </style>
</head>

<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login-screen" class="section active">
      <h1>ğŸ—“ï¸ ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h1>
      <div style="text-align:center; margin-top:30px;">
        <button class="mode-btn" onclick="showLoginForm('employee')">ğŸ‘¤ ×›× ×™×¡×ª ×¢×•×‘×“</button>
        <button class="mode-btn" onclick="showLoginForm('manager')">ğŸ‘” ×›× ×™×¡×ª ×× ×”×œ</button>
      </div>
    </div>

    <!-- Employee Login -->
    <div id="employee-login" class="section">
      <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×¢×•×‘×“</h1>
      <div style="max-width:420px; margin:30px auto;">
        <div class="form-group">
          <label>×©× ××©×ª××©:</label>
          <input type="text" id="emp-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
        </div>
        <div class="form-group">
          <label>×¡×™×¡××”:</label>
          <input type="password" id="emp-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
        </div>
        <button class="btn" onclick="loginEmployee()">×”×ª×—×‘×¨</button>
        <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
      </div>
    </div>

    <!-- Manager Login -->
    <div id="manager-login" class="section">
      <h1>ğŸ—“ï¸ ×›× ×™×¡×ª ×× ×”×œ</h1>
      <div style="max-width:420px; margin:30px auto;">
        <div class="form-group">
          <label>×©× ××©×ª××©:</label>
          <input type="text" id="mgr-username" placeholder="×”×–×Ÿ ×©× ××©×ª××©">
        </div>
        <div class="form-group">
          <label>×¡×™×¡××”:</label>
          <input type="password" id="mgr-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
        </div>
        <button class="btn" onclick="loginManager()">×”×ª×—×‘×¨</button>
        <button class="btn" onclick="backToLogin()" style="background:#6c757d;">×—×–×•×¨</button>
      </div>
    </div>

    <!-- Employee Section -->
    <div id="employee-section" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h1 style="margin:0;">ğŸ—“ï¸ ××©××¨×•×ª</h1>
        <button class="btn" onclick="logout()" style="width:auto; padding:10px 18px; background:#dc3545;">×”×ª× ×ª×§</button>
      </div>

      <h2 id="employee-welcome" style="color:#667eea; text-align:center; margin-bottom:20px;"></h2>

      <div style="background:#f8f9fa; padding:20px; border-radius:12px;">
        <h3 style="margin-bottom:6px;">×”×’×“×¨×ª ××™×œ×•×¦×™× (×¢×“ 2)</h3>
        <p style="color:#e74c3c; margin:10px 0;">âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª</p>

        <div class="constraint-item">
          <h4 style="margin-bottom:10px;">××™×œ×•×¥ 1</h4>
          <div class="form-group">
            <label>×ª××¨×™×š:</label>
            <input type="date" id="c1-date">
          </div>
          <div class="form-group">
            <label>×¡×•×’:</label>
            <select id="c1-type">
              <option value="">-- ×‘×—×¨ --</option>
              <option value="no-morning">×œ× ×‘×•×§×¨</option>
              <option value="no-evening">×œ× ×¢×¨×‘</option>
              <option value="day-off">×—×•×¤×© ××œ×</option>
            </select>
          </div>
        </div>

        <div class="constraint-item">
          <h4 style="margin-bottom:10px;">××™×œ×•×¥ 2</h4>
          <div class="form-group">
            <label>×ª××¨×™×š:</label>
            <input type="date" id="c2-date">
          </div>
          <div class="form-group">
            <label>×¡×•×’:</label>
            <select id="c2-type">
              <option value="">-- ×‘×—×¨ --</option>
              <option value="no-morning">×œ× ×‘×•×§×¨</option>
              <option value="no-evening">×œ× ×¢×¨×‘</option>
              <option value="day-off">×—×•×¤×© ××œ×</option>
            </select>
          </div>
        </div>

        <button class="btn" onclick="saveConstraints()">×©××•×¨ ××™×œ×•×¦×™×</button>
      </div>

      <div id="my-constraints" style="margin-top:18px;"></div>
    </div>

    <!-- Manager Section -->
    <div id="manager-section" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h1 style="margin:0;">ğŸ—“ï¸ ×¤×× ×œ ×× ×”×œ</h1>
        <button class="btn" onclick="logout()" style="width:auto; padding:10px 18px; background:#dc3545;">×”×ª× ×ª×§</button>
      </div>

      <div id="all-constraints"></div>

      <div class="toolbar">
        <button class="btn" onclick="generateSchedule()">ğŸ¯ ×¦×•×¨ ×¡×™×“×•×¨ ××•×˜×•××˜×™</button>
        <button class="btn" onclick="exportToExcel()" style="background:#28a745;">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
      </div>

      <div id="schedule-result"></div>
    </div>

    <div id="message"></div>
  </div>

  <script>
    // ===============================
    // Firebase Config
    // ===============================
    const firebaseConfig = {
      apiKey: "AIzaSyD-uaQ2aO87kGxbcc-m8_9fzJ3uhPv2zvk",
      authDomain: "shift-manager-c026e.firebaseapp.com",
      databaseURL: "https://shift-manager-c026e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "shift-manager-c026e",
      storageBucket: "shift-manager-c026e.firebasestorage.app",
      messagingSenderId: "1091605398341",
      appId: "1:1091605398341:web:cb6c14e7d832c3e8df342c"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentEmployee = '';
    let currentSchedule = null;

    // ===============================
    // Users / Depts
    // ===============================
    const USERS = {
      'ILAY': 'ILAY',
      'ROVEN': 'ROVEN',
      'HAI': 'HAI',
      'NATALI': 'NATALI',
      'INNA': 'INNA',
      'TAMIR': 'TAMIR',
      'ELIYA': 'ELIYA',
      'LIOR': 'LIOR',
      'AMANI': 'AMANI',
      'SHIROT': 'SHIROT',
      'AVI': 'AVI',
      'MOHAMAD': 'MOHAMAD'
    };

    const DEPARTMENTS = {
      '××—×œ×§×ª ××™×—×©×•×‘': ['ILAY', 'ROVEN'],
      '××—×œ×§×ª ×§×˜× ×™×': ['HAI', 'NATALI'],
      '××—×œ×§×ª ××—×¡× ××™×': ['AVI', 'MOHAMAD'],
      '××—×œ×§×ª ×§×• ×œ×‘×Ÿ': ['INNA', 'TAMIR', 'ELIYA'],
      '× ×¦×™×’×•×ª ×©×™×¨×•×ª': ['LIOR', 'AMANI', 'SHIROT']
    };

    const MANAGER = { username: 'SAGI', password: '102' };

    // ===============================
    // Navigation / Login
    // ===============================
    function hideAll(){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('message').innerHTML = '';
    }

    function showLoginForm(type){
      hideAll();
      document.getElementById(type + '-login').classList.add('active');
    }

    function backToLogin(){
      hideAll();
      document.getElementById('login-screen').classList.add('active');
      clearInputs();
    }

    function clearInputs(){
      const ids = ['emp-username','emp-password','mgr-username','mgr-password'];
      ids.forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
    }

    function logout(){
      currentEmployee = '';
      backToLogin();
      showMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”', 'success');
    }

    function loginEmployee(){
      const username = document.getElementById('emp-username').value.trim().toUpperCase();
      const password = document.getElementById('emp-password').value.trim();

      if(!username || !password){
        showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error'); return;
      }

      if(USERS[username] && USERS[username] === password){
        currentEmployee = username;
        hideAll();
        document.getElementById('employee-section').classList.add('active');
        document.getElementById('employee-welcome').textContent = `×©×œ×•× ${username}! ğŸ‘‹`;
        loadEmployeeConstraints();
        showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
      } else {
        showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
      }
    }

    function loginManager(){
      const username = document.getElementById('mgr-username').value.trim().toUpperCase();
      const password = document.getElementById('mgr-password').value.trim();

      if(!username || !password){
        showMessage('×× × ×”×–×Ÿ ×©× ××©×ª××© ×•×¡×™×¡××”', 'error'); return;
      }

      if(username === MANAGER.username && password === MANAGER.password){
        hideAll();
        document.getElementById('manager-section').classList.add('active');
        loadAllConstraints();
        showMessage('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”', 'success');
      } else {
        showMessage('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
      }
    }

    // ===============================
    // Constraints - Employee
    // ===============================
    async function loadEmployeeConstraints(){
      if(!currentEmployee) return;

      const snapshot = await db.ref('constraints/' + currentEmployee).once('value');
      const data = snapshot.val();

      // clear
      document.getElementById('c1-date').value = '';
      document.getElementById('c1-type').value = '';
      document.getElementById('c2-date').value = '';
      document.getElementById('c2-type').value = '';

      if(data){
        if(data.c1){
          document.getElementById('c1-date').value = data.c1.date || '';
          document.getElementById('c1-type').value = data.c1.type || '';
        }
        if(data.c2){
          document.getElementById('c2-date').value = data.c2.date || '';
          document.getElementById('c2-type').value = data.c2.type || '';
        }
        displayMyConstraints(data);
      } else {
        displayMyConstraints({});
      }
    }

    async function saveConstraints(){
      if(!currentEmployee) return;

      const c1Date = document.getElementById('c1-date').value;
      const c1Type = document.getElementById('c1-type').value;
      const c2Date = document.getElementById('c2-date').value;
      const c2Type = document.getElementById('c2-type').value;

      if(c1Date && !isValidWeekday(c1Date)){
        showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error'); return;
      }
      if(c2Date && !isValidWeekday(c2Date)){
        showMessage('âŒ ×œ× × ×™×ª×Ÿ ×œ×‘×—×•×¨ ×©×™×©×™ ××• ×©×‘×ª', 'error'); return;
      }

      const constraints = {};

      if(c1Date && c1Type){
        constraints.c1 = {
          date: c1Date,
          type: c1Type,
          status: (c1Type === 'day-off') ? 'pending' : 'approved'
        };
      }
      if(c2Date && c2Type){
        constraints.c2 = {
          date: c2Date,
          type: c2Type,
          status: (c2Type === 'day-off') ? 'pending' : 'approved'
        };
      }

      await db.ref('constraints/' + currentEmployee).set(constraints);

      const hasDayOff = (c1Type === 'day-off') || (c2Type === 'day-off');
      showMessage(hasDayOff ? '× ×©××¨! ×‘×§×©×•×ª ×—×•×¤×© ×××ª×™× ×•×ª ×œ××™×©×•×¨' : '× ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
      displayMyConstraints(constraints);
    }

    function displayMyConstraints(data){
      const today = new Date();
      today.setHours(0,0,0,0);

      let html = '<h3 style="color:#667eea;">×”××™×œ×•×¦×™× ×©×œ×™:</h3>';
      let hasValid = false;

      if(data.c1 && data.c1.date && new Date(data.c1.date + 'T00:00:00') >= today){
        html += `<div class="constraint-card">
          <strong>××™×œ×•×¥ 1:</strong> ${formatDate(data.c1.date)} - ${formatType(data.c1.type)}
          ${getStatusBadge(data.c1)}
        </div>`;
        hasValid = true;
      }
      if(data.c2 && data.c2.date && new Date(data.c2.date + 'T00:00:00') >= today){
        html += `<div class="constraint-card">
          <strong>××™×œ×•×¥ 2:</strong> ${formatDate(data.c2.date)} - ${formatType(data.c2.type)}
          ${getStatusBadge(data.c2)}
        </div>`;
        hasValid = true;
      }

      if(!hasValid){
        html += '<p style="color:#28a745; font-weight:900;">××™×Ÿ ××™×œ×•×¦×™× ×¢×ª×™×“×™×™×</p>';
      }

      document.getElementById('my-constraints').innerHTML = html;
    }

    // ===============================
    // Constraints - Manager
    // ===============================
    async function loadAllConstraints(){
      const snapshot = await db.ref('constraints').once('value');
      const allData = snapshot.val() || {};

      const today = new Date();
      today.setHours(0,0,0,0);

      let html = '<h2 style="margin:10px 0;">××™×œ×•×¦×™ ×”×¢×•×‘×“×™×</h2>';

      for(const [dept, employees] of Object.entries(DEPARTMENTS)){
        html += `<div style="background:#f0f0f0; padding:15px; border-radius:12px; margin-bottom:18px;">
          <h3 style="color:#667eea; margin-bottom:10px;">ğŸ¢ ${dept}</h3>`;

        employees.forEach(emp => {
          const data = allData[emp];
          html += `<div class="employee-constraints"><h4 style="margin-bottom:8px;">${emp}</h4>`;

          let hasValid = false;

          if(data?.c1 && data.c1.date && new Date(data.c1.date + 'T00:00:00') >= today){
            html += formatConstraintForManager(emp,'c1',data.c1);
            hasValid = true;
          }
          if(data?.c2 && data.c2.date && new Date(data.c2.date + 'T00:00:00') >= today){
            html += formatConstraintForManager(emp,'c2',data.c2);
            hasValid = true;
          }

          if(!hasValid){
            html += '<p style="color:#28a745; font-weight:900;">âœ… ××™×Ÿ ××™×œ×•×¦×™×</p>';
          }

          html += '</div>';
        });

        html += '</div>';
      }

      document.getElementById('all-constraints').innerHTML = html;
    }

    function formatConstraintForManager(emp, key, c){
      let html = `<div style="margin:8px 0; padding:10px; background:#f8f9fa; border-radius:10px;">
        ğŸ“Œ ${formatDate(c.date)} - ${formatType(c.type)} `;

      if(c.type === 'day-off'){
        const status = c.status || 'pending';
        if(status === 'pending'){
          html += `<div class="approval-buttons">
            <button class="approve-btn" onclick="updateApproval('${emp}','${key}','approved')">âœ… ××©×¨</button>
            <button class="reject-btn" onclick="updateApproval('${emp}','${key}','rejected')">âŒ ×“×—×”</button>
          </div>`;
          html += `<span class="status-pending">â³ ×××ª×™×Ÿ</span>`;
        } else if(status === 'approved'){
          html += `<span class="status-approved">âœ… ×××•×©×¨</span>`;
        } else {
          html += `<span class="status-rejected">âŒ × ×“×—×”</span>`;
        }
      } else {
        html += `<span class="status-approved">âœ… ×¤×¢×™×œ</span>`;
      }

      return html + '</div>';
    }

    async function updateApproval(emp, key, status){
      if(status === 'rejected'){
        await db.ref(`constraints/${emp}/${key}`).set(null);
        showMessage('×‘×§×©×ª ×”×—×•×¤×© × ×“×—×ª×” ×•× ××—×§×”', 'success');
      } else {
        await db.ref(`constraints/${emp}/${key}/status`).set('approved');
        showMessage('×‘×§×©×ª ×”×—×•×¤×© ××•×©×¨×”!', 'success');
      }
      await loadAllConstraints();
    }

    // ===============================
    // Schedule
    // ===============================
    async function generateSchedule(){
      try{
        const snapshot = await db.ref('constraints').once('value');
        const constraints = snapshot.val() || {};

        const conflicts = checkConflicts(constraints);
        if(conflicts.length){
          let msg = 'âš ï¸ ×§×•× ×¤×œ×™×§×˜×™×:\n\n';
          conflicts.forEach(c => {
            msg += `ğŸ¢ ${c.dept}\nğŸ“… ${formatDate(c.date)}: ${c.emps.join(' ×•-')} - ${c.desc}\n\n`;
          });
          showMessage(msg,'error');
          document.getElementById('schedule-result').innerHTML = `<div class="message error">${msg}</div>`;
          currentSchedule = null;
          return;
        }

        const schedule = createSchedule(constraints);
        currentSchedule = schedule;
        displaySchedule(schedule);
        showMessage('×”×¡×™×“×•×¨ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');

      } catch(err){
        console.error(err);
        showMessage('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¡×™×“×•×¨: ' + err.message, 'error');
      }
    }

    function checkConflicts(constraints){
      const conflicts = [];
      const today = new Date(); today.setHours(0,0,0,0);

      for(const [dept, emps] of Object.entries(DEPARTMENTS)){
        const all = [];

        emps.forEach(emp => {
          const data = constraints[emp];
          if(!data) return;

          const pushIf = (c) => {
            if(!c || !c.date) return;
            const d = new Date(c.date + 'T00:00:00');
            if(d < today) return;

            // day-off affects schedule ONLY if approved
            if(c.type === 'day-off' && (c.status || 'pending') !== 'approved') return;

            // no-morning/no-evening always active
            all.push({ emp, date: c.date, type: c.type });
          };

          pushIf(data.c1);
          pushIf(data.c2);
        });

        const byDate = {};
        all.forEach(c => {
          if(!byDate[c.date]) byDate[c.date] = [];
          byDate[c.date].push(c);
        });

        Object.entries(byDate).forEach(([date, arr]) => {
          const dayOffCount = arr.filter(x => x.type === 'day-off').length;
          const noMorningCount = arr.filter(x => x.type === 'no-morning' || x.type === 'day-off').length;
          const noEveningCount = arr.filter(x => x.type === 'no-evening' || x.type === 'day-off').length;

          if(emps.length === 3){
            if(dayOffCount >= 2){
              conflicts.push({
                dept,
                date,
                emps: arr.filter(x => x.type === 'day-off').map(x => x.emp),
                desc: '×™×•×ª×¨ ××¢×•×‘×“ ××—×“ ×‘×™×§×© ×—×•×¤×©'
              });
            }
          } else {
            if(dayOffCount === 2){
              conflicts.push({ dept, date, emps: arr.map(x => x.emp), desc: '×©× ×™×”× ×‘×™×§×©×• ×—×•×¤×©' });
            } else if(noMorningCount === 2){
              conflicts.push({ dept, date, emps: arr.map(x => x.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×‘×•×§×¨' });
            } else if(noEveningCount === 2){
              conflicts.push({ dept, date, emps: arr.map(x => x.emp), desc: '×©× ×™×”× ×œ× ×™×›×•×œ×™× ×¢×¨×‘' });
            }
          }
        });
      }

      return conflicts;
    }

    function createSchedule(constraints){
      const today = new Date(); today.setHours(0,0,0,0);

      // next Sunday (or today if Sunday)
      const nextSunday = new Date(today);
      const dow = nextSunday.getDay(); // 0=Sun
      nextSunday.setDate(nextSunday.getDate() + (dow === 0 ? 0 : 7 - dow));

      const daysHeb = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];

      const hasConstraint = (emp, dateStr, kind) => {
        const data = constraints[emp];
        if(!data) return false;

        const active = (c) => {
          if(!c || !c.date || c.date !== dateStr) return false;

          if(c.type === 'day-off'){
            return (c.status || 'pending') === 'approved';
          }
          if(kind === 'morning') return c.type === 'no-morning';
          if(kind === 'evening') return c.type === 'no-evening';
          if(kind === 'full') return c.type === 'day-off';
          return false;
        };

        return active(data.c1) || active(data.c2);
      };

      const allSchedules = {};

      for(const [dept, emps] of Object.entries(DEPARTMENTS)){
        const schedule = [];
        const isThree = emps.length === 3;
        const isKavLavan = dept === '××—×œ×§×ª ×§×• ×œ×‘×Ÿ';

        // Sunday-Thursday
        for(let i=0;i<5;i++){
          const date = new Date(nextSunday);
          date.setDate(nextSunday.getDate()+i);
          const dateStr = toLocalISO(date);

          if(isThree){
            const dayOffs = emps.filter(emp => hasConstraint(emp, dateStr, 'full'));

            if(dayOffs.length === 1){
              const working = emps.filter(e => !dayOffs.includes(e));
              schedule.push({
                day: daysHeb[i],
                date: dateStr,
                morning: working[0],
                evening: working[1],
                middleCancelled: true,
                covering: dayOffs[0],
                isKavLavan
              });
            } else {
              const rot = i % 3;
              schedule.push({
                day: daysHeb[i],
                date: dateStr,
                morning: emps[rot],
                middle: emps[(rot+1)%3],
                evening: emps[(rot+2)%3],
                isKavLavan
              });
            }
          } else {
            const e1Off = hasConstraint(emps[0], dateStr, 'full');
            const e2Off = hasConstraint(emps[1], dateStr, 'full');

            if(e1Off){
              schedule.push({ day: daysHeb[i], date: dateStr, morning: emps[1], evening: emps[1], covering: emps[0], isKavLavan:false });
            } else if(e2Off){
              schedule.push({ day: daysHeb[i], date: dateStr, morning: emps[0], evening: emps[0], covering: emps[1], isKavLavan:false });
            } else {
              const morningEmp = (i%2===0) ? emps[0] : emps[1];
              const eveningEmp = (i%2===0) ? emps[1] : emps[0];

              const mCant = hasConstraint(morningEmp, dateStr, 'morning');
              const eCant = hasConstraint(eveningEmp, dateStr, 'evening');

              const finalMorning = mCant ? eveningEmp : morningEmp;
              const finalEvening = eCant ? morningEmp : eveningEmp;

              schedule.push({ day: daysHeb[i], date: dateStr, morning: finalMorning, evening: finalEvening, isKavLavan:false });
            }
          }
        }

        // Friday
        const fri = new Date(nextSunday);
        fri.setDate(nextSunday.getDate()+5);
        const friStr = toLocalISO(fri);

        if(isThree){
          const off = emps.find(e => hasConstraint(e, friStr, 'full'));
          const working = off ? emps.filter(e => e !== off) : [emps[0], emps[1]];
          schedule.push({ day:'×©×™×©×™', date: friStr, friday: working, isKavLavan });
        } else {
          const work = hasConstraint(emps[0], friStr, 'full') ? emps[1] : emps[0];
          schedule.push({ day:'×©×™×©×™', date: friStr, friday: work, isKavLavan:false });
        }

        // Saturday
        const sat = new Date(nextSunday);
        sat.setDate(nextSunday.getDate()+6);
        const satStr = toLocalISO(sat);

        if(isThree){
          const friWorking = schedule[schedule.length-1].friday; // array
          const satWorking = emps.find(e => !friWorking.includes(e)) || emps[2];
          schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satWorking, isKavLavan });
        } else {
          const friEmp = schedule[schedule.length-1].friday;
          const satEmp = (friEmp === emps[0]) ? emps[1] : emps[0];
          schedule.push({ day:'××•×¦"×©', date: satStr, saturday: satEmp, isKavLavan:false });
        }

        allSchedules[dept] = schedule;
      }

      return allSchedules;
    }

    // ===============================
    // Display schedule: one table + dept divider
    // ===============================
    function displaySchedule(allSchedules){
      const depts = Object.keys(allSchedules);
      const firstDept = depts[0];
      const days = allSchedules[firstDept] || [];

      let html = `<h2 style="color:#667eea; margin-top:18px;">ğŸ“… ×¡×™×“×•×¨ ×©×‘×•×¢×™ - ×›×œ ×”×¡× ×™×£</h2>`;
      html += `<div class="schedule-wrapper"><table class="schedule-table"><tr>`;

      days.forEach(d => {
        html += `<th>${d.day}<br>${formatDate(d.date)}</th>`;
      });

      html += `<th>××—×œ×§×”</th><th>×¢×•×‘×“</th>`;
      html += `</tr>`;

      for(const [dept, schedule] of Object.entries(allSchedules)){
        html += `<tr class="dept-divider"><td colspan="${days.length + 2}">ğŸ¢ ${dept}</td></tr>`;

        const employees = DEPARTMENTS[dept];

        employees.forEach(emp => {
          html += `<tr>`;

          schedule.forEach(day => {
            if(day.friday){
              if(Array.isArray(day.friday)){
                if(day.friday.includes(emp)){
                  html += `<td><span class="shift-friday">${day.isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™<br>8:30-14:30'}</span></td>`;
                } else {
                  html += `<td style="background:#f0f0f0;">-</td>`;
                }
              } else {
                if(day.friday === emp){
                  html += `<td><span class="shift-friday">×‘×•×§×¨<br>8:30-14:30</span></td>`;
                } else {
                  html += `<td style="background:#f0f0f0;">-</td>`;
                }
              }
              return;
            }

            if(day.saturday){
              if(day.saturday === emp){
                html += `<td><span class="shift-saturday">${day.isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×©<br>××•×¦"×©-22:30'}</span></td>`;
              } else {
                html += `<td style="background:#f0f0f0;">-</td>`;
              }
              return;
            }

            const shifts = [];
            if(day.morning === emp){
              shifts.push(day.isKavLavan
                ? `<span class="shift-morning">×‘×•×§×¨</span>`
                : `<span class="shift-morning">×‘×•×§×¨<br>9:00-16:00</span>`);
            }
            if(day.middle === emp){
              shifts.push(day.isKavLavan
                ? `<span class="shift-middle">×××¦×¢</span>`
                : `<span class="shift-middle">×××¦×¢<br>11:00-19:00</span>`);
            }
            if(day.evening === emp){
              shifts.push(day.isKavLavan
                ? `<span class="shift-evening">×¢×¨×‘</span>`
                : `<span class="shift-evening">×¢×¨×‘<br>15:00-21:30</span>`);
            }

            if(!shifts.length){
              html += `<td style="background:#f0f0f0;">-</td>`;
            } else {
              html += `<td>${shifts.join('<br>')}</td>`;
            }
          });

          html += `<td style="font-weight:900;">${dept}</td>`;
          html += `<td style="background:#667eea; color:#fff; font-weight:900;">${emp}</td>`;
          html += `</tr>`;
        });
      }

      html += `</table></div>`;
      document.getElementById('schedule-result').innerHTML = html;
    }

    // ===============================
    // Export Excel (single sheet)
    // ===============================
    function exportToExcel(){
      if(!currentSchedule){
        showMessage('××™×Ÿ ×¡×™×“×•×¨ ×œ×™×™×¦×•×. ×¦×•×¨ ×¡×™×“×•×¨ ×§×•×“×.', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();

      const depts = Object.keys(currentSchedule);
      const days = currentSchedule[depts[0]] || [];

      const data = [];
      data.push(['×¡×™×“×•×¨ ×©×‘×•×¢×™ - ×›×œ ×”×¡× ×™×£']);

      const header = days.map(d => `${d.day} ${formatDate(d.date)}`);
      header.push('××—×œ×§×”','×¢×•×‘×“');
      data.push(header);

      for(const [dept, schedule] of Object.entries(currentSchedule)){
        // divider row
        data.push([`== ${dept} ==`, ...Array(days.length-1).fill(''), '', '']);

        const employees = DEPARTMENTS[dept];

        employees.forEach(emp => {
          const row = [];

          schedule.forEach(day => {
            if(day.friday){
              if(Array.isArray(day.friday)){
                row.push(day.friday.includes(emp) ? (day.isKavLavan ? '×¢×•×‘×“ ×‘×©×™×©×™' : '×©×™×©×™ 8:30-14:30') : '-');
              } else {
                row.push(day.friday === emp ? '×‘×•×§×¨ 8:30-14:30' : '-');
              }
              return;
            }

            if(day.saturday){
              row.push(day.saturday === emp ? (day.isKavLavan ? '×¢×•×‘×“ ×‘××•×¦"×©' : '××•×¦"×© ××•×¦"×©-22:30') : '-');
              return;
            }

            const shifts = [];
            if(day.morning === emp) shifts.push(day.isKavLavan ? '×‘×•×§×¨' : '×‘×•×§×¨ 9:00-16:00');
            if(day.middle === emp) shifts.push(day.isKavLavan ? '×××¦×¢' : '×××¦×¢ 11:00-19:00');
            if(day.evening === emp) shifts.push(day.isKavLavan ? '×¢×¨×‘' : '×¢×¨×‘ 15:00-21:30');

            row.push(shifts.length ? shifts.join(', ') : '-');
          });

          row.push(dept);
          row.push(emp);
          data.push(row);
        });
      }

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = Array(days.length).fill({ wch: 18 }).concat([{ wch: 20 }, { wch: 12 }]);

      XLSX.utils.book_append_sheet(wb, ws, '×¡×™×“×•×¨ ×¡× ×™×£');

      const now = new Date();
      XLSX.writeFile(wb, `×¡×™×“×•×¨_${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}.xlsx`);

      showMessage('×”×§×•×‘×¥ ×™×•×¦×!', 'success');
    }

    // ===============================
    // Helpers
    // ===============================
    function showMessage(text, type){
      const div = document.getElementById('message');
      div.className = `message ${type}`;
      div.textContent = text;
      setTimeout(() => { div.innerHTML=''; div.className=''; }, 6000);
    }

    function formatDate(dateStr){
      const d = new Date(dateStr + 'T00:00:00');
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${dd}/${mm}`;
    }

    function formatType(type){
      const types = {'no-morning':'âŒ ×œ× ×‘×•×§×¨','no-evening':'âŒ ×œ× ×¢×¨×‘','day-off':'ğŸ–ï¸ ×—×•×¤×© ××œ×'};
      return types[type] || type;
    }

    function isValidWeekday(dateStr){
      const d = new Date(dateStr + 'T00:00:00');
      const day = d.getDay(); // 5 Fri, 6 Sat
      return day !== 5 && day !== 6;
    }

    function getStatusBadge(c){
      if(c.type !== 'day-off') return '';
      const status = c.status || 'pending';
      const statuses = {pending:'â³ ×××ª×™×Ÿ', approved:'âœ… ×××•×©×¨', rejected:'âŒ × ×“×—×”'};
      const classes  = {pending:'status-pending', approved:'status-approved', rejected:'status-rejected'};
      return `<span class="${classes[status]}">${statuses[status]}</span>`;
    }

    function toLocalISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
  </script>
</body>
</html>